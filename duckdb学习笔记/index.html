<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>DuckDB学习笔记 - 我的全新 Hugo 网站</title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="DuckDB学习笔记" />
<meta property="og:description" content="概述 貌似duckdb能自动识别文件的encoding。
实现emeditor的列拆分功能 关键函数 regexp_matches，查询字符串是否包含正则表达式字符 regexp_split_to_array，按给定的正则表达式字符进行拆分 unnest，将数组转为行 contains，判断是否包含特定字符（不支持正则表达式） 数据样本 phone introduce name 111 New York|Chicago Jean Vasquez 222 HK;Tokoy|USA Nakayama Yuito 333 Chinese Shanghai Jean Vasquez 以单个分隔符拆分 duckdb代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 --对包含;的列进行拆分，然后转为行。注意：UNION ALL 前后的列顺序必须一致 SELECT --与 UNION ALL 关键字 后面的列顺序必须一致 phone, UNNEST(regexp_split_to_array(introduce,	&#39;;&#39;)) introduce, name FROM read_csv(&#39;testfile.csv&#39;, delim=&#39;,&#39;, header=True, columns={&#39;phone&#39;:&#39;BIGINT&#39;,&#39;introduce&#39;:&#39;VARCHAR&#39;,&#39;name&#39;:&#39;VARCHAR&#39;}) WHERE contains(introduce,	&#39;;&#39;) UNION ALL -- 与不包含;的行进行合并，实际中要去掉 SELECT --与 UNION ALL 关键字 前面的列顺序必须一致 * FROM read_csv(&#39;testfile." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-05-29T10:55:39+00:00" />
<meta property="article:modified_time" content="2023-05-29T10:55:39+00:00" /><meta property="og:site_name" content="我的网站" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="DuckDB学习笔记"/>
<meta name="twitter:description" content="概述 貌似duckdb能自动识别文件的encoding。
实现emeditor的列拆分功能 关键函数 regexp_matches，查询字符串是否包含正则表达式字符 regexp_split_to_array，按给定的正则表达式字符进行拆分 unnest，将数组转为行 contains，判断是否包含特定字符（不支持正则表达式） 数据样本 phone introduce name 111 New York|Chicago Jean Vasquez 222 HK;Tokoy|USA Nakayama Yuito 333 Chinese Shanghai Jean Vasquez 以单个分隔符拆分 duckdb代码 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 --对包含;的列进行拆分，然后转为行。注意：UNION ALL 前后的列顺序必须一致 SELECT --与 UNION ALL 关键字 后面的列顺序必须一致 phone, UNNEST(regexp_split_to_array(introduce,	&#39;;&#39;)) introduce, name FROM read_csv(&#39;testfile.csv&#39;, delim=&#39;,&#39;, header=True, columns={&#39;phone&#39;:&#39;BIGINT&#39;,&#39;introduce&#39;:&#39;VARCHAR&#39;,&#39;name&#39;:&#39;VARCHAR&#39;}) WHERE contains(introduce,	&#39;;&#39;) UNION ALL -- 与不包含;的行进行合并，实际中要去掉 SELECT --与 UNION ALL 关键字 前面的列顺序必须一致 * FROM read_csv(&#39;testfile."/>
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" /><link rel="prev" href="http://example.org/naiveproxy%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" /><link rel="next" href="http://example.org/%E5%85%B3%E8%81%94%E5%88%86%E6%9E%90/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "DuckDB学习笔记",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/"
        },"genre": "posts","keywords": "DuckDB, 数据库","wordcount":  3687 ,
        "url": "http:\/\/example.org\/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0\/","datePublished": "2023-05-29T10:55:39+00:00","dateModified": "2023-05-29T10:55:39+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "五彩斑斓的黑"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="我的全新 Hugo 网站"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="我的全新 Hugo 网站"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">DuckDB学习笔记</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>五彩斑斓的黑</a></span>&nbsp;<span class="post-category">included in <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>数据库</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2023-05-29">2023-05-29</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3687 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;18 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#概述">概述</a></li>
    <li><a href="#实现emeditor的列拆分功能">实现<code>emeditor</code>的列拆分功能</a>
      <ul>
        <li><a href="#关键函数">关键函数</a></li>
        <li><a href="#数据样本">数据样本</a></li>
        <li><a href="#以单个分隔符拆分">以单个分隔符拆分</a>
          <ul>
            <li><a href="#duckdb代码"><code>duckdb</code>代码</a></li>
            <li><a href="#结果">结果</a></li>
          </ul>
        </li>
        <li><a href="#以多个分隔符进行拆分">以多个分隔符进行拆分</a>
          <ul>
            <li><a href="#duckdb代码-1"><code>duckdb</code>代码</a></li>
            <li><a href="#结果-1">结果</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#基于csv文件的分析结果写入到csv文件">基于csv文件的分析结果写入到csv文件</a></li>
    <li><a href="#将csv文件导入到duckdb数据库">将<code>csv</code>文件导入到<code>duckdb</code>数据库</a></li>
    <li><a href="#递归查询">递归查询</a></li>
    <li><a href="#实现低内存占用的csv文件按指定列去重">实现低内存占用的<code>CSV</code>文件按指定列去重</a>
      <ul>
        <li><a href="#只保留要去重的列">只保留要去重的列</a></li>
        <li><a href="#保留所有字段">保留所有字段</a></li>
        <li><a href="#保留最早和日晚日期时间">保留<code>最早</code>和<code>日晚``日期时间</code></a></li>
      </ul>
    </li>
    <li><a href="#获取特定表的所有列名">获取特定表的所有列名</a>
      <ul>
        <li><a href="#结果保存为数组">结果保存为数组</a></li>
        <li><a href="#保存为字典结构体">保存为字典（结构体）</a></li>
        <li><a href="#其他与列相关基础信息的查询">其他与列相关<code>基础信息</code>的查询</a></li>
        <li><a href="#获取当前duckdb文件所有数据库名">获取<code>当前DuckDB文件</code>所有<code>数据库</code>名</a></li>
        <li><a href="#获取某数据库下所有的数据表名">获取<code>某数据库</code>下所有的数据表名</a>
          <ul>
            <li><a href="#第一种方式">第一种方式</a></li>
            <li><a href="#第二种方式推荐">第二种方式【推荐】</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#限制使用内存大小和并发数">限制使用内存大小和并发数</a></li>
    <li><a href="#关于删除大表不会改变数据库文件的大小疑问">关于<code>删除大表不会改变数据库文件的大小</code>疑问</a></li>
    <li><a href="#duckdb设置参数描述翻译">DuckDB<code>设置</code>参数描述翻译</a></li>
    <li><a href="#查看当前版本所有可用扩展">查看当前版本所有可用扩展</a>
      <ul>
        <li><a href="#扩展的安装与加载">扩展的安装与加载</a></li>
      </ul>
    </li>
    <li><a href="#内存与临时文件">内存与临时文件</a></li>
    <li><a href="#进行连接查询时内存消耗殆尽">进行连接查询时，内存消耗殆尽</a></li>
    <li><a href="#duckdb-vs-clickhouse-vs-databend">DuckDB VS ClickHouse VS DataBend</a></li>
    <li><a href="#duckdb快速排序">DuckDB快速排序</a></li>
    <li><a href="#duckdb计算树路径关联分析">DuckDB计算树路径(关联分析)</a>
      <ul>
        <li><a href="#数据样本含下面一二的数据">数据样本（含下面一、二的数据）</a></li>
        <li><a href="#数据样本一结构">数据样本（一）结构</a>
          <ul>
            <li><a href="#duckdb代码花费6秒">duckdb代码，花费6秒：</a></li>
            <li><a href="#pandas代码花费22秒">Pandas代码，花费22+秒:</a></li>
          </ul>
        </li>
        <li><a href="#数据样本二结构">数据样本（二）结构</a>
          <ul>
            <li><a href="#pandas代码花费75秒">Pandas代码，花费7.5秒</a></li>
            <li><a href="#duckdb代码花费33秒">DuckDB代码，花费3.3秒</a></li>
          </ul>
        </li>
      </ul>
    </li>
    <li><a href="#树形关系新思路">树形关系新思路</a>
      <ul>
        <li><a href="#第一步">第一步</a></li>
        <li><a href="#第二步">第二步</a></li>
        <li><a href="#第三步">第三步</a></li>
        <li><a href="#以上三步的完整代码">以上三步的完整代码</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="概述">概述</h2>
<p>貌似<code>duckdb</code>能自动识别文件的<code>encoding</code>。</p>
<h2 id="实现emeditor的列拆分功能">实现<code>emeditor</code>的列拆分功能</h2>
<h3 id="关键函数">关键函数</h3>
<ol>
<li>regexp_matches，查询字符串是否包含<code>正则表达式字符</code></li>
<li>regexp_split_to_array，按给定的<code>正则表达式字符</code>进行拆分</li>
<li>unnest，将数组转为行</li>
<li>contains，判断是否包含特定字符（不支持正则表达式）</li>
</ol>
<h3 id="数据样本">数据样本</h3>
<table>
<thead>
<tr>
<th>phone</th>
<th>introduce</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>111</td>
<td>New York|Chicago</td>
<td>Jean Vasquez</td>
</tr>
<tr>
<td>222</td>
<td>HK;Tokoy|USA</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>333</td>
<td>Chinese Shanghai</td>
<td>Jean Vasquez</td>
</tr>
</tbody>
</table>
<h3 id="以单个分隔符拆分">以单个分隔符拆分</h3>
<h4 id="duckdb代码"><code>duckdb</code>代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--对包含;的列进行拆分，然后转为行。注意：UNION ALL 前后的列顺序必须一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--与 UNION ALL 关键字 后面的列顺序必须一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="n">phone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">UNNEST</span><span class="p">(</span><span class="n">regexp_split_to_array</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">	</span><span class="s1">&#39;;&#39;</span><span class="p">))</span><span class="w"> </span><span class="n">introduce</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">contains</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">	</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 与不包含;的行进行合并，实际中要去掉
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="c1">--与 UNION ALL 关键字 前面的列顺序必须一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">	</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">not</span><span class="w"> </span><span class="k">contains</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">	</span><span class="s1">&#39;;&#39;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="结果">结果</h4>
<table>
<thead>
<tr>
<th>phone</th>
<th>introduce</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>222</td>
<td>HK</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>222</td>
<td>Tokoy|USA</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>111</td>
<td>New York|Chicago</td>
<td>Jean Vasquez</td>
</tr>
<tr>
<td>333</td>
<td>Chinese Shanghai</td>
<td>Jean Vasquez</td>
</tr>
</tbody>
</table>
<h3 id="以多个分隔符进行拆分">以多个分隔符进行拆分</h3>
<p>支持按多个分隔符进行列拆分，此处为将<code>introduce</code>列按<code>;</code>和<code>|</code>进行拆分。</p>
<h4 id="duckdb代码-1"><code>duckdb</code>代码</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">phone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">UNNEST</span><span class="p">(</span><span class="n">regexp_split_to_array</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">	</span><span class="s1">&#39;[;|]&#39;</span><span class="p">))</span><span class="w"> </span><span class="n">introduce</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">regexp_matches</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="s1">&#39;[;|]&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">delim</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">header</span><span class="o">=</span><span class="k">True</span><span class="p">,</span><span class="w"> </span><span class="n">columns</span><span class="o">=</span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">not</span><span class="w"> </span><span class="n">regexp_matches</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="s1">&#39;[;|]&#39;</span><span class="p">)</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h4 id="结果-1">结果</h4>
<table>
<thead>
<tr>
<th>phone</th>
<th>introduce</th>
<th>name</th>
</tr>
</thead>
<tbody>
<tr>
<td>111</td>
<td>New York</td>
<td>Jean Vasquez</td>
</tr>
<tr>
<td>111</td>
<td>Chicago</td>
<td>Jean Vasquez</td>
</tr>
<tr>
<td>222</td>
<td>HK</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>222</td>
<td>Tokoy</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>222</td>
<td>USA</td>
<td>Nakayama Yuito</td>
</tr>
<tr>
<td>333</td>
<td>Chinese Shanghai</td>
<td>Jean Vasquez</td>
</tr>
</tbody>
</table>
<h2 id="基于csv文件的分析结果写入到csv文件">基于csv文件的分析结果写入到csv文件</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">tbl</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;output.csv&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">HEADER</span><span class="p">,</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>如，将上节的分析结果写入csv文件的语句是:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--对包含;的列进行拆分，然后转为行。注意：UNION ALL 前后的列顺序必须一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">COPY</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">phone</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">UNNEST</span><span class="p">(</span><span class="n">regexp_split_to_array</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">	</span><span class="s1">&#39;[;|]&#39;</span><span class="p">))</span><span class="w"> </span><span class="n">introduce</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">name</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="n">delim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="w"> </span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">regexp_matches</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="s1">&#39;[;|]&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">SELECT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">FROM</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;testfile.csv&#39;</span><span class="p">,</span><span class="n">delim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">,</span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">True</span><span class="p">,</span><span class="n">columns</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">{</span><span class="s1">&#39;phone&#39;</span><span class="p">:</span><span class="s1">&#39;BIGINT&#39;</span><span class="p">,</span><span class="s1">&#39;introduce&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;VARCHAR&#39;</span><span class="w"> </span><span class="err">}</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">	</span><span class="k">WHERE</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">		</span><span class="k">not</span><span class="w"> </span><span class="n">regexp_matches</span><span class="p">(</span><span class="n">introduce</span><span class="p">,</span><span class="s1">&#39;[;|]&#39;</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;output.csv&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">HEADER</span><span class="p">,</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="将csv文件导入到duckdb数据库">将<code>csv</code>文件导入到<code>duckdb</code>数据库</h2>
<p>以下语句将会自动新建数据表<code>ontime</code>并导入csv文件数据。
<code>CREATE TABLE ontime AS SELECT * FROM 'flights.csv';</code></p>
<h2 id="递归查询">递归查询</h2>
<p>暂未掌握，附源文档链接
<a href="https://duckdb.org/docs/sql/query_syntax/with" target="_blank" rel="noopener noreffer ">https://duckdb.org/docs/sql/query_syntax/with</a></p>
<h2 id="实现低内存占用的csv文件按指定列去重">实现低内存占用的<code>CSV</code>文件按指定列去重</h2>
<p><code>CSV</code>文件中有<code>A,B,C,D,E,F</code>6列，E列为<code>日期时间</code>列。</p>
<h3 id="只保留要去重的列">只保留要去重的列</h3>
<p>基于哪几列去重就只保留哪几列</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="k">DISTINCT</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">,</span><span class="n">D</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">&#39;待去重CSV文件路径&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;output.csv&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">HEADER</span><span class="p">,</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="保留所有字段">保留所有字段</h3>
<p>基于<code>A,B,C,D</code>四列去重，同时保留<code>E,F</code>两个字段（值随意），因为<code>GROUP BY</code>的作用，会出现一组<code>A,B,C,D</code>的值对应多组E,F的值，所以使用<code>ANY_VALUE</code>函数来随机选取<code>E,F</code>列的值。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="n">ANY_VALUE</span><span class="p">(</span><span class="n">E</span><span class="p">),</span><span class="n">ANY_VALUE</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">&#39;待去重CSV文件路径&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">,</span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;output.csv&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">HEADER</span><span class="p">,</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="保留最早和日晚日期时间">保留<code>最早</code>和<code>日晚``日期时间</code></h3>
<p>基于<code>A,B,C,D</code>四列去重，同时保留<code>E</code>中最早和最晚两个值，使用<code>MAX</code>、<code>MIN</code>函数分别获取最晚、最早<code>日期时间</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">COPY</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">,</span><span class="n">D</span><span class="p">,</span><span class="k">MAX</span><span class="p">(</span><span class="n">E</span><span class="p">)</span><span class="w"> </span><span class="err">最晚日期时间</span><span class="p">,</span><span class="k">MIN</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="err">最早日期时间</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="s1">&#39;待去重CSV文件路径&#39;</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="n">B</span><span class="p">,</span><span class="k">C</span><span class="p">,</span><span class="n">D</span><span class="p">)</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;output.csv&#39;</span><span class="w"> </span><span class="p">(</span><span class="n">HEADER</span><span class="p">,</span><span class="w"> </span><span class="k">DELIMITER</span><span class="w"> </span><span class="s1">&#39;,&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="获取特定表的所有列名">获取特定表的所有列名</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">column_name</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;表名&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>column_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>phone</td>
</tr>
<tr>
<td>uid</td>
</tr>
<tr>
<td>个人信息</td>
</tr>
<tr>
<td>备注</td>
</tr>
</tbody>
</table>
<h3 id="结果保存为数组">结果保存为数组</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">ARRAY_AGG</span><span class="p">(</span><span class="k">column_name</span><span class="p">)</span><span class="w">	</span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w">	</span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;表名&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>array_agg(column_name)</th>
</tr>
</thead>
<tbody>
<tr>
<td>[&lsquo;phone&rsquo;,&lsquo;uid&rsquo;,&lsquo;个人信息&rsquo;,&lsquo;备注&rsquo;]</td>
</tr>
</tbody>
</table>
<h3 id="保存为字典结构体">保存为字典（结构体）</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">row</span><span class="p">(</span><span class="k">column_name</span><span class="p">,</span><span class="n">data_type</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">name_type</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;表名&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output</strong></p>
<table>
<thead>
<tr>
<th>name_type</th>
</tr>
</thead>
<tbody>
<tr>
<td>{&lsquo;column_name&rsquo;: phone, &lsquo;data_type&rsquo;: BIGINT}</td>
</tr>
<tr>
<td>{&lsquo;column_name&rsquo;: uid, &lsquo;data_type&rsquo;: BIGINT}</td>
</tr>
<tr>
<td>{&lsquo;column_name&rsquo;: 个人信息, &lsquo;data_type&rsquo;: VARCHAR}</td>
</tr>
<tr>
<td>{&lsquo;column_name&rsquo;: 备注, &lsquo;data_type&rsquo;: VARCHAR}</td>
</tr>
</tbody>
</table>
<h3 id="其他与列相关基础信息的查询">其他与列相关<code>基础信息</code>的查询</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">columns</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;表名&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>table_catalog</th>
<th>table_schema</th>
<th>table_name</th>
<th>column_name</th>
<th>ordinal_position</th>
<th>column_default</th>
<th>is_nullable</th>
<th>data_type</th>
<th>character_maximum_length</th>
<th>character_octet_length</th>
<th>numeric_precision</th>
<th>numeric_precision_radix</th>
<th>numeric_scale</th>
<th>datetime_precision</th>
<th>interval_type</th>
<th>interval_precision</th>
<th>character_set_catalog</th>
<th>character_set_schema</th>
<th>character_set_name</th>
<th>collation_catalog</th>
<th>collation_schema</th>
<th>collation_name</th>
<th>domain_catalog</th>
<th>domain_schema</th>
<th>domain_name</th>
<th>udt_catalog</th>
<th>udt_schema</th>
<th>udt_name</th>
<th>scope_catalog</th>
<th>scope_schema</th>
<th>scope_name</th>
<th>maximum_cardinality</th>
<th>dtd_identifier</th>
<th>is_self_referencing</th>
<th>is_identity</th>
<th>identity_generation</th>
<th>identity_start</th>
<th>identity_increment</th>
<th>identity_maximum</th>
<th>identity_minimum</th>
<th>identity_cycle</th>
<th>is_generated</th>
<th>generation_expression</th>
<th>is_updatable</th>
</tr>
</thead>
<tbody>
<tr>
<td>test</td>
<td>main</td>
<td>表名</td>
<td>phone</td>
<td>1</td>
<td></td>
<td>YES</td>
<td>BIGINT</td>
<td></td>
<td></td>
<td>64</td>
<td>2</td>
<td>0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>main</td>
<td>表名</td>
<td>uid</td>
<td>2</td>
<td></td>
<td>YES</td>
<td>BIGINT</td>
<td></td>
<td></td>
<td>64</td>
<td>2</td>
<td>0</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>main</td>
<td>表名</td>
<td>个人信息</td>
<td>3</td>
<td></td>
<td>YES</td>
<td>VARCHAR</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>main</td>
<td>表名</td>
<td>备注</td>
<td>4</td>
<td></td>
<td>YES</td>
<td>VARCHAR</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="获取当前duckdb文件所有数据库名">获取<code>当前DuckDB文件</code>所有<code>数据库</code>名</h3>
<p>其中<code>catalog</code>为可见的<code>schema</code>(通俗理解的<code>数据库</code>)名称</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">schemata</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>catalog_name</th>
<th>schema_name</th>
<th>schema_owner</th>
<th>default_character_set_catalog</th>
<th>default_character_set_schema</th>
<th>default_character_set_name</th>
<th>sql_path</th>
</tr>
</thead>
<tbody>
<tr>
<td>system</td>
<td>information_schema</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>system</td>
<td>main</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>system</td>
<td>pg_catalog</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>temp</td>
<td>information_schema</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>temp</td>
<td>main</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>temp</td>
<td>pg_catalog</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>information_schema</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>main</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>test</td>
<td>pg_catalog</td>
<td>duckdb</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="获取某数据库下所有的数据表名">获取<code>某数据库</code>下所有的数据表名</h3>
<h4 id="第一种方式">第一种方式</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="k">table_name</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">information_schema</span><span class="p">.</span><span class="n">tables</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">table_catalog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;test&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>table_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>table1</td>
</tr>
<tr>
<td>table2</td>
</tr>
<tr>
<td>test</td>
</tr>
</tbody>
</table>
<h4 id="第二种方式推荐">第二种方式【推荐】</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">PRAGMA</span><span class="w"> </span><span class="n">show_tables</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>table_name</th>
</tr>
</thead>
<tbody>
<tr>
<td>table1</td>
</tr>
<tr>
<td>table2</td>
</tr>
<tr>
<td>test</td>
</tr>
</tbody>
</table>
<h2 id="限制使用内存大小和并发数">限制使用内存大小和并发数</h2>
<p>第一种【推荐】</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 设置内存大小限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SET</span><span class="w"> </span><span class="n">memory_limit</span><span class="o">=</span><span class="s1">&#39;10GB&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- configure the system to use 1 thread 待测试作用
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SET</span><span class="w"> </span><span class="n">threads</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 查看所有可用设置，同时可在网页中查看所有可用设置：https://duckdb.org/docs/sql/configuration#configuration-reference
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">duckdb_settings</span><span class="p">();</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 查看特定的设置值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">current_setting</span><span class="p">(</span><span class="s1">&#39;access_mode&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 将内存限制重置为默认，默认好像是程序自动的。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">RESET</span><span class="w"> </span><span class="n">memory_limit</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第二种</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 设置内存大小限制
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">memory_limit</span><span class="o">=</span><span class="s1">&#39;1GB&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 设置并行查询数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">PRAGMA</span><span class="w"> </span><span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>更多关于数据库基础设置信息详见：</p>
<ol>
<li><a href="https://duckdb.org/docs/sql/pragmas" target="_blank" rel="noopener noreffer ">https://duckdb.org/docs/sql/pragmas</a></li>
<li><a href="https://duckdb.org/docs/sql/configuration" target="_blank" rel="noopener noreffer ">https://duckdb.org/docs/sql/configuration</a></li>
<li>见<a href="#DuckDB%60%e8%ae%be%e7%bd%ae%60%e5%8f%82%e6%95%b0%e6%8f%8f%e8%bf%b0%e7%bf%bb%e8%af%91" rel="">DuckDB<code>设置</code>参数描述翻译</a></li>
</ol>
<h2 id="关于删除大表不会改变数据库文件的大小疑问">关于<code>删除大表不会改变数据库文件的大小</code>疑问</h2>
<p>从数据库中删除了一个数据量巨大的表。但是，数据库文件的大小保持不变，尝试使用<code>commit()</code>和<code> VACCUM</code> 语句也无济于事。
找到相关的话题：https://github.com/duckdb/duckdb/discussions/7152
结论：删除表不会改变存储空间，以在将来插入新数据时重新利用，这是个问题，将来会解决。</p>
<h2 id="duckdb设置参数描述翻译">DuckDB<code>设置</code>参数描述翻译</h2>
<p>获取当前版本所有可用参数：<code>SELECT * FROM duckdb_settings();</code></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>默认值</th>
<th>中文描述</th>
<th>英文描述</th>
<th>值类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>access_mode</td>
<td>automatic</td>
<td>数据库的访问模式（AUTOMATIC，READ_ONLY或READ_WRITE）</td>
<td>Access mode of the database (AUTOMATIC, READ_ONLY or READ_WRITE)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>checkpoint_threshold</td>
<td>16.7MB</td>
<td>自动触发检查点的WAL大小阈值（例如1GB）</td>
<td>The WAL size threshold at which to automatically trigger a checkpoint (e.g. 1GB)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>debug_checkpoint_abort</td>
<td>none</td>
<td>DEBUG设置：出于测试目的，在检查点时触发中止</td>
<td>DEBUG SETTING: trigger an abort while checkpointing for testing purposes</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>debug_force_external</td>
<td>FALSE</td>
<td>DEBUG设置：对支持它的操作符强制进行核外计算，用于测试</td>
<td>DEBUG SETTING: force out-of-core computation for operators that support it, used for testing</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>debug_force_no_cross_product</td>
<td>FALSE</td>
<td>DEBUG设置：当超图未连接时，强制禁用交叉产品生成，用于测试</td>
<td>DEBUG SETTING: Force disable cross product generation when hyper graph isn&rsquo;t connected, used for testing</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>debug_asof_iejoin</td>
<td>FALSE</td>
<td>DEBUG设置：强制使用IEJoin实现AsOf连接</td>
<td>DEBUG SETTING: force use of IEJoin to implement AsOf joins</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>debug_window_mode</td>
<td>NULL</td>
<td>DEBUG设置：切换要使用的窗口模式</td>
<td>DEBUG SETTING: switch window mode to use</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>default_collation</td>
<td></td>
<td>未指定时使用的排序设置</td>
<td>The collation setting used when none is specified</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>default_order</td>
<td>asc</td>
<td>未指定时使用的排序类型（ASC或DESC）</td>
<td>The order type used when none is specified (ASC or DESC)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>default_null_order</td>
<td>nulls_last</td>
<td>未指定时使用的空值排序（NULLS_FIRST或NULLS_LAST）</td>
<td>Null ordering used when none is specified (NULLS_FIRST or NULLS_LAST)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>disabled_optimizers</td>
<td></td>
<td>DEBUG设置：禁用特定的优化器集（逗号分隔）</td>
<td>DEBUG SETTING: disable a specific set of optimizers (comma separated)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>enable_external_access</td>
<td>TRUE</td>
<td>允许数据库访问外部状态（例如通过加载/安装模块，COPY TO/FROM，CSV读取器，pandas替换扫描等）</td>
<td>Allow the database to access external state (through e.g. loading/installing modules, COPY TO/FROM, CSV readers, pandas replacement scans, etc)</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>enable_fsst_vectors</td>
<td>FALSE</td>
<td>允许对FSST压缩段进行扫描以发出压缩向量以利用后期解压缩</td>
<td>Allow scans on FSST compressed segments to emit compressed vectors to utilize late decompression</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>allow_unsigned_extensions</td>
<td>FALSE</td>
<td>允许加载具有无效或缺失签名的扩展</td>
<td>Allow to load extensions with invalid or missing signatures</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>custom_extension_repository</td>
<td></td>
<td>覆盖远程扩展安装的自定义端点</td>
<td>Overrides the custom endpoint for remote extension installation</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>enable_object_cache</td>
<td>FALSE</td>
<td>是否使用对象缓存来缓存例如Parquet元数据</td>
<td>Whether or not object cache is used to cache e.g. Parquet metadata</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>enable_http_metadata_cache</td>
<td>FALSE</td>
<td>是否使用全局http元数据来缓存HTTP元数据</td>
<td>Whether or not the global http metadata is used to cache HTTP metadata</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>enable_profiling</td>
<td>NULL</td>
<td>启用分析，并设置输出格式（JSON，QUERY_TREE，QUERY_TREE_OPTIMIZER）</td>
<td>Enables profiling, and sets the output format (JSON, QUERY_TREE, QUERY_TREE_OPTIMIZER)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>enable_progress_bar</td>
<td>FALSE</td>
<td>启用进度条，将长查询的进度打印到终端</td>
<td>Enables the progress bar, printing progress to the terminal for long queries</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>enable_progress_bar_print</td>
<td>TRUE</td>
<td>在&rsquo;enable_progress_bar&rsquo;为true时，控制进度条的打印</td>
<td>Controls the printing of the progress bar, when &rsquo;enable_progress_bar&rsquo; is true</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>experimental_parallel_csv</td>
<td>NULL</td>
<td>是否使用实验性的并行CSV阅读器</td>
<td>Whether or not to use the experimental parallel CSV reader</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>explain_output</td>
<td>physical_only</td>
<td>EXPLAIN语句的输出（ALL，OPTIMIZED_ONLY，PHYSICAL_ONLY）</td>
<td>Output of EXPLAIN statements (ALL, OPTIMIZED_ONLY, PHYSICAL_ONLY)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>extension_directory</td>
<td></td>
<td>设置存储扩展的目录</td>
<td>Set the directory to store extensions in</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>external_threads</td>
<td>0</td>
<td>处理DuckDB任务的外部线程数。</td>
<td>The number of external threads that work on DuckDB tasks.</td>
<td>BIGINT</td>
</tr>
<tr>
<td>file_search_path</td>
<td></td>
<td>用于搜索输入文件的目录的逗号分隔列表</td>
<td>A comma separated list of directories to search for input files</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>force_compression</td>
<td>Auto</td>
<td>DEBUG设置：强制使用特定的压缩方法</td>
<td>DEBUG SETTING: forces a specific compression method to be used</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>force_bitpacking_mode</td>
<td>auto</td>
<td>DEBUG设置：强制使用特定的位打包模式</td>
<td>DEBUG SETTING: forces a specific bitpacking mode</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>home_directory</td>
<td></td>
<td>设置系统使用的主目录</td>
<td>Sets the home directory used by the system</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>log_query_path</td>
<td>NULL</td>
<td>指定应记录查询的路径（默认：空字符串，不记录查询）</td>
<td>Specifies the path to which queries should be logged (default: empty string, queries are not logged)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>immediate_transaction_mode</td>
<td>FALSE</td>
<td>是否应在需要时懒惰地启动事务，或在调用BEGIN TRANSACTION时立即启动</td>
<td>Whether transactions should be started lazily when needed, or immediately when BEGIN TRANSACTION is called</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>integer_division</td>
<td>0</td>
<td>/操作符是否默认为整数除法，还是浮点除法</td>
<td>Whether or not the / operator defaults to integer division, or to floating point division</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>max_expression_depth</td>
<td>1000</td>
<td>解析器中的最大表达式深度限制。警告：增加此设置并使用非常深的表达式可能会导致栈溢出错误。</td>
<td>The maximum expression depth limit in the parser. WARNING: increasing this setting and using very deep expressions might lead to stack overflow errors.</td>
<td>UBIGINT</td>
</tr>
<tr>
<td>max_memory</td>
<td>13.4GB</td>
<td>系统的最大内存（例如1GB）</td>
<td>The maximum memory of the system (e.g. 1GB)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>memory_limit</td>
<td>13.4GB</td>
<td>系统的最大内存（例如1GB）</td>
<td>The maximum memory of the system (e.g. 1GB)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>null_order</td>
<td>nulls_last</td>
<td>未指定时使用的空值排序（NULLS_FIRST或NULLS_LAST）</td>
<td>Null ordering used when none is specified (NULLS_FIRST or NULLS_LAST)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>ordered_aggregate_threshold</td>
<td>262144</td>
<td>排序前累积的行数，用于调优</td>
<td>the number of rows to accumulate before sorting, used for tuning</td>
<td>UBIGINT</td>
</tr>
<tr>
<td>password</td>
<td>NULL</td>
<td>要使用的密码。出于遗留兼容性而忽略。</td>
<td>The password to use. Ignored for legacy compatibility.</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>perfect_ht_threshold</td>
<td>12</td>
<td>使用完美哈希表的字节阈值（默认值：12）</td>
<td>Threshold in bytes for when to use a perfect hash table (default: 12)</td>
<td>BIGINT</td>
</tr>
<tr>
<td>pivot_limit</td>
<td>100000</td>
<td>数据透视语句中的最大数据透视列数（默认值：100000）</td>
<td>The maximum numer of pivot columns in a pivot statement (default: 100000)</td>
<td>BIGINT</td>
</tr>
<tr>
<td>preserve_identifier_case</td>
<td>TRUE</td>
<td>是否保留标识符大小写，而不是始终将所有非引用标识符小写</td>
<td>Whether or not to preserve the identifier case, instead of always lowercasing all non-quoted identifiers</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>preserve_insertion_order</td>
<td>TRUE</td>
<td>是否保留插入顺序。如果设置为false，则允许系统重新排序不包含ORDER BY子句的任何结果。</td>
<td>Whether or not to preserve insertion order. If set to false the system is allowed to re-order any results that do not contain ORDER BY clauses.</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>profiler_history_size</td>
<td>NULL</td>
<td>设置分析器历史记录大小</td>
<td>Sets the profiler history size</td>
<td>BIGINT</td>
</tr>
<tr>
<td>profile_output</td>
<td></td>
<td>应保存分析输出的文件，或为空以打印到终端</td>
<td>The file to which profile output should be saved, or empty to print to the terminal</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>profiling_mode</td>
<td>NULL</td>
<td>分析模式（STANDARD或DETAILED）</td>
<td>The profiling mode (STANDARD or DETAILED)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>profiling_output</td>
<td></td>
<td>应保存分析输出的文件，或为空以打印到终端</td>
<td>The file to which profile output should be saved, or empty to print to the terminal</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>progress_bar_time</td>
<td>2000</td>
<td>设置查询需要多长时间（以毫秒为单位）才开始打印进度条</td>
<td>Sets the time (in milliseconds) how long a query needs to take before we start printing a progress bar</td>
<td>BIGINT</td>
</tr>
<tr>
<td>schema</td>
<td>main</td>
<td>设置默认搜索模式。相当于将search_path设置为单个值。</td>
<td>Sets the default search schema. Equivalent to setting search_path to a single value.</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>search_path</td>
<td></td>
<td>将默认搜索路径设置为逗号分隔的值列表</td>
<td>Sets the default search search path as a comma-separated list of values</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>temp_directory</td>
<td>d:\fk.duckdb.tmp</td>
<td>设置要写入临时文件的目录</td>
<td>Set the directory to which to write temp files</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>threads</td>
<td>16</td>
<td>系统使用的总线程数。</td>
<td>The number of total threads used by the system.</td>
<td>BIGINT</td>
</tr>
<tr>
<td>username</td>
<td>NULL</td>
<td>要使用的用户名。出于遗留兼容性而忽略。</td>
<td>The username to use. Ignored for legacy compatibility.</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>user</td>
<td>NULL</td>
<td>要使用的用户名。出于遗留兼容性而忽略。</td>
<td>The username to use. Ignored for legacy compatibility.</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>wal_autocheckpoint</td>
<td>16.7MB</td>
<td>自动触发检查点的WAL大小阈值（例如1GB）</td>
<td>The WAL size threshold at which to automatically trigger a checkpoint (e.g. 1GB)</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>worker_threads</td>
<td>16</td>
<td>系统使用的总线程数。</td>
<td>The number of total threads used by the system.</td>
<td>BIGINT</td>
</tr>
<tr>
<td>binary_as_string</td>
<td></td>
<td>在Parquet文件中，将二进制数据解释为字符串。</td>
<td>In Parquet files, interpret binary data as a string.</td>
<td>BOOLEAN</td>
</tr>
<tr>
<td>TimeZone</td>
<td>Asia/Shanghai</td>
<td>当前时区</td>
<td>The current time zone</td>
<td>VARCHAR</td>
</tr>
<tr>
<td>Calendar</td>
<td>gregorian</td>
<td>当前日历</td>
<td>The current calendar</td>
<td>VARCHAR</td>
</tr>
</tbody>
</table>
<h2 id="查看当前版本所有可用扩展">查看当前版本所有可用扩展</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">duckdb_extensions</span><span class="p">();</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Output:</strong></p>
<table>
<thead>
<tr>
<th>extension_name</th>
<th>loaded</th>
<th>installed</th>
<th>install_path</th>
<th>description</th>
<th>aliases</th>
</tr>
</thead>
<tbody>
<tr>
<td>autocomplete</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Add supports for autocomplete in the shell</td>
<td>[]</td>
</tr>
<tr>
<td>fts</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds support for Full-Text Search Indexes</td>
<td>[]</td>
</tr>
<tr>
<td>httpfs</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds support for reading and writing files over a HTTP(S) connection</td>
<td>[&lsquo;http&rsquo;,&lsquo;https&rsquo;,&lsquo;s3&rsquo;]</td>
</tr>
<tr>
<td>icu</td>
<td>true</td>
<td>true</td>
<td>(BUILT-IN)</td>
<td>Adds support for time zones and collations using the ICU library</td>
<td>[]</td>
</tr>
<tr>
<td>inet</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds support for IP-related data types and functions</td>
<td>[]</td>
</tr>
<tr>
<td>jemalloc</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Overwrites system allocator with JEMalloc</td>
<td>[]</td>
</tr>
<tr>
<td>json</td>
<td>true</td>
<td>true</td>
<td>(BUILT-IN)</td>
<td>Adds support for JSON operations</td>
<td>[]</td>
</tr>
<tr>
<td>motherduck</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Enables motherduck integration with the system</td>
<td>[&lsquo;md&rsquo;]</td>
</tr>
<tr>
<td>parquet</td>
<td>true</td>
<td>true</td>
<td>(BUILT-IN)</td>
<td>Adds support for reading and writing parquet files</td>
<td>[]</td>
</tr>
<tr>
<td>postgres_scanner</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds support for reading from a Postgres database</td>
<td>[&lsquo;postgres&rsquo;]</td>
</tr>
<tr>
<td>spatial</td>
<td>true</td>
<td>true</td>
<td>C:\spatial.duckdb_extension</td>
<td>Geospatial extension that adds support for working with spatial data and functions</td>
<td>[]</td>
</tr>
<tr>
<td>sqlite_scanner</td>
<td>false</td>
<td>true</td>
<td>C:\sqlite_scanner.duckdb_extension</td>
<td>Adds support for reading SQLite database files</td>
<td>[&lsquo;sqlite&rsquo;,&lsquo;sqlite3&rsquo;]</td>
</tr>
<tr>
<td>tpcds</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds TPC-DS data generation and query support</td>
<td>[]</td>
</tr>
<tr>
<td>tpch</td>
<td>false</td>
<td>false</td>
<td></td>
<td>Adds TPC-H data generation and query support</td>
<td>[]</td>
</tr>
<tr>
<td>visualizer</td>
<td>true</td>
<td></td>
<td></td>
<td></td>
<td>[]</td>
</tr>
</tbody>
</table>
<h3 id="扩展的安装与加载">扩展的安装与加载</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="n">INSTALL</span><span class="w"> </span><span class="n">spatial</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">LOAD</span><span class="w"> </span><span class="n">spatial</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="内存与临时文件">内存与临时文件</h2>
<p>默认情况下，如果 DuckDB 在内存模式下运行，它不会尝试将数据缓存到磁盘，而当使用磁盘支持的数据库时，DuckDB 将尝试将数据缓存到目录mydb.db.tmp。您也可以手动指定要缓存的目录，也可以使用SET temp_directory=&rsquo;/tmp/mytmp.duck&rsquo;;</p>
<h2 id="进行连接查询时内存消耗殆尽">进行连接查询时，内存消耗殆尽</h2>
<p>下文是问题描述
<a href="https://github.com/duckdb/duckdb/discussions/3820" target="_blank" rel="noopener noreffer ">https://github.com/duckdb/duckdb/discussions/3820</a>
下面的<code>ISSUE</code>说是已经解决这个问题，实现了支持超过内存大小的<code>连接查询</code>
<a href="https://github.com/duckdb/duckdb/pull/4189" target="_blank" rel="noopener noreffer ">https://github.com/duckdb/duckdb/pull/4189</a></p>
<h2 id="duckdb-vs-clickhouse-vs-databend">DuckDB VS ClickHouse VS DataBend</h2>
<p><a href="https://github.com/datafuselabs/databend/discussions/11357" target="_blank" rel="noopener noreffer ">https://github.com/datafuselabs/databend/discussions/11357</a></p>
<h2 id="duckdb快速排序">DuckDB快速排序</h2>
<p><a href="https://duckdb.org/2021/08/27/external-sorting.html" target="_blank" rel="noopener noreffer ">这篇文章</a>中，介绍 <code>DuckDB</code> 如何排序，以及它与其他数据管理系统的比较。</p>
<p>因为人们通常在笔记本电脑或其他个人电脑上运行数据分析，因此此文在<code>2020 MacBook Pro</code>上运行这些实验。该笔记本电脑具有基于<code>ARM</code>的Apple M1 CPU。M1处理器具有8个核心：4个高性能核心和4个能效核心，<code>16GB</code>内存，固态硬盘。
我们将比较以下数据库系统的差异：</p>
<table>
<thead>
<tr>
<th>数据库</th>
<th>版本</th>
</tr>
</thead>
<tbody>
<tr>
<td>ClickHouse</td>
<td>21.7.5</td>
</tr>
<tr>
<td>HyPer</td>
<td>2021.2.1.12564</td>
</tr>
<tr>
<td>Pandas</td>
<td>1.3.2</td>
</tr>
<tr>
<td>SQLite</td>
<td>3.36.0</td>
</tr>
</tbody>
</table>
<p><strong>结论</strong>
DuckDB 的新并行排序实现可以有效地对<code>超出内存容量</code>的数据进行排序，从而利用现代 SSD 的速度。在其他系统因内存不足或切换到速度慢得多的外部排序策略而崩溃的情况下，DuckDB 的性能会在超过内存限制时优雅地下降。
性能测试的源代码：https://github.com/lnkuiper/experiments/tree/master/sorting</p>
<h2 id="duckdb计算树路径关联分析">DuckDB计算树路径(关联分析)</h2>
<h3 id="数据样本含下面一二的数据">数据样本（含下面一、二的数据）</h3>
<p><code>数据样本</code>使用<code>excel</code>的<code>randombetween</code>函数及<code>excel</code>办公助手插件生成的虚假测试数据，如与您的个人信息一致，纯乃天意。
<a href="test.csv" rel="">数据样本.csv</a>
数据样本中号码<code>15834961213</code>两次在phone中出现，且都处于树形关系的路径中间。</p>
<h3 id="数据样本一结构">数据样本（一）结构</h3>
<table>
<thead>
<tr>
<th>phone</th>
<th>id</th>
<th>pid</th>
</tr>
</thead>
<tbody>
<tr>
<td>18693044740</td>
<td>37775</td>
<td>78340</td>
</tr>
<tr>
<td>14580719766</td>
<td>78340</td>
<td>47070</td>
</tr>
<tr>
<td>15834961213</td>
<td>47070</td>
<td>10960</td>
</tr>
<tr>
<td>13395855488</td>
<td>10960</td>
<td>67272</td>
</tr>
<tr>
<td>15657298376</td>
<td>67272</td>
<td>55701</td>
</tr>
<tr>
<td>15889121934</td>
<td>55701</td>
<td></td>
</tr>
<tr>
<td>18631569256</td>
<td>14280</td>
<td></td>
</tr>
<tr>
<td>13807639997</td>
<td>15582</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="duckdb代码花费6秒">duckdb代码，花费6秒：</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">duckdb</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_all_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">phone</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># phone对应的id</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select id from datas where phone=&#39;</span><span class="si">{</span><span class="n">phone</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_id</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 父ID等于上面ID的Phone,即儿子的Phone</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select phone from datas where pid=&#39;</span><span class="si">{</span><span class="n">current_id</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">son_phone_array</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">son_phone_array</span><span class="p">:</span>  <span class="c1"># 有儿子的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">son_phone</span> <span class="o">=</span> <span class="n">son_phone_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_son_phones</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">find_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;找出特定号码的子孙号码形成路径后保存到path列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="n">find_all_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tree_list</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;update datas set path = &#39;</span><span class="si">{</span><span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;,level=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> where phone =</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_phone_trees</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">	<span class="c1"># 全表生成数关系</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;select phone from datas where id NOTNULL AND pid ISNULL;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root_phones</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">root_phones</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_path</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;test.duckdb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;CREATE TABLE IF NOT EXISTS datas AS SELECT * FROM &#39;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">xxxxxx</span><span class="se">\\</span><span class="s2">test.csv&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;ALTER TABLE datas ADD COLUMN IF NOT EXISTS path VARCHAR;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;ALTER TABLE datas ADD COLUMN IF NOT EXISTS level INT;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 创建索引，数据量大的时候测试是否有价值【待测试】。</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;CREATE INDEX p_id_pid_idx ON datas (phone, id,pid);&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">gen_phone_trees</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>上述代码只能对给定号码出现在一个数中的情况进行处理，并且只能查找下子孙元素，以下是改进后的代码，能够：</p>
<ol>
<li>从树的任意位置元素开始，还原整个树的路径；</li>
<li>处理同一个号码出现在多个树中的情况。
缺陷：没有考虑一个PID对应多个同级ID的情况。</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">duckdb</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">count</span><span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_related_ids</span><span class="p">(</span><span class="n">current_id</span><span class="p">,</span><span class="n">phone</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">path_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">current_id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">id_phone_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">current_id</span><span class="p">:</span><span class="n">phone</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_son_ids</span><span class="p">(</span><span class="n">current_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 父ID等于上面ID的Phone,即儿子的ID</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select id, phone from datas where pid=&#39;</span><span class="si">{</span><span class="n">current_id</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">son_ids</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">son_id_tuple</span> <span class="ow">in</span> <span class="n">son_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">son_id</span><span class="p">,</span> <span class="n">son_phone</span> <span class="o">=</span> <span class="n">son_id_tuple</span>
</span></span><span class="line"><span class="cl">            <span class="n">path_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">son_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">id_phone_dict</span><span class="p">[</span><span class="n">son_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">son_phone</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_son_ids</span><span class="p">(</span><span class="n">son_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_parent_ids</span><span class="p">(</span><span class="n">current_id</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># id等于上面PID的Phone,即父亲的ID</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select pid, phone from datas where id=&#39;</span><span class="si">{</span><span class="n">current_id</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">parent_ids</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">pid_tuple</span> <span class="ow">in</span> <span class="n">parent_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parent_id</span><span class="p">,</span> <span class="n">parent_phone</span> <span class="o">=</span> <span class="n">pid_tuple</span>
</span></span><span class="line"><span class="cl">            <span class="n">path_ids</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">)</span>  <span class="c1"># 在列表前方插入父亲ID，保持父辈在前，子辈在后的顺序</span>
</span></span><span class="line"><span class="cl">            <span class="n">id_phone_dict</span><span class="p">[</span><span class="n">parent_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent_phone</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_parent_ids</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">find_son_ids</span><span class="p">(</span><span class="n">current_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># find_parent_ids(current_id)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path_ids</span><span class="p">,</span> <span class="n">id_phone_dict</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="n">init_phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">global</span> <span class="n">count</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;找出特定号码的上下级路径并形成路径后保存到path列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># phone对应的所有id</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select DISTINCT id from datas where phone=&#39;</span><span class="si">{</span><span class="n">init_phone</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">current_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;该号码共对应ID数：&#39;</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">current_ids</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">current_id</span> <span class="ow">in</span> <span class="n">current_ids</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">tree_id_list</span><span class="p">,</span> <span class="n">id_phone_dict</span> <span class="o">=</span> <span class="n">find_related_ids</span><span class="p">(</span><span class="n">current_id</span><span class="p">,</span><span class="n">init_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># tree_id_list = list(filter(None,tree_id_list))</span>
</span></span><span class="line"><span class="cl">        <span class="n">tree_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">tree_id_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 更新path和level</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_id_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">count</span><span class="o">+=</span><span class="nb">len</span><span class="p">(</span><span class="n">tree_id_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">tree_id_list</span><span class="p">),</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">tree_id_list:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">tree_id_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;  id_phone_dict:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">id_phone_dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">path_of_phone</span> <span class="o">=</span> <span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">id_phone_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">])</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">tree_id_list</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    path_of_phone:</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">path_of_phone</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n\n</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="nb">id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_id_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">phone</span> <span class="o">=</span> <span class="n">id_phone_dict</span><span class="p">[</span><span class="nb">id</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;update datas set path = &#39;</span><span class="si">{</span><span class="n">path_of_phone</span><span class="si">}</span><span class="s2">&#39;,level=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> where phone=&#39;</span><span class="si">{</span><span class="n">phone</span><span class="si">}</span><span class="s2">&#39; and id=&#39;</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">with</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;test.duckdb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">ceshi</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">ceshi_str</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s2">&#34;&#39;</span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">&#39;&#34;</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">ceshi</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 有记录的</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SELECT DISTINCT phone FROM datas WHERE phone IN (</span><span class="si">{</span><span class="n">ceshi_str</span><span class="si">}</span><span class="s1">);&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">phones</span> <span class="o">=</span> <span class="p">[</span><span class="n">phone</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">phones</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;当前查找号码：&#39;</span><span class="p">,</span><span class="n">phone</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_path</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;耗时：&#39;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># add_path(&#34;97891706516&#34;)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="pandas代码花费22秒">Pandas代码，花费22+秒:</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;test.csv&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;phone&#34;</span><span class="p">,</span><span class="s2">&#34;id&#34;</span><span class="p">,</span><span class="s2">&#34;pid&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_all_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">phone</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># phone对应的id</span>
</span></span><span class="line"><span class="cl">        <span class="n">current_id</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">phone</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 父ID等于上面ID的Phone,即儿子的Phone</span>
</span></span><span class="line"><span class="cl">        <span class="n">son_phone_array</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">current_id</span><span class="p">][</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">son_phone_array</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># 有儿子的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">son_phone</span> <span class="o">=</span> <span class="n">son_phone_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;找出特定号码的子孙号码形成路径后保存到path列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="n">find_all_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为所有父ID为空而ID不为空的号码生成子孙路径关系</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_phone_trees</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())][</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">root_phones</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_path</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gen_phone_trees</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="数据样本二结构">数据样本（二）结构</h3>
<table>
<thead>
<tr>
<th>phone</th>
<th>pphone</th>
</tr>
</thead>
<tbody>
<tr>
<td>18693044740</td>
<td>14580719766</td>
</tr>
<tr>
<td>14580719766</td>
<td>15834961213</td>
</tr>
<tr>
<td>15834961213</td>
<td>13395855488</td>
</tr>
<tr>
<td>13395855488</td>
<td>15657298376</td>
</tr>
<tr>
<td>15657298376</td>
<td>15889121934</td>
</tr>
<tr>
<td>15889121934</td>
<td></td>
</tr>
<tr>
<td>18815083183</td>
<td>13918139598</td>
</tr>
<tr>
<td>13918139598</td>
<td>15762062144</td>
</tr>
<tr>
<td>15762062144</td>
<td>18109707945</td>
</tr>
<tr>
<td>18109707945</td>
<td>13254675670</td>
</tr>
<tr>
<td>13254675670</td>
<td></td>
</tr>
</tbody>
</table>
<h4 id="pandas代码花费75秒">Pandas代码，花费7.5秒</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">r</span><span class="s2">&#34;test.csv&#34;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;str&#39;</span><span class="p">,</span><span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">,</span><span class="s2">&#34;phone&#34;</span><span class="p">,</span><span class="s2">&#34;pphone&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_all_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">phone</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># phone对应的id</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 父ID等于上面ID的Phone,即儿子的Phone</span>
</span></span><span class="line"><span class="cl">        <span class="n">son_phone_array</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pphone&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">phone</span><span class="p">][</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">son_phone_array</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>  <span class="c1"># 有儿子的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">son_phone</span> <span class="o">=</span> <span class="n">son_phone_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">find_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;找出特定号码的子孙号码形成路径后保存到path列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;path&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s1">&#39;level&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span><span class="o">=</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="n">find_all_son_phones</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">=</span>  <span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">e</span><span class="p">,</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 为所有父ID为空而ID不为空的号码生成子孙路径关系</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_phone_trees</span><span class="p">(</span><span class="n">df</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">&amp;</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;pphone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">())][</span><span class="s1">&#39;phone&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">root_phones</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_path</span><span class="p">(</span><span class="n">df</span><span class="p">,</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">gen_phone_trees</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 找出特定号码的子孙树关系</span>
</span></span><span class="line"><span class="cl"><span class="c1"># add_path(df,&#39;15834961213&#39;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="duckdb代码花费33秒">DuckDB代码，花费3.3秒</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-py" data-lang="py"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">duckdb</span>
</span></span><span class="line"><span class="cl"><span class="c1"># import functools</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="n">duckdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;zfrz.duckdb&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;CREATE TABLE IF NOT EXISTS datas AS SELECT * FROM &#39;C:</span><span class="se">\\</span><span class="s2">Users</span><span class="se">\\</span><span class="s2">xxx</span><span class="se">\\</span><span class="s2">编程</span><span class="se">\\</span><span class="s2">test.csv&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;ALTER TABLE datas ADD COLUMN IF NOT EXISTS path VARCHAR;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;ALTER TABLE datas ADD COLUMN IF NOT EXISTS level INT;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># conn.execute(&#34;CREATE INDEX p_id_pid_idx ON datas (phone, id,pid);&#34;)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">find_all_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span> 
</span></span><span class="line"><span class="cl">    <span class="n">path</span> <span class="o">=</span> <span class="p">[</span><span class="n">phone</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">find_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;select phone from datas where pphone=&#39;</span><span class="si">{</span><span class="n">phone</span><span class="si">}</span><span class="s2">&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 父ID等于上面ID的Phone,即儿子的Phone</span>
</span></span><span class="line"><span class="cl">        <span class="n">son_phone_array</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">son_phone_array</span><span class="p">:</span>  <span class="c1"># 有儿子的情况</span>
</span></span><span class="line"><span class="cl">            <span class="n">son_phone</span> <span class="o">=</span> <span class="n">son_phone_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">find_son_phones</span><span class="p">(</span><span class="n">son_phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">find_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">path</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">add_path</span><span class="p">(</span><span class="n">phone</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;找出特定号码的子孙号码形成路径后保存到path列&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="n">find_all_son_phones</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">tree_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tree_list</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">e</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tree_list</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;update datas set path = &#39;</span><span class="si">{</span><span class="s1">&#39;-&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tree_list</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;,level=</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> where phone =</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">gen_phone_trees</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;select phone from datas where pphone ISNULL;&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">root_phones</span> <span class="o">=</span> <span class="p">[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">root_phones</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">phone</span> <span class="ow">in</span> <span class="n">root_phones</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">add_path</span><span class="p">(</span><span class="n">phone</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># add_path(15834961213)</span>
</span></span><span class="line"><span class="cl"><span class="n">gen_phone_trees</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="树形关系新思路">树形关系新思路</h2>
<h3 id="第一步">第一步</h3>
<p>postgres数据库的datas表中有phone,id,pid,path,level,rootid等6个字段，path,level,rootid三个字段本来均为NULL，根据id和pid的关联关系，计算出每个id对应的子节点，并以数组形式将id保存到path列，同时将此节点的根节点id保存到rootid，将节点在树形结构中的层级保存到level（根节点为0，依此类推）。</p>
<table>
<thead>
<tr>
<th>phone</th>
<th>id</th>
<th>pid</th>
<th>path</th>
<th>level</th>
<th>rootid</th>
</tr>
</thead>
<tbody>
<tr>
<td>15889121934</td>
<td>55701</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15657298376</td>
<td>67272</td>
<td>55701</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13395855488</td>
<td>10960</td>
<td>67272</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15834961213</td>
<td>47070</td>
<td>10960</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>14580719766</td>
<td>78340</td>
<td>47070</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18693044740</td>
<td>37775</td>
<td>78340</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18693044741</td>
<td>37775</td>
<td>78340</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18631569256</td>
<td>14280</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13807639997</td>
<td>15582</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13254675670</td>
<td>75663</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18109707945</td>
<td>12959</td>
<td>75663</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15834961213</td>
<td>22099</td>
<td>12959</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13918139598</td>
<td>22099</td>
<td>12959</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18815083183</td>
<td>83540</td>
<td>22099</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13875678880</td>
<td>58053</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15793943526</td>
<td>72534</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18739688136</td>
<td>75579</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13028479619</td>
<td>51390</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13339189047</td>
<td>90300</td>
<td>51390</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15834961213</td>
<td>46686</td>
<td>90300</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18073413108</td>
<td>53266</td>
<td>46686</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15154627416</td>
<td>50707</td>
<td>53266</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13722872673</td>
<td>84764</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">,</span><span class="w">   </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">level</span><span class="p">,</span><span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rootid</span><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w">   </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="k">c</span><span class="p">.</span><span class="n">rootid</span><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">path</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="k">level</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas_cte</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">datas</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><table>
<thead>
<tr>
<th>phone</th>
<th>id</th>
<th>pid</th>
<th>path</th>
<th>level</th>
<th>rootid</th>
</tr>
</thead>
<tbody>
<tr>
<td>15889121934</td>
<td>55701</td>
<td></td>
<td>[55701]</td>
<td>0</td>
<td>55701</td>
</tr>
<tr>
<td>15657298376</td>
<td>67272</td>
<td>55701</td>
<td>[55701,67272]</td>
<td>1</td>
<td>55701</td>
</tr>
<tr>
<td>13395855488</td>
<td>10960</td>
<td>67272</td>
<td>[55701,67272,10960]</td>
<td>2</td>
<td>55701</td>
</tr>
<tr>
<td>15834961213</td>
<td>47070</td>
<td>10960</td>
<td>[55701,67272,10960,47070]</td>
<td>3</td>
<td>55701</td>
</tr>
<tr>
<td>14580719766</td>
<td>78340</td>
<td>47070</td>
<td>[55701,67272,10960,47070,78340]</td>
<td>4</td>
<td>55701</td>
</tr>
<tr>
<td>18693044740</td>
<td>37775</td>
<td>78340</td>
<td>[55701,67272,10960,47070,78340,37775]</td>
<td>5</td>
<td>55701</td>
</tr>
<tr>
<td>18693044741</td>
<td>37775</td>
<td>78340</td>
<td>[55701,67272,10960,47070,78340,37775]</td>
<td>5</td>
<td>55701</td>
</tr>
<tr>
<td>18631569256</td>
<td>14280</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13807639997</td>
<td>15582</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13254675670</td>
<td>75663</td>
<td></td>
<td>[75663]</td>
<td>0</td>
<td>75663</td>
</tr>
<tr>
<td>18109707945</td>
<td>12959</td>
<td>75663</td>
<td>[75663,12959]</td>
<td>1</td>
<td>75663</td>
</tr>
<tr>
<td>15834961213</td>
<td>22099</td>
<td>12959</td>
<td>[75663,12959,22099]</td>
<td>2</td>
<td>75663</td>
</tr>
<tr>
<td>13918139598</td>
<td>22099</td>
<td>12959</td>
<td>[75663,12959,22099]</td>
<td>2</td>
<td>75663</td>
</tr>
<tr>
<td>18815083183</td>
<td>83540</td>
<td>22099</td>
<td>[75663,12959,22099,83540]</td>
<td>3</td>
<td>75663</td>
</tr>
<tr>
<td>13875678880</td>
<td>58053</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>15793943526</td>
<td>72534</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>18739688136</td>
<td>75579</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>13028479619</td>
<td>51390</td>
<td></td>
<td>[51390]</td>
<td>0</td>
<td>51390</td>
</tr>
<tr>
<td>13339189047</td>
<td>90300</td>
<td>51390</td>
<td>[51390,90300]</td>
<td>1</td>
<td>51390</td>
</tr>
<tr>
<td>15834961213</td>
<td>46686</td>
<td>90300</td>
<td>[51390,90300,46686]</td>
<td>2</td>
<td>51390</td>
</tr>
<tr>
<td>18073413108</td>
<td>53266</td>
<td>46686</td>
<td>[51390,90300,46686,53266]</td>
<td>3</td>
<td>51390</td>
</tr>
<tr>
<td>15154627416</td>
<td>50707</td>
<td>53266</td>
<td>[51390,90300,46686,53266,50707]</td>
<td>4</td>
<td>51390</td>
</tr>
<tr>
<td>13722872673</td>
<td>84764</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h3 id="第二步">第二步</h3>
<p>将相同rootid的level值最大的path列数组中的id转化为对应的phone,一个id对应多个phone的，使用<code>#</code>连接多个phone，此时path仍然为数组，
然后将path的数组元素用-&gt;连接，此时path为字符串类型。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 创建一个临时表，将每个id对应的所有电话号码用#连接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">STRING_AGG</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">phone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 找出每个 rootid 组里面 level 最大的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">max_level</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rootid</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="k">level</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">max_level_datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">max_level</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新这些记录的 path，将 id 替换为对应的电话号码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">updated_path</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">mld</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mld</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">ARRAY_TO_STRING</span><span class="p">(</span><span class="nb">ARRAY</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">phone</span><span class="p">::</span><span class="nb">TEXT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">FROM</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="n">mld</span><span class="p">.</span><span class="n">path</span><span class="p">::</span><span class="nb">INTEGER</span><span class="p">[])</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">JOIN</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">max_level_datas</span><span class="w"> </span><span class="n">mld</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">updated_path</span><span class="w"> </span><span class="n">up</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 删除临时表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="第三步">第三步</h3>
<p>将相同rootid的path列值设置为相同rootid且level值最大的path列的值。
要更新一个表中的一列的值，基于同一表中的其他行的值，你需要使用一个自连接。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">.</span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rootid</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="k">level</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">d3</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d1</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">.</span><span class="n">rootid</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>先创建一个子查询 d2，该查询对于每一个 rootid 找到对应 level 最大的 path。
然后，我们将原表 datas 更新为子查询 d2 中找到的 path。
这个查询假设 rootid 和 level 的组合是唯一的，也就是说，在同一 rootid 中，不可能有两行具有相同的最大 level 值。如果这不是你的情况，你可能需要对查询进行进一步的调整以处理这种情况。</p>
<h3 id="以上三步的完整代码">以上三步的完整代码</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--CREATE TABLE datas AS SELECT * FROM &#39;C:\Users\xxx\Desktop\tree.csv&#39;;
</span></span></span><span class="line"><span class="cl"><span class="c1">--ALTER table datas ADD COLUMN path varchar DEFAULT null;
</span></span></span><span class="line"><span class="cl"><span class="c1">--ALTER table datas ADD COLUMN rootid varchar DEFAULT null;
</span></span></span><span class="line"><span class="cl"><span class="c1">--ALTER table datas ADD COLUMN level int DEFAULT null;
</span></span></span><span class="line"><span class="cl"><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 创建一个递归查询来获取每一行的根节点、路径和级别
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">pid</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">level</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">],</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">path</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="k">level</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas_cte</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">datas</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="o">=</span><span class="k">null</span><span class="p">,</span><span class="k">level</span><span class="o">=</span><span class="k">null</span><span class="p">,</span><span class="n">rootid</span><span class="o">=</span><span class="k">null</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 找出rootid个数大于1的所有记录，即树形节点大于1的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">HAVING</span><span class="w"> </span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 创建一个中间表，将每个id对应的所有电话号码用#连接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">STRING_AGG</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">phone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新路径，将id替换为对应的电话号码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="k">RECURSIVE</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">phone</span><span class="p">::</span><span class="nb">TEXT</span><span class="p">]</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="mi">0</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">level</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">WHERE</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">UNION</span><span class="w"> </span><span class="k">ALL</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nb">ARRAY</span><span class="p">[</span><span class="n">t</span><span class="p">.</span><span class="n">phone</span><span class="p">::</span><span class="nb">TEXT</span><span class="p">],</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">c</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">datas_cte</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ARRAY_TO_STRING</span><span class="p">(</span><span class="n">datas_cte</span><span class="p">.</span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;-&gt;&#39;</span><span class="p">),</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="k">level</span><span class="p">,</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas_cte</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">datas</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas_cte</span><span class="p">.</span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 删除临时表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 将level值最大的path列数组中的id替换成phone
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 创建一个临时表，将每个id对应的所有电话号码用#连接起来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">CREATE</span><span class="w"> </span><span class="n">TEMP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="k">AS</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SELECT</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">STRING_AGG</span><span class="p">(</span><span class="n">phone</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;#&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">phone</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 找出每个 rootid 组里面 level 最大的记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">WITH</span><span class="w"> </span><span class="n">max_level</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rootid</span><span class="p">,</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="k">level</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="k">level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">max_level_datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="o">*</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">JOIN</span><span class="w"> </span><span class="n">max_level</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="k">level</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">),</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 更新这些记录的 path，将 id 替换为对应的电话号码
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">updated_path</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">SELECT</span><span class="w"> </span><span class="n">mld</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">mld</span><span class="p">.</span><span class="n">pid</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="n">ARRAY_TO_STRING</span><span class="p">(</span><span class="nb">ARRAY</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">SELECT</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">phone</span><span class="p">::</span><span class="nb">TEXT</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">FROM</span><span class="w"> </span><span class="k">unnest</span><span class="p">(</span><span class="n">mld</span><span class="p">.</span><span class="n">path</span><span class="p">::</span><span class="nb">INTEGER</span><span class="p">[])</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">           </span><span class="k">JOIN</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;-&gt;&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="k">FROM</span><span class="w"> </span><span class="n">max_level_datas</span><span class="w"> </span><span class="n">mld</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="n">d</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="n">updated_path</span><span class="w"> </span><span class="n">up</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">up</span><span class="p">.</span><span class="n">pid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 删除临时表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">DROP</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">temp_id_phone</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span><span class="line"><span class="cl"><span class="c1">--将rootid相同的所有行的path设置为：rootid相同的对应level列值最大的对应的path的值。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">UPDATE</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">SET</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">.</span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">rootid</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="k">WHERE</span><span class="w"> </span><span class="k">level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">SELECT</span><span class="w"> </span><span class="k">MAX</span><span class="p">(</span><span class="k">level</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">FROM</span><span class="w"> </span><span class="n">datas</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="k">WHERE</span><span class="w"> </span><span class="n">d3</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datas</span><span class="p">.</span><span class="n">rootid</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">WHERE</span><span class="w"> </span><span class="n">d1</span><span class="p">.</span><span class="n">rootid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2</span><span class="p">.</span><span class="n">rootid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">---------------------------------------------------------------------------
</span></span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-05-29</span>
            </div><div class="post-info-license">
                <span>false</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="DuckDB学习笔记" data-hashtags="DuckDB,数据库"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-hashtag="DuckDB"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="DuckDB学习笔记"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="DuckDB学习笔记"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/duckdb%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" data-title="DuckDB学习笔记"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/duckdb/">DuckDB</a>,&nbsp;<a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/naiveproxy%E6%90%AD%E5%BB%BA%E8%BF%87%E7%A8%8B%E8%AE%B0%E5%BD%95/" class="prev" rel="prev" title="NaiveProxy搭建过程记录"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>NaiveProxy搭建过程记录</a>
            <a href="/%E5%85%B3%E8%81%94%E5%88%86%E6%9E%90/" class="next" rel="next" title="关联分析">关联分析<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.115.4">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":30},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
