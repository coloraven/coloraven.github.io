<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>How to use Flask with gevent (uWSGI and Gunicorn editions) - ÊàëÁöÑÂÖ®Êñ∞ Hugo ÁΩëÁ´ô</title><meta name="Description" content="ËøôÊòØÊàëÁöÑÂÖ®Êñ∞ Hugo ÁΩëÁ´ô"><meta property="og:title" content="How to use Flask with gevent (uWSGI and Gunicorn editions)" />
<meta property="og:description" content="Êù•Ê∫êÔºöhttps://iximiuz.com/en/posts/flask-gevent-tutorial/
Disclaimer: I wrote this tutorial because gevent saved our project a few years ago and I still see steady gevent-related search traffic on my blog. So, the way gevent helped us may be useful for somebody else as well. Since I still have some handy knowledge I decided to make this note on how to set up things. However, I&rsquo;d not advise starting a new project in 2020 using this technology." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-08T21:50:15+00:00" />
<meta property="article:modified_time" content="2023-07-27T22:11:35+08:00" /><meta property="og:site_name" content="ÊàëÁöÑÁΩëÁ´ô" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="How to use Flask with gevent (uWSGI and Gunicorn editions)"/>
<meta name="twitter:description" content="Êù•Ê∫êÔºöhttps://iximiuz.com/en/posts/flask-gevent-tutorial/
Disclaimer: I wrote this tutorial because gevent saved our project a few years ago and I still see steady gevent-related search traffic on my blog. So, the way gevent helped us may be useful for somebody else as well. Since I still have some handy knowledge I decided to make this note on how to set up things. However, I&rsquo;d not advise starting a new project in 2020 using this technology."/>
<meta name="application-name" content="ÊàëÁöÑÁΩëÁ´ô">
<meta name="apple-mobile-web-app-title" content="ÊàëÁöÑÁΩëÁ´ô"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" /><link rel="prev" href="http://example.org/web%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BAleancloud/" /><link rel="next" href="http://example.org/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0python%E4%BE%9D%E8%B5%96%E5%8C%85%E5%AE%89%E8%A3%85%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "How to use Flask with gevent (uWSGI and Gunicorn editions)",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions\/"
        },"genre": "posts","keywords": "Python, Flask","wordcount":  3996 ,
        "url": "http:\/\/example.org\/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions\/","datePublished": "2021-11-08T21:50:15+00:00","dateModified": "2023-07-27T22:11:35+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "‰∫îÂΩ©ÊñëÊñìÁöÑÈªë"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="ÊàëÁöÑÂÖ®Êñ∞ Hugo ÁΩëÁ´ô"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> ÊñáÁ´† </a><a class="menu-item" href="/tags/"> Ê†áÁ≠æ </a><a class="menu-item" href="/categories/"> ÂàÜÁ±ª </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="ÊàëÁöÑÂÖ®Êñ∞ Hugo ÁΩëÁ´ô"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">ÊñáÁ´†</a><a class="menu-item" href="/tags/" title="">Ê†áÁ≠æ</a><a class="menu-item" href="/categories/" title="">ÂàÜÁ±ª</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">How to use Flask with gevent (uWSGI and Gunicorn editions)</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>‰∫îÂΩ©ÊñëÊñìÁöÑÈªë</a></span>&nbsp;<span class="post-category">included in <a href="/categories/python/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-11-08">2021-11-08</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;3996 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;19 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#when-do-i-need-asynchronous-io">When do I need asynchronous I/O</a></li>
    <li><a href="#what-is-gevent">What is gevent</a></li>
    <li><a href="#create-simple-flask-application">Create simple Flask application</a></li>
    <li><a href="#deploy-flask-application-using-flask-dev-server">Deploy Flask application using Flask dev server</a></li>
    <li><a href="#deploy-flask-application-using-geventpywsgi">Deploy Flask application using gevent.pywsgi</a></li>
    <li><a href="#deploy-flask-application-using-gunicorn">Deploy Flask application using Gunicorn</a></li>
    <li><a href="#deploy-flask-application-using-uwsgi">Deploy Flask application using uWSGI</a></li>
    <li><a href="#use-nginx-reverse-proxy-in-front-of-application-server">Use Nginx reverse proxy in front of application server</a>
      <ul>
        <li><a href="#nginx--gunicorn--gevent">Nginx + Gunicorn + gevent</a></li>
        <li><a href="#nginx--uwsgi--gevent">Nginx + uWSGI + gevent</a></li>
      </ul>
    </li>
    <li><a href="#bonus-make-psycopg2-gevent-friendly-with-psycogreen">Bonus: make psycopg2 gevent-friendly with psycogreen</a></li>
    <li><a href="#instead-of-conclusion">Instead of conclusion</a></li>
    <li><a href="#related-articles">Related articles</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><p>Êù•Ê∫êÔºöhttps://iximiuz.com/en/posts/flask-gevent-tutorial/</p>
<p>Disclaimer: I wrote this tutorial because gevent <a href="https://iximiuz.com/en/posts/save-the-day-with-gevent/" target="_blank" rel="noopener noreffer ">saved our project a few years ago</a> and I still see steady gevent-related search traffic on my blog. So, the way gevent helped us may be useful for somebody else as well. Since I still have some handy knowledge I decided to make this note on how to set up things. However, I&rsquo;d not advise starting a new project in 2020 using this technology. IMHO, it&rsquo;s aging and losing the traction._</p>
<p><em><strong>TL;DR: check out code samples <a href="https://github.com/iximiuz/flask-gevent-tutorial" target="_blank" rel="noopener noreffer ">on GitHub</a>.</strong></em></p>
<p><a href="https://trends.google.com/trends/explore?date=all&amp;q=%2Fm%2F05z1_" target="_blank" rel="noopener noreffer ">Python is booming</a> and Flask is a pretty popular web-framework nowadays. Probably, quite some new projects are being started in Flask. But people should be aware, <a href="https://github.com/pallets/flask/issues/3339" target="_blank" rel="noopener noreffer ">it&rsquo;s synchronous by design</a> and <a href="https://asgi.readthedocs.io/en/latest/" target="_blank" rel="noopener noreffer ">ASGI</a> is <a href="https://github.com/pallets/werkzeug/issues/1322" target="_blank" rel="noopener noreffer ">not a thing yet</a>. So, if someday you realize that your project really needs asynchronous I/O but you already have a considerable codebase on top of Flask, this tutorial is for you. The charming <a href="http://www.gevent.org/" target="_blank" rel="noopener noreffer ">gevent</a> library will enable you to keep using Flask while start benefiting from all the I/O being asynchronous. In the tutorial we will see:</p>
<ul>
<li>How to monkey patch a Flask app to make it asynchronous w/o changing its code.</li>
<li>How to run the patched application using <a href="http://www.gevent.org/api/gevent.pywsgi.html" target="_blank" rel="noopener noreffer ">gevent.pywsgi</a> application server.</li>
<li>How to run the patched application using <a href="https://gunicorn.org/" target="_blank" rel="noopener noreffer ">Gunicorn</a> application server.</li>
<li>How to run the patched application using <a href="https://uwsgi-docs.readthedocs.io/en/latest/index.html" target="_blank" rel="noopener noreffer ">uWSGI</a> application server.</li>
<li>How to configure <a href="https://nginx.org/" target="_blank" rel="noopener noreffer ">Nginx</a> proxy in front of the application server.</li>
<li>[Bonus] How to use <a href="https://github.com/psycopg/psycopg2" target="_blank" rel="noopener noreffer ">psycopg2</a> with <a href="https://bitbucket.org/dvarrazzo/psycogreen/" target="_blank" rel="noopener noreffer ">psycogreen</a> to make PostgreSQL access non-blocking.</li>
</ul>
<h2 id="when-do-i-need-asynchronous-io">When do I need asynchronous I/O</h2>
<p>The answer is somewhat naive - you need it when the application&rsquo;s workload is I/O bound, i.e. it maxes out on <a href="https://landing.google.com/sre/sre-book/chapters/service-level-objectives/" target="_blank" rel="noopener noreffer ">latency SLI</a> due to over-communicating to external services. It&rsquo;s a pretty common situation nowadays due to the enormous spread of microservice architectures and various 3rd-party APIs. If an average HTTP handler in your application needs to make 10+ network requests to build a response, it&rsquo;s <em>highly likely</em> that you will benefit from asynchronous I/O. On the other hand, if your application consumes 100% of CPU or RAM handling requests, migrating to asynchronous I/O <em>probably</em> will not help.</p>
<h2 id="what-is-gevent">What is gevent</h2>
<p>From <a href="http://www.gevent.org/" target="_blank" rel="noopener noreffer ">the official site</a> description:</p>
<blockquote>
<p>gevent is a coroutine-based Python networking library that uses greenlet to provide a high-level synchronous API on top of the libev or libuv event loop.</p>
</blockquote>
<p>The description is rather obscure for those who are unfamiliar with the mentioned dependencies like <em>greenlet</em>, <em>libev</em>, or <em>libuv</em>. You can check out <a href="https://iximiuz.com/en/posts/save-the-day-with-gevent/#solving-problem-with-zero-lines-of-code" target="_blank" rel="noopener noreffer ">my previous attempt to briefly explain the nature of this library</a>, but among other things it allows you to <a href="https://en.wikipedia.org/wiki/Monkey_patch" target="_blank" rel="noopener noreffer ">monkey patch</a> normal-looking Python code and make the underlying I/O happening asynchronously. The patching introduces what&rsquo;s called <a href="https://en.wikipedia.org/wiki/Cooperative_multitasking" target="_blank" rel="noopener noreffer ">cooperative multitasking</a> into the Python standard library and some 3rd-party modules but the change stays almost completely hidden from the application and the existing code keeps its synchronous-alike outlook while gains the ability to serve requests asynchronously. There is an obvious downside of this approach - the patching doesn&rsquo;t change the way every single HTTP request is being served, i.e. the I/O within each HTTP handler still happens sequentially, even though it becomes asynchronous. Well, we can start using <a href="http://www.gevent.org/api/gevent.html#gevent.wait" target="_blank" rel="noopener noreffer ">something similar</a> to <a href="https://docs.python.org/3/library/asyncio-task.html#asyncio.gather" target="_blank" rel="noopener noreffer ">asyncio.gather()</a> and parallelize some requests to external resources, but it would require the modification of the existing application code. However, now we can easily scale up the limit of concurrent HTTP requests for our application. After the patching, we don&rsquo;t need a dedicated thread (or process) per request anymore. Instead, each request handling now happens in a lightweight green thread. Thus, the application can serve tens of thousands of concurrent requests, probably increasing this number by 1-2 orders of magnitude from the previous limit.</p>
<p>However, while the description sounds extremely promising (at least to me), the project and the surrounding eco-system is steadily losing traction (in favor of <em>asyncio</em> and <em>aiohttp</em>?):</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png" /></p>
<h2 id="create-simple-flask-application">Create simple Flask application</h2>
<p>The standard tutorial format always seemed boring to me. Instead, we will try to make a tiny playground here. We will try to create a simple Flask application dependant on a sleepy 3rd party API endpoint. The only route of our application will be responding with some hard-coded string concatenated with the API response text. Having such a workload, we will play with different methods of achieving high concurrency in the Flask&rsquo;s handling of HTTP requests.</p>
<p>First, we need to emulate <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/slow_api/api.py" target="_blank" rel="noopener noreffer ">a slow 3rd party API</a>. We will use <a href="https://aiohttp.readthedocs.io/en/stable/" target="_blank" rel="noopener noreffer ">aiohttp</a> to implement it because it&rsquo;s based on the <a href="https://docs.python.org/3/library/asyncio.html" target="_blank" rel="noopener noreffer ">asyncio</a> library and provides high concurrency for I/O-bound HTTP requests handling out of the box:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./slow_api/api.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">aiohttp</span> <span class="kn">import</span> <span class="n">web</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">web</span><span class="o">.</span><span class="n">Response</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="s1">&#39;slow api response&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">web</span><span class="o">.</span><span class="n">Application</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">app</span><span class="o">.</span><span class="n">add_routes</span><span class="p">([</span><span class="n">web</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="n">handle</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">web</span><span class="o">.</span><span class="n">run_app</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PORT&#39;</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can launch it in the following <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/slow_api/Dockerfile" target="_blank" rel="noopener noreffer ">Docker container</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./slow_api/Dockerfile</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install aiohttp<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> api.py /api.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> <span class="p">[</span><span class="s2">&#34;python&#34;</span><span class="p">,</span> <span class="s2">&#34;/api.py&#34;</span><span class="p">]</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Now, it&rsquo;s time to create <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/app.py" target="_blank" rel="noopener noreffer ">the target Flask application</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./flask_app/app.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">api_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PORT_API&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://slow_api:</span><span class="si">{</span><span class="n">api_port</span><span class="si">}</span><span class="s1">/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s1">?delay=</span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hi there! &#39;</span> <span class="o">+</span> <span class="n">resp</span><span class="o">.</span><span class="n">text</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As promised, it&rsquo;s fairly simple.</p>
<h2 id="deploy-flask-application-using-flask-dev-server">Deploy Flask application using Flask dev server</h2>
<p>The easiest way to run a Flask application is to use <a href="https://flask.palletsprojects.com/en/1.1.x/server/" target="_blank" rel="noopener noreffer ">a built-in development server</a>. But even this beast supports two modes of request handling.</p>
<p>In the <em>single-threaded mode</em>, a Flask application can handle no more than one HTTP request at a time. I.e. the request handling becomes sequential.</p>
<p>Experience ü§¶</p>
<pre><code>This mode can be dangerous. If an application needs to send a request to itself it may get stuck in a deadlock.
</code></pre>
<p>In the <em>multi-threaded mode</em>, Flask spawns a thread for every incoming HTTP request. The maximal concurrency, i.e. the highest possible number of simultaneous threads doesn&rsquo;t seem configurable though.</p>
<p>We will use <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-devserver" target="_blank" rel="noopener noreffer ">the following Dockerfile</a> to run the Flask dev server:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-devserver</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">ENV</span> <span class="nv">FLASK_APP</span><span class="o">=</span>app
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">CMD</span> flask run --no-reload <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --<span class="nv">$THREADS</span>-threads <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --host 0.0.0.0 --port <span class="nv">$PORT_APP</span><span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s spin up <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/sync-devserver.yml" target="_blank" rel="noopener noreffer ">the first playground</a> using handy <a href="https://docs.docker.com/compose/" target="_blank" rel="noopener noreffer ">Docker Compose</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./sync-devserver.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-devserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">THREADS=without</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app_threaded: # extends</span><span class="p">:</span><span class="w"> </span><span class="l">flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-devserver</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">THREADS=with</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3001:3001&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>After running <code>docker-compose build</code> and <code>docker-compose up</code> we will have two instances of our application running. The single-threaded version is bound to the host&rsquo;s <code>127.0.0.1:3000</code>, the multi-threaded - to <code>127.0.0.1:3001</code>.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by Flask dev server</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-devserver.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-devserver.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>It&rsquo;s time to serve the first portion of HTTP requests (using lovely <a href="https://en.wikipedia.org/wiki/ApacheBench" target="_blank" rel="noopener noreffer ">ApacheBench</a>). We will start from the single-threaded version and only 10 requests:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Test single-threaded deployment</span>
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">10</span> -c <span class="m">5</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">5</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   10.139 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">10</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    0.99 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As expected, we observed no concurrency. Even though we asked <code>ab</code> to simulate 5 simultaneous clients using <code>-c 5</code>, it took ~10 seconds to finish the scenario with an effective request rate close to 1 per second.</p>
<p>If you execute <code>top -H</code> in the server container to check the number of running threads, the picture will be similar to this:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H</em></p>
<p>Let&rsquo;s proceed to the multi-threaded version alongside with increasing the payload up to 2000 requests being produced by 200 simultaneous clients:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Test multi-threaded deployment</span>
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3001/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   16.040 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    124.69 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The effective concurrency grew to the mean of 124 requests per second, but a sample from <code>top -H</code> shows, that at some point of time we had 192 threads and 190 of them were sleeping:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_threaded_1 top -H</em></p>
<h2 id="deploy-flask-application-using-geventpywsgi">Deploy Flask application using gevent.pywsgi</h2>
<p>The fastest way to unleash the power of gevent is to use its built-in <a href="https://en.wikipedia.org/wiki/Web_Server_Gateway_Interface" target="_blank" rel="noopener noreffer ">WSGI-server</a> called <a href="http://www.gevent.org/api/gevent.pywsgi.html" target="_blank" rel="noopener noreffer ">gevent.pywsgi</a>.</p>
<p>We need to create <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/pywsgi.py" target="_blank" rel="noopener noreffer ">an entrypoint</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./flask_app/pywsgi.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
</span></span><span class="line"><span class="cl"><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gevent.pywsgi</span> <span class="kn">import</span> <span class="n">WSGIServer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">http_server</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PORT_APP&#39;</span><span class="p">])),</span> <span class="n">app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">http_server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice, how it patches our Flask application. Without <code>monkey.patch_all()</code> there would be no benefit from using gevent here because all the I/O in the application stayed synchronous.</p>
<p>The following <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-gevent-pywsgi" target="_blank" rel="noopener noreffer ">Dockerfile</a> can be used to run the pywsgi server:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-gevent-pywsgi</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests gevent<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> pywsgi.py /pywsgi.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> python /pywsgi.py<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Finally, let&rsquo;s prepare <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/async-gevent-pywsgi.yml" target="_blank" rel="noopener noreffer ">the following playground</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./async-gevent-pywsgi.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gevent-pywsgi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">THREADS=without</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And launch it using:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by gevent.pywsgi</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-pywsgi.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-pywsgi.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>We expect a decent concurrency level with very few threads (if any) in the server container:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   17.536 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    114.05 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Executing <code>top -H</code> shows that we DO have some python threads (around 10). Seems like gevent employs a thread pool to implement the asynchronous I/O:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H</em></p>
<h2 id="deploy-flask-application-using-gunicorn">Deploy Flask application using Gunicorn</h2>
<p>Gunicorn is <a href="https://flask.palletsprojects.com/en/1.1.x/deploying/wsgi-standalone/#gunicorn" target="_blank" rel="noopener noreffer ">one of the recommended ways</a> to run Flask applications. We will start from Gunicorn because it has slightly fewer parameters to configure before going than uWSGI.</p>
<p>Gunicorn <a href="https://docs.gunicorn.org/en/stable/design.html#server-model" target="_blank" rel="noopener noreffer ">uses the worker process model</a> to serve HTTP requests. But there are multiple types of workers: <a href="https://docs.gunicorn.org/en/stable/design.html#sync-workers" target="_blank" rel="noopener noreffer ">synchronous</a>, <a href="https://docs.gunicorn.org/en/stable/design.html#async-workers" target="_blank" rel="noopener noreffer ">asynchronous</a>, <a href="https://docs.gunicorn.org/en/stable/design.html#tornado-workers" target="_blank" rel="noopener noreffer ">tornado workers</a>, and <a href="https://docs.gunicorn.org/en/stable/design.html#asyncio-workers" target="_blank" rel="noopener noreffer ">asyncio workers</a>.</p>
<p>In this tutorial, we will cover only the first two types - synchronous and gevent-based asynchronous workers. Let&rsquo;s start from <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-gunicorn" target="_blank" rel="noopener noreffer ">the synchronous model</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-gunicorn</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests gunicorn<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> gunicorn --workers <span class="nv">$WORKERS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --threads <span class="nv">$THREADS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --bind 0.0.0.0:<span class="nv">$PORT_APP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  app:app<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Notice that we reuse the original <code>app.py</code> entrypoint without any changes. The <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/sync-gunicorn.yml" target="_blank" rel="noopener noreffer ">synchronous Gunicorn playground</a> looks as follows:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./sync-gunicorn.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app_gunicorn</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gunicorn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">THREADS=50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s build and start the server using 4 workers x 50 threads each (i.e. 200 threads in total):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by Gunicorn</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-gunicorn.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-gunicorn.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>Obviously, we expect a high number of requests being served concurrently:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   13.427 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    148.95 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But if we compare the samples from <code>top -H</code> before and after the test, we can notice an interesting detail:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (before test)</em></p>
<p>Gunicorn starts workers on the startup, but the workers spawn the threads on-demand:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (during test)</em></p>
<p>Now, let&rsquo;s switch to gevent workers. For this setup we need to make <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/patched.py" target="_blank" rel="noopener noreffer ">a new entrypoint</a> to apply the monkey patching:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./flask_app/patched.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
</span></span><span class="line"><span class="cl"><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span> <span class="c1"># we need to patch very early</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># re-export</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-gevent-gunicorn" target="_blank" rel="noopener noreffer ">The Dockerfile</a> to run Gunicorn + gevent:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-gevent-gunicorn</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests gunicorn gevent<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> patched.py /patched.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> gunicorn --worker-class gevent <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --workers <span class="nv">$WORKERS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --bind 0.0.0.0:<span class="nv">$PORT_APP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  patched:app<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/async-gevent-gunicorn.yml" target="_blank" rel="noopener noreffer ">The playground</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./async-gevent-gunicorn.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gevent-gunicorn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s start it:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by Gunicorn + gevent</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-gunicorn.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-gunicorn.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>And conduct the test:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   17.839 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    112.11 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We observe similar behavior - only worker processes are alive before the test:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (before test)</em></p>
<p>But during the test, we see 10 new threads spawned. Notice, how it resembles the number of threads used by pywsgi:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (during test)</em></p>
<h2 id="deploy-flask-application-using-uwsgi">Deploy Flask application using uWSGI</h2>
<p><a href="https://flask.palletsprojects.com/en/1.1.x/deploying/wsgi-standalone/#uwsgi" target="_blank" rel="noopener noreffer ">uWSGI</a> is a production-grade application server written in C. It&rsquo;s very fast and supports different execution models. Here we will again compare only two modes: synchronous (N worker processes x K threads each) and gevent-based (N worker processes x M async cores each).</p>
<p>First, <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-uwsgi" target="_blank" rel="noopener noreffer ">the synchronous setup</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-uwsgi</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests uwsgi<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> uwsgi --master <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --workers <span class="nv">$WORKERS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --threads <span class="nv">$THREADS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --protocol <span class="nv">$PROTOCOL</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --socket 0.0.0.0:<span class="nv">$PORT_APP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --module app:app<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We use an extra parameters <code>--protocol</code> and <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/sync-uwsgi.yml" target="_blank" rel="noopener noreffer ">the playground</a> sets it to <code>http</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./sync-uwsgi.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app_uwsgi</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-uwsgi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">THREADS=50</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PROTOCOL=http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We again limit the concurrency by 200 simultaneous HTTP requests (4 workers x 50 threads each):</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by uWSGI</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-uwsgi.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f sync-uwsgi.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s send a bunch of HTTP requests:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">200</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   12.685 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    157.67 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>uWSGI spaws workers and threads beforehand:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_uwsgi_1 top -H (before test)</em></p>
<p>So, only the load changes during the test:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_uwsgi_1 top -H (during test)</em></p>
<p>Let&rsquo;s proceed to <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/Dockerfile-gevent-uwsgi" target="_blank" rel="noopener noreffer ">the gevent mode</a>. We can reuse the <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/patched.py" target="_blank" rel="noopener noreffer "><code>patched.py</code></a> entrypoint from the Gunicorn+gevent scenario:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./flask_app/Dockerfile-gevent-uwsgi</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests uwsgi gevent<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> patched.py /patched.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> uwsgi --master <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --single-interpreter <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --workers <span class="nv">$WORKERS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --gevent <span class="nv">$ASYNC_CORES</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --protocol <span class="nv">$PROTOCOL</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --socket 0.0.0.0:<span class="nv">$PORT_APP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --module patched:app<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>One extra parameter <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/async-gevent-uwsgi.yml" target="_blank" rel="noopener noreffer ">the playground</a> sets here is <a href="https://uwsgi-docs.readthedocs.io/en/latest/Gevent.html#running-uwsgi-in-gevent-mode" target="_blank" rel="noopener noreffer ">the number of async cores</a> used by gevent:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./async-gevent-uwsgi.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gevent-uwsgi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ASYNC_CORES=2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PROTOCOL=http</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Let&rsquo;s start the uWSGI+gevent server:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># Build and start app served by uWSGI + gevent</span>
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-uwsgi.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f async-gevent-uwsgi.yml up
</span></span></code></pre></td></tr></table>
</div>
</div><p>And do the test:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   13.164 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">2000</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    151.93 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>However, if we check the number of workers before and during the test we will notice a discrepancy with the previous method:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H (before test)</em></p>
<p>Before the test, uWSGI had the master and worker processes only, but during the test, threads were started, somewhat around 10 threads per worker process. This number resembles the numbers from gevent.pywsgi and Gunicorn+gevent cases:</p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png"
        data-srcset="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png 1.5x, https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png 2x"
        data-sizes="auto"
        alt="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png"
        title="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png" /></p>
<p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H (during test)</em></p>
<h2 id="use-nginx-reverse-proxy-in-front-of-application-server">Use Nginx reverse proxy in front of application server</h2>
<p>Usually, uWSGI and Gunicorn servers reside behind a load balancer and one of the most popular choices is Nginx.</p>
<h3 id="nginx--gunicorn--gevent">Nginx + Gunicorn + gevent</h3>
<p><a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/nginx-gunicorn.conf" target="_blank" rel="noopener noreffer ">Nginx configuration</a> for Gunicorn upstream is just a standard proxy setup:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="c1"># ./flask_app/nginx-gunicorn.conf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">Host</span> <span class="nv">$http_host</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Real-IP</span> <span class="nv">$remote_addr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-For</span> <span class="nv">$proxy_add_x_forwarded_for</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_set_header</span> <span class="s">X-Forwarded-Proto</span> <span class="nv">$scheme</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kn">proxy_pass</span> <span class="s">http://flask_app:3000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We can try it out using <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/nginx-gunicorn.yml" target="_blank" rel="noopener noreffer ">the following playground</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./nginx-gunicorn.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:8080:80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./flask_app/nginx-gunicorn.conf:/etc/nginx/conf.d/default.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gevent-gunicorn</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And then:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker-compose -f nginx-gunicorn.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f nginx-gunicorn.yml up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:8080/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; ...
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="nginx--uwsgi--gevent">Nginx + uWSGI + gevent</h3>
<p>uWSGI setup is very similar, but there is a subtle improvement. uWSGI provides a special binary protocol (called uWSGI) to communicate with the reverse proxy in front of it. This makes the joint slightly more efficient. And Nginx kindly <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/nginx-uwsgi.conf" target="_blank" rel="noopener noreffer ">supports it</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-nginx" data-lang="nginx"><span class="line"><span class="cl"><span class="c1"># ./flask_app/nginx-uwsgi.conf
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">server</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kn">include</span> <span class="s">uwsgi_params</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kn">uwsgi_pass</span> <span class="s">uwsgi://flask_app:3000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Notice the environment variable <code>PROTOCOL=uwsgi</code> in <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/nginx-uwsgi.yml" target="_blank" rel="noopener noreffer ">the following playground</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./nginx-uwsgi.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ingress</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">nginx:1.17.6</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:8080:80&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">./flask_app/nginx-uwsgi.conf:/etc/nginx/conf.d/default.conf</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./flask_app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile-gevent-uwsgi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ASYNC_CORES=2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PROTOCOL=uwsgi</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>We can test the playground using:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker-compose -f nginx-uwsgi.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f nginx-uwsgi.yml up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">2000</span> -c <span class="m">200</span> http://127.0.0.1:8080/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; ...
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bonus-make-psycopg2-gevent-friendly-with-psycogreen">Bonus: make psycopg2 gevent-friendly with psycogreen</h2>
<p>When asked, gevent patches only modules from the Python standard library. If we use 3rd party modules, like psycopg2, corresponding IO will remain blocking. Let&rsquo;s consider the following application:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./psycopg2/app.py</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">gevent</span> <span class="kn">import</span> <span class="n">monkey</span>
</span></span><span class="line"><span class="cl"><span class="n">monkey</span><span class="o">.</span><span class="n">patch_all</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">psycopg2</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">requests</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">api_port</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;PORT_API&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">api_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;http://slow_api:</span><span class="si">{</span><span class="n">api_port</span><span class="si">}</span><span class="s1">/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@app.route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&#34;example&#34;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s2">&#34;example&#34;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&#34;postgres&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">delay</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;delay&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">api_url</span><span class="si">}</span><span class="s1">?delay=</span><span class="si">{</span><span class="n">delay</span><span class="o">/</span><span class="mi">2</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT NOW(), pg_sleep(</span><span class="si">%s</span><span class="s2">)&#34;</span><span class="p">,</span> <span class="p">(</span><span class="n">delay</span><span class="o">/</span><span class="mi">2</span><span class="p">,))</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="s1">&#39;Hi there! </span><span class="si">{}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>We extended the workload by adding intentionally slow database access. Let&rsquo;s prepare <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/psycopg2/Dockerfile" target="_blank" rel="noopener noreffer ">the Dockerfile</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dockerfile" data-lang="dockerfile"><span class="line"><span class="cl"><span class="c"># ./psycopg2/Dockerfile</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">FROM</span><span class="s"> python:3.8</span><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">RUN</span> pip install Flask requests psycopg2 psycogreen uwsgi gevent<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> app.py /app.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">COPY</span> patched.py /patched.py<span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err">
</span></span></span><span class="line"><span class="cl"><span class="err"></span><span class="k">CMD</span> uwsgi --master <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --single-interpreter <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --workers <span class="nv">$WORKERS</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --gevent <span class="nv">$ASYNC_CORES</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --protocol http <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --socket 0.0.0.0:<span class="nv">$PORT_APP</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  --module <span class="nv">$MODULE</span>:app<span class="err">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>And <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/bonus-psycopg2-gevent.yml" target="_blank" rel="noopener noreffer ">the playground</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./bonus-psycopg2-gevent.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s2">&#34;3.7&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./psycopg2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ASYNC_CORES=2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">MODULE=app</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3000:3000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">slow_api</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w"> </span><span class="l">./slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;4000&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">postgres</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">postgres</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">POSTGRES_USER</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">POSTGRES_PASSWORD</span><span class="p">:</span><span class="w"> </span><span class="l">example</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">expose</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;5432&#34;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Ideally, we expect ~2 seconds to perform 10 one-second-long HTTP requests with concurrency 5. But the test shows more than 6 seconds due to the blocking behavior of psycopg2 calls:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker-compose -f bonus-psycopg2-gevent.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f bonus-psycopg2-gevent.yml up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">10</span> -c <span class="m">5</span> http://127.0.0.1:3000/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">5</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   6.670 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">10</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    1.50 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>To bypass this limitation, we need to use <a href="https://bitbucket.org/dvarrazzo/psycogreen/" target="_blank" rel="noopener noreffer ">psycogreen</a> module to patch psycopg2:</p>
<blockquote>
<p>The psycogreen package enables psycopg2 to work with coroutine libraries, using asynchronous calls internally but offering a blocking interface so that regular code can run unmodified. Psycopg offers coroutines support since release 2.2. Because the main module is a C extension it cannot be monkey-patched to become coroutine-friendly. Instead it exposes a hook that coroutine libraries can use to install a function integrating with their event scheduler. Psycopg will call the function whenever it executes a libpq call that may block. psycogreen is a collection of &ldquo;wait callbacks&rdquo; useful to integrate Psycopg with different coroutine libraries.</p>
</blockquote>
<p>Let&rsquo;s create <a href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/psycopg2/patched.py" target="_blank" rel="noopener noreffer ">an entrypoint</a>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># ./psycopg2/patched.py</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">psycogreen.gevent</span> <span class="kn">import</span> <span class="n">patch_psycopg</span>
</span></span><span class="line"><span class="cl"><span class="n">patch_psycopg</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">app</span> <span class="kn">import</span> <span class="n">app</span>  <span class="c1"># re-export</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>And extend the playground:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="c"># ./bonus-psycopg2-gevent.yml</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">services</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c"># ...</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flask_app_2</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">init</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">build</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l">./psycopg2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l">Dockerfile</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">environment</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_APP=3001</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">PORT_API=4000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">WORKERS=1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">ASYNC_CORES=2000</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">MODULE=patched</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="s2">&#34;127.0.0.1:3001:3001&#34;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">slow_api</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="l">postgres</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>If we test the new instance of the application with <code>ab -n 10 -c 5</code>, the observed performance will be much close to the theoretical one:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ docker-compose -f bonus-psycopg2-gevent.yml build
</span></span><span class="line"><span class="cl">$ docker-compose -f bonus-psycopg2-gevent.yml up
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ ab -r -n <span class="m">10</span> -c <span class="m">5</span> http://127.0.0.1:3001/?delay<span class="o">=</span><span class="m">1</span>
</span></span><span class="line"><span class="cl">&gt; Concurrency Level:      <span class="m">5</span>
</span></span><span class="line"><span class="cl">&gt; Time taken <span class="k">for</span> tests:   3.148 seconds
</span></span><span class="line"><span class="cl">&gt; Complete requests:      <span class="m">10</span>
</span></span><span class="line"><span class="cl">&gt; Failed requests:        <span class="m">0</span>
</span></span><span class="line"><span class="cl">&gt; Requests per second:    3.18 <span class="o">[</span><span class="c1">#/sec] (mean)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="instead-of-conclusion">Instead of conclusion</h2>
<p>Make code, not war!</p>
<h2 id="related-articles">Related articles</h2>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2023-07-27</span>
            </div><div class="post-info-license">
                <span>false</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" data-title="How to use Flask with gevent (uWSGI and Gunicorn editions)" data-hashtags="Python,Flask"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" data-hashtag="Python"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" data-title="How to use Flask with gevent (uWSGI and Gunicorn editions)"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" data-title="How to use Flask with gevent (uWSGI and Gunicorn editions)"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on ÂæÆÂçö" data-sharer="weibo" data-url="http://example.org/how-to-use-flask-with-gevent-uwsgi-and-gunicorn-editions/" data-title="How to use Flask with gevent (uWSGI and Gunicorn editions)"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/flask/">Flask</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/web%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BAleancloud/" class="prev" rel="prev" title="Âà©Áî®LeanCloudÊê≠Âª∫WEBÊúçÂä°"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Âà©Áî®LeanCloudÊê≠Âª∫WEBÊúçÂä°</a>
            <a href="/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0python%E4%BE%9D%E8%B5%96%E5%8C%85%E5%AE%89%E8%A3%85%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" class="next" rel="next" title="ËÖæËÆØ‰∫ëÂáΩÊï∞Python‰æùËµñÂåÖÂÆâË£ÖÊâìÂåÖËøáÁ®ã">ËÖæËÆØ‰∫ëÂáΩÊï∞Python‰æùËµñÂåÖÂÆâË£ÖÊâìÂåÖËøáÁ®ã<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.116.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":30},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
