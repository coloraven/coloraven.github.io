<!-- build time:Fri Dec 16 2022 20:43:02 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://sirliu.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://sirliu.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://sirliu.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CMicrosoft%20YaHei:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="hisuite,解密,手机"><link rel="canonical" href="https://sirliu.github.io/2021/8/%E5%8D%8E%E4%B8%BAHisuite%E5%A4%87%E4%BB%BD%E8%A7%A3%E5%AF%86/"><title>华为Hisuite备份解密 - 手机 | Black Elk = = 潛龍勿用</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">华为Hisuite备份解密</h1><div class="meta"><span class="item" title="创建时间：2021-08-29 15:04:21"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-08-29T15:04:21+08:00">2021-08-29</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>32k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>29 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Black Elk</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=81698"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=966627"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=991828"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=891785"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=509941"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=295633"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%89%8B%E6%9C%BA/" itemprop="item" rel="index" title="分类于 手机"><span itemprop="name">手机</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sirliu.github.io/2021/8/%E5%8D%8E%E4%B8%BAHisuite%E5%A4%87%E4%BB%BD%E8%A7%A3%E5%AF%86/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="黑麋鹿"><meta itemprop="description" content="潛龍勿用, 折腾之路"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><p>最近在写东西的时候需要以前一个旧手机中的素材，幸运的是旧手机进行了全量备份，不幸的是手机不在了，而备份又是加密的文件（ <code>enc</code> 格式），需要解密华为手机备份文件，要解决的就是 <code>脱离手机解密</code> 。<br>于是在网上找来找去，找到了这个脚本：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1JlYWxpdHlOZXQva29iYWNrdXBkZWM=">https://github.com/RealityNet/kobackupdec</span></p><h1 id="源码"><a class="anchor" href="#源码">#</a> 源码</h1><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">#!/usr/bin/python3</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment"># -*- coding: utf-8 -*-</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token comment"># Huawei KoBackup backups decryptor.</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token comment"># Version History</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment"># - 20200705: fixed decrypt_large_package to read input's chunks</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token comment"># - 20200611: added 'expandtar' option, to avoid automatic expansion of TARs</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token comment">#             added 'writable' option, to allow user RW on decrypted files</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token comment">#             large TAR files are not managed in chunk but not expanded</span></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token comment"># - 20200607: merged empty CheckMsg, update folder_to_media_type by @realSnoopy</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token comment"># - 20200406: merged pull by @lp4n6, related to files and folders permissions</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token comment"># - 20200405: added Python minor version check and note (thanks @lp4n6)</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token comment"># - 2020test: rewritten to handle v9 and v10 backups</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token comment"># - 20200107: merged pull by @lp4n6, fixed current version</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token comment"># - 20191113: fixed double folder creation error</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token comment"># - 20190729: first public release</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token comment"># - 20190729: first public release</span></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token comment"># Note: it needs Python version >= 3.7</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token comment"># Released under MIT License</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token comment"># Copyright (c) 2019 Francesco "dfirfpi" Picasso, Reality Net System Solutions</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token comment"># Permission is hereby granted, free of charge, to any person obtaining a copy</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token comment"># of this software and associated documentation files (the "Software"), to deal</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token comment"># in the Software without restriction, including without limitation the rights</span></pre></td></tr><tr><td data-num="29"></td><td><pre><span class="token comment"># to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token comment"># copies of the Software, and to permit persons to whom the Software is</span></pre></td></tr><tr><td data-num="31"></td><td><pre><span class="token comment"># furnished to do so, subject to the following conditions:</span></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token comment"># The above copyright notice and this permission notice shall be included in</span></pre></td></tr><tr><td data-num="34"></td><td><pre><span class="token comment"># all copies or substantial portions of the Software.</span></pre></td></tr><tr><td data-num="35"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="36"></td><td><pre><span class="token comment"># THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span></pre></td></tr><tr><td data-num="37"></td><td><pre><span class="token comment"># IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span></pre></td></tr><tr><td data-num="38"></td><td><pre><span class="token comment"># FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span></pre></td></tr><tr><td data-num="39"></td><td><pre><span class="token comment"># AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token comment"># LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token comment"># OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE</span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token comment"># SOFTWARE.</span></pre></td></tr><tr><td data-num="43"></td><td><pre><span class="token comment">#</span></pre></td></tr><tr><td data-num="44"></td><td><pre><span class="token triple-quoted-string string">'''Huawei KoBackup decryptor.'''</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre><span class="token keyword">import</span> argparse</pre></td></tr><tr><td data-num="47"></td><td><pre><span class="token keyword">import</span> binascii</pre></td></tr><tr><td data-num="48"></td><td><pre><span class="token keyword">import</span> enum</pre></td></tr><tr><td data-num="49"></td><td><pre><span class="token keyword">import</span> io</pre></td></tr><tr><td data-num="50"></td><td><pre><span class="token keyword">import</span> logging</pre></td></tr><tr><td data-num="51"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="52"></td><td><pre><span class="token keyword">import</span> os<span class="token punctuation">.</span>path</pre></td></tr><tr><td data-num="53"></td><td><pre><span class="token keyword">import</span> pathlib</pre></td></tr><tr><td data-num="54"></td><td><pre><span class="token keyword">import</span> sys</pre></td></tr><tr><td data-num="55"></td><td><pre><span class="token keyword">import</span> tarfile</pre></td></tr><tr><td data-num="56"></td><td><pre><span class="token keyword">import</span> xml<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>minidom</pre></td></tr><tr><td data-num="57"></td><td><pre></pre></td></tr><tr><td data-num="58"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Cipher <span class="token keyword">import</span> AES</pre></td></tr><tr><td data-num="59"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> SHA256</pre></td></tr><tr><td data-num="60"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Hash <span class="token keyword">import</span> HMAC</pre></td></tr><tr><td data-num="61"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Protocol<span class="token punctuation">.</span>KDF <span class="token keyword">import</span> PBKDF2</pre></td></tr><tr><td data-num="62"></td><td><pre><span class="token keyword">from</span> Crypto<span class="token punctuation">.</span>Util <span class="token keyword">import</span> Counter</pre></td></tr><tr><td data-num="63"></td><td><pre></pre></td></tr><tr><td data-num="64"></td><td><pre>VERSION <span class="token operator">=</span> <span class="token string">'20200705'</span></pre></td></tr><tr><td data-num="65"></td><td><pre></pre></td></tr><tr><td data-num="66"></td><td><pre><span class="token comment"># Disabling check on doc strings and naming convention.</span></pre></td></tr><tr><td data-num="67"></td><td><pre><span class="token comment"># pylint: disable=C0111,C0103</span></pre></td></tr><tr><td data-num="68"></td><td><pre></pre></td></tr><tr><td data-num="69"></td><td><pre>MAX_FILE_SIZE <span class="token operator">=</span> <span class="token number">536870912</span> <span class="token comment"># Files larger than that needs to be 'chuncked'.</span></pre></td></tr><tr><td data-num="70"></td><td><pre></pre></td></tr><tr><td data-num="71"></td><td><pre><span class="token comment"># --- DecryptMaterial ---------------------------------------------------------</span></pre></td></tr><tr><td data-num="72"></td><td><pre></pre></td></tr><tr><td data-num="73"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DecryptMaterial</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="74"></td><td><pre></pre></td></tr><tr><td data-num="75"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> type_name<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        self<span class="token punctuation">.</span>_type_name <span class="token operator">=</span> type_name</pre></td></tr><tr><td data-num="77"></td><td><pre>        self<span class="token punctuation">.</span>_name <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="78"></td><td><pre>        self<span class="token punctuation">.</span>_encMsgV3 <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="79"></td><td><pre>        self<span class="token punctuation">.</span>_iv <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="80"></td><td><pre>        self<span class="token punctuation">.</span>_path <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="81"></td><td><pre>        self<span class="token punctuation">.</span>_records_num <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="82"></td><td><pre>        self<span class="token punctuation">.</span>_copy_file_path <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="83"></td><td><pre></pre></td></tr><tr><td data-num="84"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="85"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">type_name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_type_name</pre></td></tr><tr><td data-num="87"></td><td><pre></pre></td></tr><tr><td data-num="88"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="90"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_name</pre></td></tr><tr><td data-num="91"></td><td><pre></pre></td></tr><tr><td data-num="92"></td><td><pre>    <span class="token decorator annotation punctuation">@name<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="93"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">name</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">if</span> value_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="95"></td><td><pre>            self<span class="token punctuation">.</span>_name <span class="token operator">=</span> value_string</pre></td></tr><tr><td data-num="96"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="97"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'empty entry name!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="100"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">records_num</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="101"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_records_num</pre></td></tr><tr><td data-num="102"></td><td><pre></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token decorator annotation punctuation">@records_num<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">records_num</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="105"></td><td><pre>        self<span class="token punctuation">.</span>_records_num <span class="token operator">=</span> value_string</pre></td></tr><tr><td data-num="106"></td><td><pre></pre></td></tr><tr><td data-num="107"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="108"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">encMsgV3</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="109"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_encMsgV3</pre></td></tr><tr><td data-num="110"></td><td><pre></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token decorator annotation punctuation">@encMsgV3<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="112"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">encMsgV3</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_hex_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="113"></td><td><pre>        <span class="token keyword">if</span> value_hex_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="114"></td><td><pre>            self<span class="token punctuation">.</span>_encMsgV3 <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>value_hex_string<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="115"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_encMsgV3<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">48</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="116"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'encMsgV3 should be 48 bytes long!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="117"></td><td><pre></pre></td></tr><tr><td data-num="118"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">iv</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="120"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_iv</pre></td></tr><tr><td data-num="121"></td><td><pre></pre></td></tr><tr><td data-num="122"></td><td><pre>    <span class="token decorator annotation punctuation">@iv<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="123"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">iv</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_hex_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="124"></td><td><pre>        <span class="token keyword">if</span> value_hex_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="125"></td><td><pre>            self<span class="token punctuation">.</span>_iv <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>value_hex_string<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="126"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_iv<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">16</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="127"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'iv should be 16 bytes long!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="128"></td><td><pre></pre></td></tr><tr><td data-num="129"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">copy_file_path</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="131"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_copy_file_path</pre></td></tr><tr><td data-num="132"></td><td><pre></pre></td></tr><tr><td data-num="133"></td><td><pre>    <span class="token decorator annotation punctuation">@copy_file_path<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">copy_file_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="135"></td><td><pre>        self<span class="token punctuation">.</span>_copy_file_path <span class="token operator">=</span> value_string</pre></td></tr><tr><td data-num="136"></td><td><pre></pre></td></tr><tr><td data-num="137"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">path</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_path</pre></td></tr><tr><td data-num="140"></td><td><pre></pre></td></tr><tr><td data-num="141"></td><td><pre>    <span class="token decorator annotation punctuation">@path<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="143"></td><td><pre>        <span class="token keyword">if</span> value_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="144"></td><td><pre>            self<span class="token punctuation">.</span>_path <span class="token operator">=</span> value_string</pre></td></tr><tr><td data-num="145"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="146"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'empty file path!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="147"></td><td><pre></pre></td></tr><tr><td data-num="148"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">do_check</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_name <span class="token keyword">and</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>_encMsgV3 <span class="token keyword">or</span> self<span class="token punctuation">.</span>_iv<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="150"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="151"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="152"></td><td><pre></pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">dump</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="154"></td><td><pre>        dump <span class="token operator">=</span> <span class="token string">'NAME: &#123;&#125;, TYPE: &#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_name<span class="token punctuation">,</span> self<span class="token punctuation">.</span>_type_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="155"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_path<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="156"></td><td><pre>            dump <span class="token operator">+=</span> <span class="token string">'PATH: &#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="157"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_copy_file_path<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="158"></td><td><pre>            dump <span class="token operator">+=</span> <span class="token string">'COPY_FILEPATH: &#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_copy_file_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="159"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_records_num<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="160"></td><td><pre>            dump <span class="token operator">+=</span> <span class="token string">'RECORDS_NUM: &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_records_num<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="161"></td><td><pre>        <span class="token comment"># Not reported: self._encMsgV3, self._iv</span></pre></td></tr><tr><td data-num="162"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'\n'</span></pre></td></tr><tr><td data-num="163"></td><td><pre>        <span class="token keyword">return</span> dump</pre></td></tr><tr><td data-num="164"></td><td><pre></pre></td></tr><tr><td data-num="165"></td><td><pre></pre></td></tr><tr><td data-num="166"></td><td><pre><span class="token comment"># --- Decryptor ---------------------------------------------------------------</span></pre></td></tr><tr><td data-num="167"></td><td><pre></pre></td></tr><tr><td data-num="168"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">Decryptor</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="169"></td><td><pre>    <span class="token triple-quoted-string string">'''It provides algo and key derivations to decrypt files.'''</span></pre></td></tr><tr><td data-num="170"></td><td><pre></pre></td></tr><tr><td data-num="171"></td><td><pre>    count <span class="token operator">=</span> <span class="token number">5000</span></pre></td></tr><tr><td data-num="172"></td><td><pre>    dklen <span class="token operator">=</span> <span class="token number">32</span></pre></td></tr><tr><td data-num="173"></td><td><pre>    chunk_size <span class="token operator">=</span> <span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">64</span></pre></td></tr><tr><td data-num="174"></td><td><pre></pre></td></tr><tr><td data-num="175"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="176"></td><td><pre>        <span class="token triple-quoted-string string">'''Initialize the object by setting a password.'''</span></pre></td></tr><tr><td data-num="177"></td><td><pre>        self<span class="token punctuation">.</span>_upwd <span class="token operator">=</span> password</pre></td></tr><tr><td data-num="178"></td><td><pre>        self<span class="token punctuation">.</span>_good <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="179"></td><td><pre>        self<span class="token punctuation">.</span>_e_perbackupkey <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="180"></td><td><pre>        self<span class="token punctuation">.</span>_pwkey_salt <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="181"></td><td><pre>        self<span class="token punctuation">.</span>_type_attch <span class="token operator">=</span> <span class="token number">0</span></pre></td></tr><tr><td data-num="182"></td><td><pre>        self<span class="token punctuation">.</span>_checkMsg <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="183"></td><td><pre>        self<span class="token punctuation">.</span>_bkey <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="184"></td><td><pre>        self<span class="token punctuation">.</span>_bkey_sha256 <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="185"></td><td><pre></pre></td></tr><tr><td data-num="186"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="187"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">good</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="188"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_good</pre></td></tr><tr><td data-num="189"></td><td><pre></pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">password</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="192"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_upwd</pre></td></tr><tr><td data-num="193"></td><td><pre></pre></td></tr><tr><td data-num="194"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">e_perbackupkey</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="196"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_e_perbackupkey</pre></td></tr><tr><td data-num="197"></td><td><pre></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token decorator annotation punctuation">@e_perbackupkey<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">e_perbackupkey</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_hex_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="200"></td><td><pre>        <span class="token keyword">if</span> value_hex_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="201"></td><td><pre>            self<span class="token punctuation">.</span>_e_perbackupkey <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>value_hex_string<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="202"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_e_perbackupkey<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">48</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="203"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'e_perbackupkey should be 48 bytes long!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="204"></td><td><pre></pre></td></tr><tr><td data-num="205"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="206"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">pwkey_salt</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="207"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_pwkey_salt</pre></td></tr><tr><td data-num="208"></td><td><pre></pre></td></tr><tr><td data-num="209"></td><td><pre>    <span class="token decorator annotation punctuation">@pwkey_salt<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="210"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">pwkey_salt</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_hex_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="211"></td><td><pre>        <span class="token keyword">if</span> value_hex_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="212"></td><td><pre>            self<span class="token punctuation">.</span>_pwkey_salt <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>value_hex_string<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="213"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_pwkey_salt<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">32</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="214"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'pwkey_salt should be 32 bytes long!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="215"></td><td><pre></pre></td></tr><tr><td data-num="216"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="217"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">type_attch</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="218"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_type_attch</pre></td></tr><tr><td data-num="219"></td><td><pre></pre></td></tr><tr><td data-num="220"></td><td><pre>    <span class="token decorator annotation punctuation">@type_attch<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="221"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">type_attch</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_int<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="222"></td><td><pre>        self<span class="token punctuation">.</span>_type_attch <span class="token operator">=</span> value_int</pre></td></tr><tr><td data-num="223"></td><td><pre></pre></td></tr><tr><td data-num="224"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="225"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">checkMsg</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="226"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_checkMsg</pre></td></tr><tr><td data-num="227"></td><td><pre></pre></td></tr><tr><td data-num="228"></td><td><pre>    <span class="token decorator annotation punctuation">@checkMsg<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="229"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">checkMsg</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> value_hex_string<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="230"></td><td><pre>        <span class="token keyword">if</span> value_hex_string<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="231"></td><td><pre>            self<span class="token punctuation">.</span>_checkMsg <span class="token operator">=</span> binascii<span class="token punctuation">.</span>unhexlify<span class="token punctuation">(</span>value_hex_string<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="232"></td><td><pre>            <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_checkMsg<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">64</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="233"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'checkMsg should be 64 bytes long!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="234"></td><td><pre></pre></td></tr><tr><td data-num="235"></td><td><pre>    <span class="token decorator annotation punctuation">@staticmethod</span></pre></td></tr><tr><td data-num="236"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">prf</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="237"></td><td><pre>        <span class="token keyword">return</span> HMAC<span class="token punctuation">.</span>new<span class="token punctuation">(</span>p<span class="token punctuation">,</span> s<span class="token punctuation">,</span> SHA256<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="238"></td><td><pre></pre></td></tr><tr><td data-num="239"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__decrypt_bkey_v4</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="240"></td><td><pre>        key_salt <span class="token operator">=</span> self<span class="token punctuation">.</span>_pwkey_salt<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="241"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'KEY_SALT[%s] = %s'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key_salt<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="242"></td><td><pre>                      binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>key_salt<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="243"></td><td><pre></pre></td></tr><tr><td data-num="244"></td><td><pre>        key <span class="token operator">=</span> PBKDF2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_upwd<span class="token punctuation">,</span> key_salt<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>dklen<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="245"></td><td><pre>                     Decryptor<span class="token punctuation">.</span>prf<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="246"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'KEY[%s] = %s'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="247"></td><td><pre></pre></td></tr><tr><td data-num="248"></td><td><pre>        nonce <span class="token operator">=</span> self<span class="token punctuation">.</span>_pwkey_salt<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="249"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'KEY NONCE[%s] = %s'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="250"></td><td><pre>                      binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>nonce<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="251"></td><td><pre></pre></td></tr><tr><td data-num="252"></td><td><pre>        cipher <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> mode<span class="token operator">=</span>AES<span class="token punctuation">.</span>MODE_GCM<span class="token punctuation">,</span> nonce<span class="token operator">=</span>nonce<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="253"></td><td><pre>        self<span class="token punctuation">.</span>_bkey <span class="token operator">=</span> cipher<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_e_perbackupkey<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="254"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'BKEY[%s] =   %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="255"></td><td><pre>                      <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">)</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="256"></td><td><pre></pre></td></tr><tr><td data-num="257"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">crypto_init</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="258"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="259"></td><td><pre>            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'crypto_init: already done with success!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="260"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="261"></td><td><pre></pre></td></tr><tr><td data-num="262"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_type_attch <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="263"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'crypto_init: type_attch *should be* 3!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="264"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="265"></td><td><pre></pre></td></tr><tr><td data-num="266"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_e_perbackupkey <span class="token keyword">and</span> self<span class="token punctuation">.</span>_pwkey_salt<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="267"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'crypto_init: using version 4.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="268"></td><td><pre>            self<span class="token punctuation">.</span>__decrypt_bkey_v4<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="269"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="270"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'crypto_init: using version 3.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="271"></td><td><pre>            self<span class="token punctuation">.</span>_bkey <span class="token operator">=</span> self<span class="token punctuation">.</span>_upwd</pre></td></tr><tr><td data-num="272"></td><td><pre></pre></td></tr><tr><td data-num="273"></td><td><pre>        self<span class="token punctuation">.</span>_bkey_sha256 <span class="token operator">=</span> SHA256<span class="token punctuation">.</span>new<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">)</span><span class="token punctuation">.</span>digest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="274"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'SHA256(BKEY)[%s] = %s'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey_sha256<span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="275"></td><td><pre>                      binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey_sha256<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="276"></td><td><pre></pre></td></tr><tr><td data-num="277"></td><td><pre>        <span class="token comment"># [TBR][TODO] This check should be refactored.</span></pre></td></tr><tr><td data-num="278"></td><td><pre>        <span class="token keyword">if</span> self<span class="token punctuation">.</span>_checkMsg<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="279"></td><td><pre>            salt <span class="token operator">=</span> self<span class="token punctuation">.</span>_checkMsg<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="280"></td><td><pre></pre></td></tr><tr><td data-num="281"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'SALT[%s] = %s'</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>salt<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="282"></td><td><pre></pre></td></tr><tr><td data-num="283"></td><td><pre>            res <span class="token operator">=</span> PBKDF2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>dklen<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="284"></td><td><pre>                         Decryptor<span class="token punctuation">.</span>prf<span class="token punctuation">,</span> hmac_hash_module<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="285"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'KEY check expected = %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="286"></td><td><pre>                          binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_checkMsg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="287"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'RESULT = %s'</span><span class="token punctuation">,</span> binascii<span class="token punctuation">.</span>hexlify<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="288"></td><td><pre></pre></td></tr><tr><td data-num="289"></td><td><pre>            <span class="token keyword">if</span> res <span class="token operator">==</span> self<span class="token punctuation">.</span>_checkMsg<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="290"></td><td><pre>                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'OK, backup key is correct!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="291"></td><td><pre>                self<span class="token punctuation">.</span>_good <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="292"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="293"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'KO, backup key is wrong!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="294"></td><td><pre>                self<span class="token punctuation">.</span>_good <span class="token operator">=</span> <span class="token boolean">False</span></pre></td></tr><tr><td data-num="295"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="296"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Empty CheckMsg! Cannot check backup password!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="297"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Assuming the provided password is correct...'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="298"></td><td><pre>            self<span class="token punctuation">.</span>_good <span class="token operator">=</span> <span class="token boolean">True</span></pre></td></tr><tr><td data-num="299"></td><td><pre></pre></td></tr><tr><td data-num="300"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decrypt_package</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dec_material<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="301"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="302"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'well, it is hard to decrypt with a wrong key.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="303"></td><td><pre></pre></td></tr><tr><td data-num="304"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="305"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'cannot decrypt with an empty encMsgV3!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="306"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="307"></td><td><pre></pre></td></tr><tr><td data-num="308"></td><td><pre>        salt <span class="token operator">=</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="309"></td><td><pre>        counter_iv <span class="token operator">=</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="310"></td><td><pre></pre></td></tr><tr><td data-num="311"></td><td><pre>        key <span class="token operator">=</span> PBKDF2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>dklen<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="312"></td><td><pre>                     Decryptor<span class="token punctuation">.</span>prf<span class="token punctuation">,</span> hmac_hash_module<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="313"></td><td><pre></pre></td></tr><tr><td data-num="314"></td><td><pre>        counter_obj <span class="token operator">=</span> Counter<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> initial_value<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="315"></td><td><pre>            counter_iv<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> little_endian<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="316"></td><td><pre></pre></td></tr><tr><td data-num="317"></td><td><pre>        decryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> mode<span class="token operator">=</span>AES<span class="token punctuation">.</span>MODE_CTR<span class="token punctuation">,</span> counter<span class="token operator">=</span>counter_obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="318"></td><td><pre>        <span class="token keyword">return</span> decryptor<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="319"></td><td><pre></pre></td></tr><tr><td data-num="320"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decrypt_large_package</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dec_material<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="321"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="322"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'well, it is hard to decrypt with a wrong key.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="323"></td><td><pre></pre></td></tr><tr><td data-num="324"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="325"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'cannot decrypt with an empty encMsgV3!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="326"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="327"></td><td><pre></pre></td></tr><tr><td data-num="328"></td><td><pre>        salt <span class="token operator">=</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="329"></td><td><pre>        counter_iv <span class="token operator">=</span> dec_material<span class="token punctuation">.</span>encMsgV3<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="330"></td><td><pre></pre></td></tr><tr><td data-num="331"></td><td><pre>        key <span class="token operator">=</span> PBKDF2<span class="token punctuation">(</span>self<span class="token punctuation">.</span>_bkey<span class="token punctuation">,</span> salt<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>dklen<span class="token punctuation">,</span> Decryptor<span class="token punctuation">.</span>count<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="332"></td><td><pre>                     Decryptor<span class="token punctuation">.</span>prf<span class="token punctuation">,</span> hmac_hash_module<span class="token operator">=</span><span class="token boolean">None</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="333"></td><td><pre></pre></td></tr><tr><td data-num="334"></td><td><pre>        counter_obj <span class="token operator">=</span> Counter<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">,</span> initial_value<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="335"></td><td><pre>            counter_iv<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> little_endian<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="336"></td><td><pre></pre></td></tr><tr><td data-num="337"></td><td><pre>        decryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span>key<span class="token punctuation">,</span> mode<span class="token operator">=</span>AES<span class="token punctuation">.</span>MODE_CTR<span class="token punctuation">,</span> counter<span class="token operator">=</span>counter_obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="338"></td><td><pre>        data_len <span class="token operator">=</span> entry<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size</pre></td></tr><tr><td data-num="339"></td><td><pre>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> entry_fd<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="340"></td><td><pre>            <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> data_len<span class="token punctuation">,</span> self<span class="token punctuation">.</span>chunk_size<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="341"></td><td><pre>                logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'decrypting chunk %d of %s'</span><span class="token punctuation">,</span> x<span class="token punctuation">,</span> entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="342"></td><td><pre>                data <span class="token operator">=</span> entry_fd<span class="token punctuation">.</span>read<span class="token punctuation">(</span>self<span class="token punctuation">.</span>chunk_size<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="343"></td><td><pre>                <span class="token keyword">yield</span> decryptor<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="344"></td><td><pre></pre></td></tr><tr><td data-num="345"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decrypt_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> dec_material<span class="token punctuation">,</span> data<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="346"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> self<span class="token punctuation">.</span>_good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="347"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'well, it is hard to decrypt with a wrong key.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="348"></td><td><pre></pre></td></tr><tr><td data-num="349"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> dec_material<span class="token punctuation">.</span>iv<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="350"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'cannot decrypt with an empty iv!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="351"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="352"></td><td><pre></pre></td></tr><tr><td data-num="353"></td><td><pre>        counter_obj <span class="token operator">=</span> Counter<span class="token punctuation">.</span>new<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="354"></td><td><pre>            <span class="token number">128</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="355"></td><td><pre>            initial_value<span class="token operator">=</span><span class="token builtin">int</span><span class="token punctuation">.</span>from_bytes<span class="token punctuation">(</span>dec_material<span class="token punctuation">.</span>iv<span class="token punctuation">,</span> byteorder<span class="token operator">=</span><span class="token string">'big'</span><span class="token punctuation">)</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="356"></td><td><pre>            little_endian<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="357"></td><td><pre></pre></td></tr><tr><td data-num="358"></td><td><pre>        decryptor <span class="token operator">=</span> AES<span class="token punctuation">.</span>new<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="359"></td><td><pre>            self<span class="token punctuation">.</span>_bkey_sha256<span class="token punctuation">,</span> mode<span class="token operator">=</span>AES<span class="token punctuation">.</span>MODE_CTR<span class="token punctuation">,</span> counter<span class="token operator">=</span>counter_obj<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="360"></td><td><pre>        <span class="token keyword">return</span> decryptor<span class="token punctuation">.</span>decrypt<span class="token punctuation">(</span>data<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="361"></td><td><pre></pre></td></tr><tr><td data-num="362"></td><td><pre><span class="token comment"># --- DecryptInfo -------------------------------------------------------------</span></pre></td></tr><tr><td data-num="363"></td><td><pre></pre></td></tr><tr><td data-num="364"></td><td><pre><span class="token keyword">class</span> <span class="token class-name">DecryptInfo</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="365"></td><td><pre>    <span class="token triple-quoted-string string">'''It provides the information and keys to decrypt files.'''</span></pre></td></tr><tr><td data-num="366"></td><td><pre></pre></td></tr><tr><td data-num="367"></td><td><pre>    <span class="token keyword">class</span> <span class="token class-name">info_type</span><span class="token punctuation">(</span>enum<span class="token punctuation">.</span>Enum<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="368"></td><td><pre>        FILE <span class="token operator">=</span> <span class="token number">1</span></pre></td></tr><tr><td data-num="369"></td><td><pre>        MEDIA <span class="token operator">=</span> <span class="token number">2</span></pre></td></tr><tr><td data-num="370"></td><td><pre>        MULTIMEDIA <span class="token operator">=</span> <span class="token number">3</span></pre></td></tr><tr><td data-num="371"></td><td><pre>        SYSTEM_DATA <span class="token operator">=</span> <span class="token number">4</span></pre></td></tr><tr><td data-num="372"></td><td><pre>        SYSTEM_DATA_FOLDER <span class="token operator">=</span> <span class="token number">5</span></pre></td></tr><tr><td data-num="373"></td><td><pre></pre></td></tr><tr><td data-num="374"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">__init__</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="375"></td><td><pre>        self<span class="token punctuation">.</span>_decryptor <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="376"></td><td><pre>        self<span class="token punctuation">.</span>_file_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="377"></td><td><pre>        self<span class="token punctuation">.</span>_media_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="378"></td><td><pre>        self<span class="token punctuation">.</span>_multimedia_file <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="379"></td><td><pre>        self<span class="token punctuation">.</span>_system_data_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="380"></td><td><pre>        self<span class="token punctuation">.</span>_system_data_folder_info <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="381"></td><td><pre></pre></td></tr><tr><td data-num="382"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">search_decrypt_material</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="383"></td><td><pre>        <span class="token keyword">assert</span> key</pre></td></tr><tr><td data-num="384"></td><td><pre>        decrypt_material <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="385"></td><td><pre>        <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="386"></td><td><pre>            decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="387"></td><td><pre>        <span class="token keyword">elif</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_media_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="388"></td><td><pre>            decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_media_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="389"></td><td><pre>        <span class="token keyword">elif</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="390"></td><td><pre>            decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="391"></td><td><pre>        <span class="token keyword">elif</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="392"></td><td><pre>            decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="393"></td><td><pre>        <span class="token keyword">elif</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="394"></td><td><pre>            decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="395"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="396"></td><td><pre>            <span class="token keyword">pass</span></pre></td></tr><tr><td data-num="397"></td><td><pre>        <span class="token keyword">return</span> decrypt_material</pre></td></tr><tr><td data-num="398"></td><td><pre></pre></td></tr><tr><td data-num="399"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">get_decrypt_material</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> key<span class="token punctuation">,</span> di_type<span class="token punctuation">,</span> search<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="400"></td><td><pre>        <span class="token keyword">assert</span> key</pre></td></tr><tr><td data-num="401"></td><td><pre>        <span class="token keyword">assert</span> <span class="token builtin">isinstance</span><span class="token punctuation">(</span>di_type<span class="token punctuation">,</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="402"></td><td><pre>        decrypt_material <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="403"></td><td><pre>        logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'searching key [%s] of %s'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> di_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="404"></td><td><pre>        <span class="token keyword">if</span> di_type <span class="token keyword">is</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>FILE<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="405"></td><td><pre>            <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="406"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="407"></td><td><pre>        <span class="token keyword">elif</span> di_type <span class="token keyword">is</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>MEDIA<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="408"></td><td><pre>            <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_media_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="409"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_media_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="410"></td><td><pre>        <span class="token keyword">elif</span> di_type <span class="token keyword">is</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>MULTIMEDIA<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="411"></td><td><pre>            <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="412"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="413"></td><td><pre>        <span class="token keyword">elif</span> di_type <span class="token keyword">is</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>SYSTEM_DATA<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="414"></td><td><pre>            <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="415"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="416"></td><td><pre>        <span class="token keyword">elif</span> di_type <span class="token keyword">is</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>SYSTEM_DATA_FOLDER<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="417"></td><td><pre>            <span class="token keyword">if</span> key <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="418"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">[</span>key<span class="token punctuation">]</span></pre></td></tr><tr><td data-num="419"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="420"></td><td><pre>            logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'Unknown decrypt info type %s'</span><span class="token punctuation">,</span> di_type<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="421"></td><td><pre>            <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="422"></td><td><pre>        <span class="token keyword">if</span> decrypt_material <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="423"></td><td><pre>            <span class="token keyword">if</span> search <span class="token keyword">is</span> <span class="token boolean">True</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="424"></td><td><pre>                logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'unable to get [%s], trying on all types'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="425"></td><td><pre>                decrypt_material <span class="token operator">=</span> self<span class="token punctuation">.</span>search_decrypt_material<span class="token punctuation">(</span>key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="426"></td><td><pre>        <span class="token keyword">if</span> decrypt_material <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="427"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'unable to get [%s] in decrypt material!'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="428"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="429"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'decrypt info  [%s] found'</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="430"></td><td><pre>        <span class="token keyword">return</span> decrypt_material</pre></td></tr><tr><td data-num="431"></td><td><pre></pre></td></tr><tr><td data-num="432"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="433"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decryptor</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="434"></td><td><pre>        <span class="token keyword">return</span> self<span class="token punctuation">.</span>_decryptor</pre></td></tr><tr><td data-num="435"></td><td><pre></pre></td></tr><tr><td data-num="436"></td><td><pre>    <span class="token decorator annotation punctuation">@decryptor<span class="token punctuation">.</span>setter</span></pre></td></tr><tr><td data-num="437"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">decryptor</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> new_decryptor<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="438"></td><td><pre>        <span class="token keyword">assert</span> new_decryptor</pre></td></tr><tr><td data-num="439"></td><td><pre>        new_decryptor<span class="token punctuation">.</span>crypto_init<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="440"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> new_decryptor<span class="token punctuation">.</span>good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="441"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Setting a new decryptor which is not working!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="442"></td><td><pre>        self<span class="token punctuation">.</span>_decryptor <span class="token operator">=</span> new_decryptor</pre></td></tr><tr><td data-num="443"></td><td><pre></pre></td></tr><tr><td data-num="444"></td><td><pre>    <span class="token decorator annotation punctuation">@property</span></pre></td></tr><tr><td data-num="445"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">has_media</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="446"></td><td><pre>        <span class="token triple-quoted-string string">'''Checks if media categories decryption info is provided.'''</span></pre></td></tr><tr><td data-num="447"></td><td><pre>        <span class="token keyword">return</span> <span class="token builtin">bool</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_media_info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="448"></td><td><pre></pre></td></tr><tr><td data-num="449"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">add_file_info</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decrypt_material<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="450"></td><td><pre>        <span class="token triple-quoted-string string">'''Add the decryption material for a BackupFileModuleInfo entry to the</span></pre></td></tr><tr><td data-num="451"></td><td><pre>           proper internal object.</pre></td></tr><tr><td data-num="452"></td><td><pre>        '''</pre></td></tr><tr><td data-num="453"></td><td><pre>        <span class="token keyword">assert</span> decrypt_material<span class="token punctuation">.</span>type_name <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo'</span></pre></td></tr><tr><td data-num="454"></td><td><pre>        <span class="token keyword">if</span> decrypt_material<span class="token punctuation">.</span>name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="455"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Duplicate file info, cannot insert %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="456"></td><td><pre>                          decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="457"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="458"></td><td><pre>        self<span class="token punctuation">.</span>_file_info<span class="token punctuation">[</span>decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> decrypt_material</pre></td></tr><tr><td data-num="459"></td><td><pre></pre></td></tr><tr><td data-num="460"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">add_media_info</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decrypt_material<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="461"></td><td><pre>        <span class="token triple-quoted-string string">'''Add the decryption material for a BackupFileModuleInfo_Media</span></pre></td></tr><tr><td data-num="462"></td><td><pre>           entry to the proper internal object.</pre></td></tr><tr><td data-num="463"></td><td><pre>        '''</pre></td></tr><tr><td data-num="464"></td><td><pre>        <span class="token keyword">assert</span> decrypt_material<span class="token punctuation">.</span>type_name <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo_Media'</span></pre></td></tr><tr><td data-num="465"></td><td><pre>        <span class="token keyword">if</span> decrypt_material<span class="token punctuation">.</span>name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="466"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Duplicate media info, cannot insert %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="467"></td><td><pre>                          decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="468"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="469"></td><td><pre>        self<span class="token punctuation">.</span>_media_info<span class="token punctuation">[</span>decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> decrypt_material</pre></td></tr><tr><td data-num="470"></td><td><pre></pre></td></tr><tr><td data-num="471"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">add_multimedia_file</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decrypt_material<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="472"></td><td><pre>        <span class="token triple-quoted-string string">'''Add the decryption material for a multimedia file</span></pre></td></tr><tr><td data-num="473"></td><td><pre>           entry to the proper internal object.</pre></td></tr><tr><td data-num="474"></td><td><pre>        '''</pre></td></tr><tr><td data-num="475"></td><td><pre>        <span class="token keyword">assert</span> decrypt_material<span class="token punctuation">.</span>type_name <span class="token operator">==</span> <span class="token string">'Multimedia'</span></pre></td></tr><tr><td data-num="476"></td><td><pre>        <span class="token keyword">if</span> decrypt_material<span class="token punctuation">.</span>path <span class="token keyword">in</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="477"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Duplicate multimedia file path, cannot insert %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="478"></td><td><pre>                          decrypt_material<span class="token punctuation">.</span>path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="479"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="480"></td><td><pre>        <span class="token comment"># Note path is used for the key, not name.</span></pre></td></tr><tr><td data-num="481"></td><td><pre>        self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">[</span>decrypt_material<span class="token punctuation">.</span>path<span class="token punctuation">]</span> <span class="token operator">=</span> decrypt_material</pre></td></tr><tr><td data-num="482"></td><td><pre></pre></td></tr><tr><td data-num="483"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">add_system_data_info</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> decrypt_material<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="484"></td><td><pre>        <span class="token triple-quoted-string string">'''Add the decryption material for a BackupFileModuleInfo_SystemData</span></pre></td></tr><tr><td data-num="485"></td><td><pre>           entry to the proper internal object. It handles the scenario where</pre></td></tr><tr><td data-num="486"></td><td><pre>           the entry is related to folders, double copying the material.</pre></td></tr><tr><td data-num="487"></td><td><pre>        '''</pre></td></tr><tr><td data-num="488"></td><td><pre>        <span class="token keyword">assert</span> decrypt_material<span class="token punctuation">.</span>type_name <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo_SystemData'</span></pre></td></tr><tr><td data-num="489"></td><td><pre>        name <span class="token operator">=</span> decrypt_material<span class="token punctuation">.</span>name</pre></td></tr><tr><td data-num="490"></td><td><pre>        <span class="token keyword">if</span> name <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="491"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Duplicated system data info, cannot insert %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="492"></td><td><pre>                          decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="493"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="494"></td><td><pre>        self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">[</span>decrypt_material<span class="token punctuation">.</span>name<span class="token punctuation">]</span> <span class="token operator">=</span> decrypt_material</pre></td></tr><tr><td data-num="495"></td><td><pre>        copyfilepath <span class="token operator">=</span> decrypt_material<span class="token punctuation">.</span>copy_file_path</pre></td></tr><tr><td data-num="496"></td><td><pre>        <span class="token keyword">if</span> copyfilepath <span class="token keyword">and</span> copyfilepath<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="497"></td><td><pre>            <span class="token keyword">if</span> copyfilepath <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="498"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Duplicated system data folder info, cannot '</span></pre></td></tr><tr><td data-num="499"></td><td><pre>                              <span class="token string">'insert %s'</span><span class="token punctuation">,</span> copyfilepath<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="500"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="501"></td><td><pre>                self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">[</span>copyfilepath<span class="token punctuation">]</span> <span class="token operator">=</span> decrypt_material</pre></td></tr><tr><td data-num="502"></td><td><pre></pre></td></tr><tr><td data-num="503"></td><td><pre>    <span class="token keyword">def</span> <span class="token function">dump</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="504"></td><td><pre>        dump <span class="token operator">=</span> <span class="token string">'DecryptInfo dump ---\n'</span></pre></td></tr><tr><td data-num="505"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'password:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_decryptor<span class="token punctuation">.</span>password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="506"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'good:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_decryptor<span class="token punctuation">.</span>good<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="507"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'has media:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>has_media<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="508"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'file info:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_file_info<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="509"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'media info:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_media_info<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="510"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'multimedia file:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="511"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'system data info:&#123;&#125;, '</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="512"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'system folder data info:&#123;&#125;\n'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span></pre></td></tr><tr><td data-num="513"></td><td><pre>            self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="514"></td><td><pre></pre></td></tr><tr><td data-num="515"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'DUMPING FILE INFO ITEMS\n'</span></pre></td></tr><tr><td data-num="516"></td><td><pre>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> ev <span class="token keyword">in</span> self<span class="token punctuation">.</span>_file_info<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="517"></td><td><pre>            dump <span class="token operator">+=</span> ev<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="518"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'DUMPING MEDIA INFO ITEMS\n'</span></pre></td></tr><tr><td data-num="519"></td><td><pre>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> ev <span class="token keyword">in</span> self<span class="token punctuation">.</span>_media_info<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="520"></td><td><pre>            dump <span class="token operator">+=</span> ev<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="521"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'DUMPING MULTIMEDIA FILE ITEMS\n'</span></pre></td></tr><tr><td data-num="522"></td><td><pre>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> ev <span class="token keyword">in</span> self<span class="token punctuation">.</span>_multimedia_file<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="523"></td><td><pre>            dump <span class="token operator">+=</span> ev<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="524"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'DUMPING SYSTEM DATA INFO ITEMS\n'</span></pre></td></tr><tr><td data-num="525"></td><td><pre>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> ev <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_info<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="526"></td><td><pre>            dump <span class="token operator">+=</span> ev<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="527"></td><td><pre>        dump <span class="token operator">+=</span> <span class="token string">'DUMPING SYSTEM DATA FOLDER INFO ITEMS\n'</span></pre></td></tr><tr><td data-num="528"></td><td><pre>        <span class="token keyword">for</span> _<span class="token punctuation">,</span> ev <span class="token keyword">in</span> self<span class="token punctuation">.</span>_system_data_folder_info<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="529"></td><td><pre>            dump <span class="token operator">+=</span> ev<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="530"></td><td><pre>        <span class="token keyword">return</span> dump</pre></td></tr><tr><td data-num="531"></td><td><pre></pre></td></tr><tr><td data-num="532"></td><td><pre><span class="token comment"># --- xml_get_column_value ----------------------------------------------------</span></pre></td></tr><tr><td data-num="533"></td><td><pre></pre></td></tr><tr><td data-num="534"></td><td><pre><span class="token keyword">def</span> <span class="token function">xml_get_column_value</span><span class="token punctuation">(</span>xml_node<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="535"></td><td><pre>    <span class="token triple-quoted-string string">'''Helper to get xml 'column' value.'''</span></pre></td></tr><tr><td data-num="536"></td><td><pre>    child <span class="token operator">=</span> xml_node<span class="token punctuation">.</span>firstChild</pre></td></tr><tr><td data-num="537"></td><td><pre>    column_value <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="538"></td><td><pre>    <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="539"></td><td><pre>        <span class="token keyword">if</span> child<span class="token punctuation">.</span>tagName <span class="token operator">==</span> <span class="token string">'value'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="540"></td><td><pre>            <span class="token keyword">if</span> child<span class="token punctuation">.</span>hasAttribute<span class="token punctuation">(</span><span class="token string">'String'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="541"></td><td><pre>                column_value <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'String'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="542"></td><td><pre>            <span class="token keyword">elif</span> child<span class="token punctuation">.</span>hasAttribute<span class="token punctuation">(</span><span class="token string">'Integer'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="543"></td><td><pre>                column_value <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'Integer'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="544"></td><td><pre>            <span class="token keyword">elif</span> child<span class="token punctuation">.</span>hasAttribute<span class="token punctuation">(</span><span class="token string">'Null'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="545"></td><td><pre>                column_value <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="546"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="547"></td><td><pre>                logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'xml column value: unknown value attribute.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="548"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="549"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'xml_get_column_value: entry has no values!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="550"></td><td><pre>    <span class="token keyword">except</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="551"></td><td><pre>        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'*exception*, xml_get_column_value, child: %s'</span><span class="token punctuation">,</span> child<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="552"></td><td><pre></pre></td></tr><tr><td data-num="553"></td><td><pre>    <span class="token keyword">return</span> column_value</pre></td></tr><tr><td data-num="554"></td><td><pre></pre></td></tr><tr><td data-num="555"></td><td><pre><span class="token comment"># --- parse_backup_files_type_info --------------------------------------------</span></pre></td></tr><tr><td data-num="556"></td><td><pre></pre></td></tr><tr><td data-num="557"></td><td><pre><span class="token keyword">def</span> <span class="token function">parse_backup_files_type_info</span><span class="token punctuation">(</span>decryptor<span class="token punctuation">,</span> xml_entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="558"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> xml_entry<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'column'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="559"></td><td><pre>        name <span class="token operator">=</span> entry<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="560"></td><td><pre>        <span class="token keyword">if</span> name <span class="token operator">==</span> <span class="token string">'e_perbackupkey'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="561"></td><td><pre>            decryptor<span class="token punctuation">.</span>e_perbackupkey <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="562"></td><td><pre>        <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">'pwkey_salt'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="563"></td><td><pre>            decryptor<span class="token punctuation">.</span>pwkey_salt <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="564"></td><td><pre>        <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">'type_attch'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="565"></td><td><pre>            decryptor<span class="token punctuation">.</span>type_attch <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="566"></td><td><pre>        <span class="token keyword">elif</span> name <span class="token operator">==</span> <span class="token string">'checkMsg'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="567"></td><td><pre>            decryptor<span class="token punctuation">.</span>checkMsg <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="568"></td><td><pre></pre></td></tr><tr><td data-num="569"></td><td><pre><span class="token comment"># --- parse_backup_file_module_info -------------------------------------------</span></pre></td></tr><tr><td data-num="570"></td><td><pre></pre></td></tr><tr><td data-num="571"></td><td><pre><span class="token keyword">def</span> <span class="token function">parse_backup_file_module_info</span><span class="token punctuation">(</span>xml_entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="572"></td><td><pre>    decm <span class="token operator">=</span> DecryptMaterial<span class="token punctuation">(</span>xml_entry<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="573"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> xml_entry<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'column'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="574"></td><td><pre>        tag_name <span class="token operator">=</span> entry<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="575"></td><td><pre>        <span class="token keyword">if</span> tag_name <span class="token operator">==</span> <span class="token string">'encMsgV3'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="576"></td><td><pre>            decm<span class="token punctuation">.</span>encMsgV3 <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="577"></td><td><pre>        <span class="token keyword">elif</span> tag_name <span class="token operator">==</span> <span class="token string">'name'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="578"></td><td><pre>            decm<span class="token punctuation">.</span>name <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="579"></td><td><pre>        <span class="token keyword">elif</span> tag_name <span class="token operator">==</span> <span class="token string">'copyFilePath'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="580"></td><td><pre>            decm<span class="token punctuation">.</span>copy_file_path <span class="token operator">=</span> xml_get_column_value<span class="token punctuation">(</span>entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="581"></td><td><pre>        <span class="token keyword">elif</span> tag_name <span class="token operator">==</span> <span class="token string">'checkMsgV3'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="582"></td><td><pre>            <span class="token comment"># [TBR][TODO] Reverse this double sized checkMsgV3.</span></pre></td></tr><tr><td data-num="583"></td><td><pre>            <span class="token keyword">pass</span></pre></td></tr><tr><td data-num="584"></td><td><pre></pre></td></tr><tr><td data-num="585"></td><td><pre>    <span class="token keyword">if</span> decm<span class="token punctuation">.</span>do_check<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token boolean">False</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="586"></td><td><pre>        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Decryption material checks failed for %s, type %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="587"></td><td><pre>                        decm<span class="token punctuation">.</span>name<span class="token punctuation">,</span> decm<span class="token punctuation">.</span>type_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="588"></td><td><pre>    <span class="token keyword">return</span> decm</pre></td></tr><tr><td data-num="589"></td><td><pre></pre></td></tr><tr><td data-num="590"></td><td><pre><span class="token comment"># --- parse_info_xml ----------------------------------------------------------</span></pre></td></tr><tr><td data-num="591"></td><td><pre></pre></td></tr><tr><td data-num="592"></td><td><pre><span class="token keyword">def</span> <span class="token function">parse_info_xml</span><span class="token punctuation">(</span>filepath<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="593"></td><td><pre>    <span class="token triple-quoted-string string">'''Parses the info.xml backup file.</span></pre></td></tr><tr><td data-num="594"></td><td><pre>       Creates and returns a DecryptInfo object.</pre></td></tr><tr><td data-num="595"></td><td><pre>    '''</pre></td></tr><tr><td data-num="596"></td><td><pre>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Parsing file %s'</span><span class="token punctuation">,</span> filepath<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="597"></td><td><pre>    info_dom <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="598"></td><td><pre>    <span class="token keyword">with</span> filepath<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> info_xml<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="599"></td><td><pre>        info_dom <span class="token operator">=</span> xml<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>minidom<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>info_xml<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="600"></td><td><pre></pre></td></tr><tr><td data-num="601"></td><td><pre>    <span class="token keyword">if</span> info_dom<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>tagName <span class="token operator">!=</span> <span class="token string">'info.xml'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="602"></td><td><pre>        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'First tag should be \'info.xml\', not %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="603"></td><td><pre>                      info_dom<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="604"></td><td><pre>        <span class="token keyword">return</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="605"></td><td><pre></pre></td></tr><tr><td data-num="606"></td><td><pre>    dec_info <span class="token operator">=</span> DecryptInfo<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="607"></td><td><pre></pre></td></tr><tr><td data-num="608"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> info_dom<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'row'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="609"></td><td><pre>        title <span class="token operator">=</span> entry<span class="token punctuation">.</span>getAttribute<span class="token punctuation">(</span><span class="token string">'table'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="610"></td><td><pre>        <span class="token keyword">if</span> title <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="611"></td><td><pre>            dec_info<span class="token punctuation">.</span>add_file_info<span class="token punctuation">(</span>parse_backup_file_module_info<span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="612"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo_SystemData'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="613"></td><td><pre>            dec_info<span class="token punctuation">.</span>add_system_data_info<span class="token punctuation">(</span>parse_backup_file_module_info<span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="614"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo_Media'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="615"></td><td><pre>            dec_info<span class="token punctuation">.</span>add_media_info<span class="token punctuation">(</span>parse_backup_file_module_info<span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="616"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFilesTypeInfo'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="617"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Parsing BackupFilesTypeInfo'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="618"></td><td><pre>            decryptor <span class="token operator">=</span> Decryptor<span class="token punctuation">(</span>password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="619"></td><td><pre>            parse_backup_files_type_info<span class="token punctuation">(</span>decryptor<span class="token punctuation">,</span> entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="620"></td><td><pre>            dec_info<span class="token punctuation">.</span>decryptor <span class="token operator">=</span> decryptor</pre></td></tr><tr><td data-num="621"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFileModuleInfo_Contact'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="622"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Ignoring BackupFileModuleInfo_Contact entry'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="623"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'HeaderInfo'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="624"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Ignoring HeaderInfo entry.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="625"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFilePhoneInfo'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="626"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Ignoring BackupFilePhoneInfo entry'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="627"></td><td><pre>        <span class="token keyword">elif</span> title <span class="token operator">==</span> <span class="token string">'BackupFileVersionInfo'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="628"></td><td><pre>            logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Ignoring BackupFileVersionInfo entry'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="629"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="630"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Unknown entry in info.xml: %s'</span><span class="token punctuation">,</span> title<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="631"></td><td><pre></pre></td></tr><tr><td data-num="632"></td><td><pre>    <span class="token keyword">return</span> dec_info</pre></td></tr><tr><td data-num="633"></td><td><pre></pre></td></tr><tr><td data-num="634"></td><td><pre><span class="token comment"># --- parse_generic_xml -------------------------------------------------------</span></pre></td></tr><tr><td data-num="635"></td><td><pre></pre></td></tr><tr><td data-num="636"></td><td><pre><span class="token keyword">def</span> <span class="token function">parse_generic_xml</span><span class="token punctuation">(</span>xml_file_path<span class="token punctuation">,</span> decrypt_info<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="637"></td><td><pre>    <span class="token triple-quoted-string string">'''Parses a generic XML file, which contain single media (video, documents,</span></pre></td></tr><tr><td data-num="638"></td><td><pre>       pictures, etc.) decryption material.</pre></td></tr><tr><td data-num="639"></td><td><pre>    '''</pre></td></tr><tr><td data-num="640"></td><td><pre>    xml_dom <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="641"></td><td><pre>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'parsing xml file %s'</span><span class="token punctuation">,</span> xml_file_path<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="642"></td><td><pre></pre></td></tr><tr><td data-num="643"></td><td><pre>    <span class="token keyword">with</span> xml_file_path<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'r'</span><span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> xml_file<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="644"></td><td><pre>        xml_dom <span class="token operator">=</span> xml<span class="token punctuation">.</span>dom<span class="token punctuation">.</span>minidom<span class="token punctuation">.</span>parse<span class="token punctuation">(</span>xml_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="645"></td><td><pre></pre></td></tr><tr><td data-num="646"></td><td><pre>    <span class="token keyword">if</span> xml_dom<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>tagName <span class="token operator">!=</span> <span class="token string">'Multimedia'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="647"></td><td><pre>        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'First tag should be \'Multimedia\', not %s'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="648"></td><td><pre>                      xml_dom<span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>tagName<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="649"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="650"></td><td><pre></pre></td></tr><tr><td data-num="651"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> xml_dom<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'File'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="652"></td><td><pre>        path <span class="token operator">=</span> entry<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'Path'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>data</pre></td></tr><tr><td data-num="653"></td><td><pre>        iv <span class="token operator">=</span> entry<span class="token punctuation">.</span>getElementsByTagName<span class="token punctuation">(</span><span class="token string">'Iv'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>firstChild<span class="token punctuation">.</span>data</pre></td></tr><tr><td data-num="654"></td><td><pre>        <span class="token keyword">if</span> path <span class="token keyword">and</span> iv<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="655"></td><td><pre>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token string">'nt'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="656"></td><td><pre>                path <span class="token operator">=</span> path<span class="token punctuation">.</span>replace<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="657"></td><td><pre>            decrypt_material <span class="token operator">=</span> DecryptMaterial<span class="token punctuation">(</span><span class="token string">'Multimedia'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="658"></td><td><pre>            decrypt_material<span class="token punctuation">.</span>path <span class="token operator">=</span> path<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="659"></td><td><pre>            decrypt_material<span class="token punctuation">.</span>iv <span class="token operator">=</span> iv</pre></td></tr><tr><td data-num="660"></td><td><pre>            decrypt_info<span class="token punctuation">.</span>add_multimedia_file<span class="token punctuation">(</span>decrypt_material<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="661"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="662"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'No path and/or iv for %s!'</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="663"></td><td><pre></pre></td></tr><tr><td data-num="664"></td><td><pre><span class="token comment"># --- tar_extract_win ---------------------------------------------------------</span></pre></td></tr><tr><td data-num="665"></td><td><pre></pre></td></tr><tr><td data-num="666"></td><td><pre><span class="token keyword">def</span> <span class="token function">tar_extract_win</span><span class="token punctuation">(</span>tar_obj<span class="token punctuation">,</span> dest_dir<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="667"></td><td><pre>    win_illegal <span class="token operator">=</span> <span class="token string">':&lt;>|"?*\n'</span></pre></td></tr><tr><td data-num="668"></td><td><pre>    table <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">.</span>maketrans<span class="token punctuation">(</span>win_illegal<span class="token punctuation">,</span> <span class="token string">'_'</span> <span class="token operator">*</span> <span class="token builtin">len</span><span class="token punctuation">(</span>win_illegal<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="669"></td><td><pre>    <span class="token keyword">for</span> member <span class="token keyword">in</span> tar_obj<span class="token punctuation">.</span>getmembers<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="670"></td><td><pre>        <span class="token keyword">if</span> member<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="671"></td><td><pre>            new_dir <span class="token operator">=</span> dest_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>member<span class="token punctuation">.</span>path<span class="token punctuation">.</span>translate<span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="672"></td><td><pre>            new_dir<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="673"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="674"></td><td><pre>            dest_file <span class="token operator">=</span> dest_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>member<span class="token punctuation">.</span>path<span class="token punctuation">.</span>translate<span class="token punctuation">(</span>table<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="675"></td><td><pre>            <span class="token keyword">try</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="676"></td><td><pre>                <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dest_file<span class="token punctuation">,</span> <span class="token string">"wb"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fout<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="677"></td><td><pre>                    fout<span class="token punctuation">.</span>write<span class="token punctuation">(</span>tarfile<span class="token punctuation">.</span>ExFileObject<span class="token punctuation">(</span>tar_obj<span class="token punctuation">,</span> member<span class="token punctuation">)</span><span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="678"></td><td><pre>            <span class="token keyword">except</span> FileNotFoundError<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="679"></td><td><pre>                logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'unable to extract %s'</span><span class="token punctuation">,</span> dest_file<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="680"></td><td><pre></pre></td></tr><tr><td data-num="681"></td><td><pre><span class="token comment"># --- decrypt_entry -----------------------------------------------------------</span></pre></td></tr><tr><td data-num="682"></td><td><pre></pre></td></tr><tr><td data-num="683"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_entry</span><span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> type_info<span class="token punctuation">,</span> search<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="684"></td><td><pre>    cleartext <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="685"></td><td><pre>    skey <span class="token operator">=</span> entry<span class="token punctuation">.</span>stem</pre></td></tr><tr><td data-num="686"></td><td><pre>    decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span>skey<span class="token punctuation">,</span> type_info<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="687"></td><td><pre>                                                         search<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="688"></td><td><pre>    <span class="token keyword">if</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="689"></td><td><pre>        cleartext <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>decrypt_package<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="690"></td><td><pre>            decrypt_material<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="691"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="692"></td><td><pre>        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'entry %s has no decrypt material!'</span><span class="token punctuation">,</span> skey<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="693"></td><td><pre>    <span class="token keyword">return</span> cleartext</pre></td></tr><tr><td data-num="694"></td><td><pre></pre></td></tr><tr><td data-num="695"></td><td><pre><span class="token comment"># --- decrypt_large_entry -----------------------------------------------------</span></pre></td></tr><tr><td data-num="696"></td><td><pre></pre></td></tr><tr><td data-num="697"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_large_entry</span><span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> type_info<span class="token punctuation">,</span> search<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="698"></td><td><pre>    skey <span class="token operator">=</span> entry<span class="token punctuation">.</span>stem</pre></td></tr><tr><td data-num="699"></td><td><pre>    decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span>skey<span class="token punctuation">,</span> type_info<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="700"></td><td><pre>                                                         search<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="701"></td><td><pre>    <span class="token keyword">if</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="702"></td><td><pre>        <span class="token keyword">for</span> x <span class="token keyword">in</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>decrypt_large_package<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="703"></td><td><pre>                decrypt_material<span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="704"></td><td><pre>            <span class="token keyword">yield</span> x</pre></td></tr><tr><td data-num="705"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="706"></td><td><pre>        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'entry %s has no decrypt material!'</span><span class="token punctuation">,</span> skey<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="707"></td><td><pre></pre></td></tr><tr><td data-num="708"></td><td><pre><span class="token comment"># --- decrypt_files_in_root ---------------------------------------------------</span></pre></td></tr><tr><td data-num="709"></td><td><pre></pre></td></tr><tr><td data-num="710"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_files_in_root</span><span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> path_in<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="711"></td><td><pre></pre></td></tr><tr><td data-num="712"></td><td><pre>    data_apk_dir <span class="token operator">=</span> path_out<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'data/app'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="713"></td><td><pre>    data_app_dir <span class="token operator">=</span> path_out<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'data/data'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="714"></td><td><pre>    <span class="token comment">#data_app_dir.mkdir(0o755, parents=True, exist_ok=True)</span></pre></td></tr><tr><td data-num="715"></td><td><pre>    data_unk_dir <span class="token operator">=</span> path_out<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'unknown'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="716"></td><td><pre></pre></td></tr><tr><td data-num="717"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> path_in<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="718"></td><td><pre>        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="719"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="720"></td><td><pre>        cleartext <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="721"></td><td><pre>        extension <span class="token operator">=</span> entry<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="722"></td><td><pre></pre></td></tr><tr><td data-num="723"></td><td><pre>        <span class="token comment"># XML files in the 'root' were already managed.</span></pre></td></tr><tr><td data-num="724"></td><td><pre>        <span class="token keyword">if</span> extension <span class="token operator">==</span> <span class="token string">'.xml'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="725"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="726"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'working on %s'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="727"></td><td><pre></pre></td></tr><tr><td data-num="728"></td><td><pre>        <span class="token keyword">if</span> extension <span class="token operator">==</span> <span class="token string">'.apk'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="729"></td><td><pre>            dest_file <span class="token operator">=</span> data_apk_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">'-1'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="730"></td><td><pre>            dest_file<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="731"></td><td><pre>            dest_file <span class="token operator">=</span> dest_file<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'base.apk'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="732"></td><td><pre>            dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="733"></td><td><pre></pre></td></tr><tr><td data-num="734"></td><td><pre>        <span class="token keyword">elif</span> extension <span class="token operator">==</span> <span class="token string">'.db'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="735"></td><td><pre>            cleartext <span class="token operator">=</span> decrypt_entry<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="736"></td><td><pre>                                      DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>SYSTEM_DATA<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="737"></td><td><pre>                                      search<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="738"></td><td><pre>            <span class="token keyword">if</span> cleartext<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="739"></td><td><pre>                dest_file <span class="token operator">=</span> data_app_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="740"></td><td><pre>                dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="741"></td><td><pre>                dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="742"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="743"></td><td><pre>                logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'unable to decrypt entry %s'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="744"></td><td><pre></pre></td></tr><tr><td data-num="745"></td><td><pre>        <span class="token keyword">elif</span> extension <span class="token operator">==</span> <span class="token string">'.tar'</span> <span class="token keyword">and</span> entry<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size <span class="token operator">&lt;</span> MAX_FILE_SIZE<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="746"></td><td><pre>            cleartext <span class="token operator">=</span> decrypt_entry<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="747"></td><td><pre>                                      DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>FILE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="748"></td><td><pre>            <span class="token keyword">if</span> cleartext <span class="token keyword">and</span> expandtar<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="749"></td><td><pre>                <span class="token keyword">with</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>fileobj<span class="token operator">=</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tar_data<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="750"></td><td><pre>                    <span class="token keyword">if</span> os<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'nt'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="751"></td><td><pre>                        tar_extract_win<span class="token punctuation">(</span>tar_data<span class="token punctuation">,</span> data_app_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="752"></td><td><pre>                    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="753"></td><td><pre>                        tar_data<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>path<span class="token operator">=</span>data_app_dir<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="754"></td><td><pre>            <span class="token keyword">elif</span> cleartext<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="755"></td><td><pre>                logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Not expanding TAR file %s'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="756"></td><td><pre>                dest_file <span class="token operator">=</span> data_app_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="757"></td><td><pre>                dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="758"></td><td><pre>                dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="759"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="760"></td><td><pre>                logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'unable to decrypt entry %s'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="761"></td><td><pre></pre></td></tr><tr><td data-num="762"></td><td><pre>        <span class="token keyword">elif</span> extension <span class="token operator">==</span> <span class="token string">'.tar'</span> <span class="token keyword">and</span> entry<span class="token punctuation">.</span>stat<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>st_size <span class="token operator">>=</span> MAX_FILE_SIZE<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="763"></td><td><pre>            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Decrypting LARGE entry %s'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="764"></td><td><pre>            logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'TAR will not be expanded'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="765"></td><td><pre>            dest_file <span class="token operator">=</span> data_app_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="766"></td><td><pre>            dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="767"></td><td><pre>            <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>dest_file<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> fd<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="768"></td><td><pre>                <span class="token keyword">for</span> x <span class="token keyword">in</span> decrypt_large_entry<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="769"></td><td><pre>                                             DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>FILE<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="770"></td><td><pre>                    fd<span class="token punctuation">.</span>write<span class="token punctuation">(</span>x<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="771"></td><td><pre></pre></td></tr><tr><td data-num="772"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="773"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'entry %s unmanged, copying it'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="774"></td><td><pre>            dest_file <span class="token operator">=</span> data_unk_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="775"></td><td><pre>            dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="776"></td><td><pre>            dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="777"></td><td><pre></pre></td></tr><tr><td data-num="778"></td><td><pre><span class="token comment"># --- decrypt_files_in_folder -------------------------------------------------</span></pre></td></tr><tr><td data-num="779"></td><td><pre></pre></td></tr><tr><td data-num="780"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_files_in_folder</span><span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> folder<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="781"></td><td><pre></pre></td></tr><tr><td data-num="782"></td><td><pre>    folder_to_media_type <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'movies'</span><span class="token punctuation">:</span> <span class="token string">'video'</span><span class="token punctuation">,</span> <span class="token string">'pictures'</span><span class="token punctuation">:</span> <span class="token string">'photo'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="783"></td><td><pre>                            <span class="token string">'audios'</span><span class="token punctuation">:</span> <span class="token string">'audio'</span><span class="token punctuation">,</span> <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="784"></td><td><pre></pre></td></tr><tr><td data-num="785"></td><td><pre>    media_out_dir <span class="token operator">=</span> path_out<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'storage'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="786"></td><td><pre>    media_unk_dir <span class="token operator">=</span> path_out<span class="token punctuation">.</span>absolute<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'unknown'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="787"></td><td><pre></pre></td></tr><tr><td data-num="788"></td><td><pre>    <span class="token comment"># Dirty 'hack' to see if an XML file is inside the folder with IVs</span></pre></td></tr><tr><td data-num="789"></td><td><pre>    <span class="token comment"># needed to decrypt .enc files... Not tested for side effects.</span></pre></td></tr><tr><td data-num="790"></td><td><pre>    xml_files <span class="token operator">=</span> folder<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*.xml'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="791"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> xml_files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="792"></td><td><pre>        parse_generic_xml<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> decrypt_info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="793"></td><td><pre></pre></td></tr><tr><td data-num="794"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> folder<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'**/*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="795"></td><td><pre>        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="796"></td><td><pre>            <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="797"></td><td><pre></pre></td></tr><tr><td data-num="798"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'working on [%s]'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="799"></td><td><pre>        extension <span class="token operator">=</span> entry<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="800"></td><td><pre></pre></td></tr><tr><td data-num="801"></td><td><pre>        cleartext <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="802"></td><td><pre></pre></td></tr><tr><td data-num="803"></td><td><pre>        <span class="token keyword">if</span> extension <span class="token operator">==</span> <span class="token string">'.enc'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="804"></td><td><pre>            skey <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>relative_to<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">.</span>with_suffix<span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="805"></td><td><pre>            decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="806"></td><td><pre>                skey<span class="token punctuation">,</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>MULTIMEDIA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="807"></td><td><pre>            <span class="token keyword">if</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="808"></td><td><pre>                cleartext <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>decrypt_file<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="809"></td><td><pre>                    decrypt_material<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="810"></td><td><pre></pre></td></tr><tr><td data-num="811"></td><td><pre>            <span class="token keyword">if</span> cleartext <span class="token keyword">and</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="812"></td><td><pre>                tmp_path <span class="token operator">=</span> decrypt_material<span class="token punctuation">.</span>path<span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>lstrip<span class="token punctuation">(</span><span class="token string">'\\'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="813"></td><td><pre>                dest_file <span class="token operator">=</span> path_out<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>tmp_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="814"></td><td><pre>                dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="815"></td><td><pre>                dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="816"></td><td><pre>                <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="817"></td><td><pre></pre></td></tr><tr><td data-num="818"></td><td><pre>        decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="819"></td><td><pre>            folder<span class="token punctuation">.</span>name<span class="token punctuation">,</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>MEDIA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="820"></td><td><pre>        <span class="token keyword">if</span> <span class="token keyword">not</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="821"></td><td><pre>            <span class="token comment"># Some folders share a common type even if with different names.</span></pre></td></tr><tr><td data-num="822"></td><td><pre>            <span class="token keyword">if</span> folder<span class="token punctuation">.</span>name <span class="token keyword">in</span> folder_to_media_type<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="823"></td><td><pre>                decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="824"></td><td><pre>                    folder_to_media_type<span class="token punctuation">[</span>folder<span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="825"></td><td><pre>                    DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>MEDIA<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="826"></td><td><pre>        <span class="token keyword">if</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="827"></td><td><pre>            cleartext <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>decrypt_package<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="828"></td><td><pre>                decrypt_material<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="829"></td><td><pre>            <span class="token keyword">if</span> cleartext<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="830"></td><td><pre>                dest_file <span class="token operator">=</span> media_out_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>relative_to<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="831"></td><td><pre>                dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="832"></td><td><pre>                dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="833"></td><td><pre>                <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="834"></td><td><pre></pre></td></tr><tr><td data-num="835"></td><td><pre>        skey <span class="token operator">=</span> <span class="token string">'/'</span> <span class="token operator">+</span>  <span class="token builtin">str</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span>relative_to<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">.</span>parent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="836"></td><td><pre>        decrypt_material <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>get_decrypt_material<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="837"></td><td><pre>            skey<span class="token punctuation">,</span> DecryptInfo<span class="token punctuation">.</span>info_type<span class="token punctuation">.</span>SYSTEM_DATA_FOLDER<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="838"></td><td><pre>        <span class="token keyword">if</span> decrypt_material<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="839"></td><td><pre>            cleartext <span class="token operator">=</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>decrypt_package<span class="token punctuation">(</span></pre></td></tr><tr><td data-num="840"></td><td><pre>                decrypt_material<span class="token punctuation">,</span> entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="841"></td><td><pre>            <span class="token keyword">if</span> cleartext<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="842"></td><td><pre>                dest_file <span class="token operator">=</span> media_out_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>relative_to<span class="token punctuation">(</span>folder<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="843"></td><td><pre>                dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="844"></td><td><pre>                <span class="token keyword">if</span> entry<span class="token punctuation">.</span>suffix<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token string">'.tar'</span> <span class="token keyword">and</span> expandtar<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="845"></td><td><pre>                    <span class="token keyword">with</span> tarfile<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span>fileobj<span class="token operator">=</span>io<span class="token punctuation">.</span>BytesIO<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> tdata<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="846"></td><td><pre>                        <span class="token keyword">if</span> os<span class="token punctuation">.</span>name <span class="token operator">==</span> <span class="token string">'nt'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="847"></td><td><pre>                            tar_extract_win<span class="token punctuation">(</span>tdata<span class="token punctuation">,</span> dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="848"></td><td><pre>                        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="849"></td><td><pre>                            tdata<span class="token punctuation">.</span>extractall<span class="token punctuation">(</span>path<span class="token operator">=</span>dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="850"></td><td><pre>                <span class="token comment"># Double copy here the tar and the extracted one, no overwrite.</span></pre></td></tr><tr><td data-num="851"></td><td><pre>                <span class="token keyword">if</span> dest_file<span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="852"></td><td><pre>                    new_name <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>folder<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'_'</span> <span class="token operator">+</span> <span class="token builtin">str</span><span class="token punctuation">(</span>dest_file<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="853"></td><td><pre>                    dest_file <span class="token operator">=</span> dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>new_name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="854"></td><td><pre>                    dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="855"></td><td><pre>                dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>cleartext<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="856"></td><td><pre>                <span class="token keyword">continue</span></pre></td></tr><tr><td data-num="857"></td><td><pre></pre></td></tr><tr><td data-num="858"></td><td><pre>        <span class="token keyword">if</span> cleartext <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="859"></td><td><pre>            logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'decrypting [%s] failed, copying it'</span><span class="token punctuation">,</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="860"></td><td><pre>            dest_file <span class="token operator">=</span> media_unk_dir<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>name<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="861"></td><td><pre>            dest_file<span class="token punctuation">.</span>parent<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> exist_ok<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="862"></td><td><pre>            dest_file<span class="token punctuation">.</span>write_bytes<span class="token punctuation">(</span>entry<span class="token punctuation">.</span>read_bytes<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="863"></td><td><pre></pre></td></tr><tr><td data-num="864"></td><td><pre></pre></td></tr><tr><td data-num="865"></td><td><pre><span class="token comment"># --- decrypt_backup ----------------------------------------------------------</span></pre></td></tr><tr><td data-num="866"></td><td><pre></pre></td></tr><tr><td data-num="867"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_backup</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> path_in<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="868"></td><td><pre></pre></td></tr><tr><td data-num="869"></td><td><pre>    decrypt_info <span class="token operator">=</span> parse_info_xml<span class="token punctuation">(</span>path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'info.xml'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="870"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> decrypt_info<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="871"></td><td><pre>        logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'failed to parse info.xml'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="872"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="873"></td><td><pre></pre></td></tr><tr><td data-num="874"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="875"></td><td><pre>        logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'Decryptor checks failed. Unable to decrypt'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="876"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="877"></td><td><pre></pre></td></tr><tr><td data-num="878"></td><td><pre>    xml_files <span class="token operator">=</span> path_in<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*.xml'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="879"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> xml_files<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="880"></td><td><pre>        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>name <span class="token operator">!=</span> <span class="token string">'info.xml'</span> <span class="token keyword">and</span> <span class="token keyword">not</span> entry<span class="token punctuation">.</span>name<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'._'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="881"></td><td><pre>            parse_generic_xml<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> decrypt_info<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="882"></td><td><pre></pre></td></tr><tr><td data-num="883"></td><td><pre>    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="884"></td><td><pre></pre></td></tr><tr><td data-num="885"></td><td><pre>    decrypt_files_in_root<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> path_in<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="886"></td><td><pre></pre></td></tr><tr><td data-num="887"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> path_in<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="888"></td><td><pre>        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="889"></td><td><pre>            decrypt_files_in_folder<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="890"></td><td><pre></pre></td></tr><tr><td data-num="891"></td><td><pre><span class="token comment"># --- decrypt_media -----------------------------------------------------------</span></pre></td></tr><tr><td data-num="892"></td><td><pre></pre></td></tr><tr><td data-num="893"></td><td><pre><span class="token keyword">def</span> <span class="token function">decrypt_media</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> path_in<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="894"></td><td><pre></pre></td></tr><tr><td data-num="895"></td><td><pre>    <span class="token comment"># [TODO][TBR] Should parse media.db sqlite.</span></pre></td></tr><tr><td data-num="896"></td><td><pre></pre></td></tr><tr><td data-num="897"></td><td><pre>    decrypt_info <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="898"></td><td><pre>    subfolder <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="899"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> path_in<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'**/info.xml'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="900"></td><td><pre>        decrypt_info <span class="token operator">=</span> parse_info_xml<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> password<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="901"></td><td><pre>        subfolder <span class="token operator">=</span> entry<span class="token punctuation">.</span>parent</pre></td></tr><tr><td data-num="902"></td><td><pre></pre></td></tr><tr><td data-num="903"></td><td><pre>    <span class="token keyword">if</span> decrypt_info <span class="token keyword">is</span> <span class="token boolean">None</span> <span class="token keyword">or</span> subfolder <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="904"></td><td><pre>        logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'unable to find or parse info.xml in media folder!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="905"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="906"></td><td><pre></pre></td></tr><tr><td data-num="907"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> decrypt_info<span class="token punctuation">.</span>decryptor<span class="token punctuation">.</span>good<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="908"></td><td><pre>        logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'Decryptor checks failed. Unable to decrypt'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="909"></td><td><pre>        <span class="token keyword">return</span></pre></td></tr><tr><td data-num="910"></td><td><pre></pre></td></tr><tr><td data-num="911"></td><td><pre>    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">.</span>dump<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="912"></td><td><pre></pre></td></tr><tr><td data-num="913"></td><td><pre>    <span class="token keyword">for</span> entry <span class="token keyword">in</span> subfolder<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="914"></td><td><pre>        <span class="token keyword">if</span> entry<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="915"></td><td><pre>            decrypt_files_in_folder<span class="token punctuation">(</span>decrypt_info<span class="token punctuation">,</span> entry<span class="token punctuation">,</span> path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="916"></td><td><pre></pre></td></tr><tr><td data-num="917"></td><td><pre><span class="token comment"># --- main --------------------------------------------------------------------</span></pre></td></tr><tr><td data-num="918"></td><td><pre></pre></td></tr><tr><td data-num="919"></td><td><pre><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span>password<span class="token punctuation">,</span> backup_path_in<span class="token punctuation">,</span> dest_path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">,</span> writable<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="920"></td><td><pre></pre></td></tr><tr><td data-num="921"></td><td><pre>    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'searching backup in [%s]'</span><span class="token punctuation">,</span> backup_path_in<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="922"></td><td><pre></pre></td></tr><tr><td data-num="923"></td><td><pre>    files_folder <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="924"></td><td><pre>    <span class="token keyword">if</span> backup_path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'info.xml'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>exists<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="925"></td><td><pre>        files_folder <span class="token operator">=</span> backup_path_in</pre></td></tr><tr><td data-num="926"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="927"></td><td><pre>        <span class="token keyword">if</span> backup_path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'backupFiles1'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="928"></td><td><pre>            files_folder <span class="token operator">=</span> backup_path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'backupFiles1'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="929"></td><td><pre>            info_xml <span class="token operator">=</span> <span class="token builtin">next</span><span class="token punctuation">(</span>files_folder<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'**/info.xml'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="930"></td><td><pre>            <span class="token keyword">if</span> info_xml<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="931"></td><td><pre>                files_folder <span class="token operator">=</span> info_xml<span class="token punctuation">.</span>parent</pre></td></tr><tr><td data-num="932"></td><td><pre>            <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="933"></td><td><pre>                logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Unable to find info.xml in backupFiles1!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="934"></td><td><pre>                <span class="token keyword">return</span></pre></td></tr><tr><td data-num="935"></td><td><pre>        <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="936"></td><td><pre>            logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'No backup1 folder nor info.xml file found!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="937"></td><td><pre>            <span class="token keyword">return</span></pre></td></tr><tr><td data-num="938"></td><td><pre></pre></td></tr><tr><td data-num="939"></td><td><pre>    <span class="token keyword">if</span> files_folder<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="940"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'got info.xml, going to decrypt backup files'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="941"></td><td><pre>        decrypt_backup<span class="token punctuation">(</span>password<span class="token punctuation">,</span> files_folder<span class="token punctuation">,</span> dest_path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="942"></td><td><pre></pre></td></tr><tr><td data-num="943"></td><td><pre>    media_folder <span class="token operator">=</span> <span class="token boolean">None</span></pre></td></tr><tr><td data-num="944"></td><td><pre>    <span class="token keyword">if</span> backup_path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'media'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="945"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'got media folder, going to decrypt media files'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="946"></td><td><pre>        media_folder <span class="token operator">=</span> backup_path_in<span class="token punctuation">.</span>joinpath<span class="token punctuation">(</span><span class="token string">'media'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="947"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="948"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'No media folder found.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="949"></td><td><pre></pre></td></tr><tr><td data-num="950"></td><td><pre>    <span class="token keyword">if</span> media_folder<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="951"></td><td><pre>        decrypt_media<span class="token punctuation">(</span>password<span class="token punctuation">,</span> media_folder<span class="token punctuation">,</span> dest_path_out<span class="token punctuation">,</span> expandtar<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="952"></td><td><pre></pre></td></tr><tr><td data-num="953"></td><td><pre>    <span class="token keyword">if</span> writable<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="954"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Not setting read-only on decrypted files'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="955"></td><td><pre>    <span class="token keyword">else</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="956"></td><td><pre>        logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'setting all decrypted files to read-only'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="957"></td><td><pre>        <span class="token keyword">for</span> entry <span class="token keyword">in</span> dest_path_out<span class="token punctuation">.</span>glob<span class="token punctuation">(</span><span class="token string">'**/*'</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="958"></td><td><pre>            <span class="token comment"># Set read-only permission if entry is a file.</span></pre></td></tr><tr><td data-num="959"></td><td><pre>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isfile<span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="960"></td><td><pre>                os<span class="token punctuation">.</span>chmod<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token number">0o444</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="961"></td><td><pre>            <span class="token comment"># *nix directories require execute permission to read/traverse</span></pre></td></tr><tr><td data-num="962"></td><td><pre>            <span class="token keyword">elif</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>entry<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="963"></td><td><pre>                os<span class="token punctuation">.</span>chmod<span class="token punctuation">(</span>entry<span class="token punctuation">,</span> <span class="token number">0o555</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="964"></td><td><pre></pre></td></tr><tr><td data-num="965"></td><td><pre></pre></td></tr><tr><td data-num="966"></td><td><pre><span class="token comment"># --- entry point and parameters checks ---------------------------------------</span></pre></td></tr><tr><td data-num="967"></td><td><pre></pre></td></tr><tr><td data-num="968"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="969"></td><td><pre></pre></td></tr><tr><td data-num="970"></td><td><pre>    <span class="token keyword">if</span> sys<span class="token punctuation">.</span>version_info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="971"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">'Python 3 or a more recent version is required.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="972"></td><td><pre>    <span class="token keyword">elif</span> sys<span class="token punctuation">.</span>version_info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="973"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">'Python 3.7 or a more recent version is required.'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="974"></td><td><pre></pre></td></tr><tr><td data-num="975"></td><td><pre>    description <span class="token operator">=</span> <span class="token string">'Huawei KoBackup decryptor version &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>VERSION<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="976"></td><td><pre>    parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span>description<span class="token operator">=</span>description<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="977"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'password'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'user password for the backup'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="978"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'backup_path'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'backup folder'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="979"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'dest_path'</span><span class="token punctuation">,</span> <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'decrypted backup folder'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="980"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-e'</span><span class="token punctuation">,</span> <span class="token string">'--expandtar'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="981"></td><td><pre>                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'expand tar files'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="982"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-w'</span><span class="token punctuation">,</span> <span class="token string">'--writable'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store_true'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="983"></td><td><pre>                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'do not set RO pemission on decrypted data'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="984"></td><td><pre>    parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'-v'</span><span class="token punctuation">,</span> <span class="token string">'--verbose'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'count'</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="985"></td><td><pre>                        <span class="token builtin">help</span><span class="token operator">=</span><span class="token string">'verbose level, -v to -vvv'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="986"></td><td><pre>    args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="987"></td><td><pre></pre></td></tr><tr><td data-num="988"></td><td><pre>    log_level <span class="token operator">=</span> logging<span class="token punctuation">.</span>CRITICAL</pre></td></tr><tr><td data-num="989"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> args<span class="token punctuation">.</span>verbose<span class="token punctuation">:</span></pre></td></tr><tr><td data-num="990"></td><td><pre>        log_level <span class="token operator">=</span> logging<span class="token punctuation">.</span>ERROR</pre></td></tr><tr><td data-num="991"></td><td><pre>    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>verbose <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="992"></td><td><pre>        log_level <span class="token operator">=</span> logging<span class="token punctuation">.</span>WARNING</pre></td></tr><tr><td data-num="993"></td><td><pre>    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>verbose <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="994"></td><td><pre>        log_level <span class="token operator">=</span> logging<span class="token punctuation">.</span>INFO</pre></td></tr><tr><td data-num="995"></td><td><pre>    <span class="token keyword">elif</span> args<span class="token punctuation">.</span>verbose <span class="token operator">>=</span> <span class="token number">3</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="996"></td><td><pre>        log_level <span class="token operator">=</span> logging<span class="token punctuation">.</span>DEBUG</pre></td></tr><tr><td data-num="997"></td><td><pre></pre></td></tr><tr><td data-num="998"></td><td><pre>    logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>log_level<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="999"></td><td><pre></pre></td></tr><tr><td data-num="1000"></td><td><pre>    user_password <span class="token operator">=</span> args<span class="token punctuation">.</span>password<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1001"></td><td><pre></pre></td></tr><tr><td data-num="1002"></td><td><pre>    backup_path <span class="token operator">=</span> pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>backup_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1003"></td><td><pre>    <span class="token keyword">if</span> <span class="token keyword">not</span> backup_path<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="1004"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">'Backup folder does not exist!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1005"></td><td><pre></pre></td></tr><tr><td data-num="1006"></td><td><pre>    dest_path <span class="token operator">=</span> pathlib<span class="token punctuation">.</span>Path<span class="token punctuation">(</span>args<span class="token punctuation">.</span>dest_path<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1007"></td><td><pre>    <span class="token keyword">if</span> dest_path<span class="token punctuation">.</span>is_dir<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="1008"></td><td><pre>        sys<span class="token punctuation">.</span>exit<span class="token punctuation">(</span><span class="token string">'Destination folder already exists!'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1009"></td><td><pre></pre></td></tr><tr><td data-num="1010"></td><td><pre>    <span class="token comment"># Make directory with read and execute permission (=read and traverse)</span></pre></td></tr><tr><td data-num="1011"></td><td><pre>    dest_path<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span><span class="token number">0o755</span><span class="token punctuation">,</span> parents<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="1012"></td><td><pre></pre></td></tr><tr><td data-num="1013"></td><td><pre>    main<span class="token punctuation">(</span>user_password<span class="token punctuation">,</span> backup_path<span class="token punctuation">,</span> dest_path<span class="token punctuation">,</span> args<span class="token punctuation">.</span>expandtar<span class="token punctuation">,</span> args<span class="token punctuation">.</span>writable<span class="token punctuation">)</span></pre></td></tr></table></figure><h1 id="使用说明"><a class="anchor" href="#使用说明">#</a> 使用说明</h1><h2 id="kobackupdec"><a class="anchor" href="#kobackupdec">#</a> kobackupdec</h2><p>Huawei backup decryptor</p><p><em>This script is introduced by the blog post at <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmRpZ2l0YWwtZm9yZW5zaWNzLml0LzIwMTkvMDcvaHVhd2VpLWJhY2t1cC1kZWNyeXB0b3IuaHRtbA==">https://blog.digital-forensics.it/2019/07/huawei-backup-decryptor.html</span>.</em></p><p>The <code>kobackupdec</code> is a Python3 script aimed to decrypt Huawei <em>HiSuite</em> or <em>KoBackup</em> (the Android app) backups. When decrypting and uncompressing the archives, it will re-organize the output folders structure trying to <em>mimic</em> the typical Android one. The script will work both on Windows and Linux hosts, provided the PyCryptoDome dependency. Starting from <strong>20100107</strong> the script was rewritten to handle v9 and v10 kobackup backups structures.</p><h2 id="eol"><a class="anchor" href="#eol">#</a> <em>EOL</em></h2><p>On 1.1.2021 the script will get its <em>end of life</em> status. It was needed two years ago to overcome issues for some Huawei devices' forensics acquisitions. Now commercial forensics solutions include the very same capabilities, and much more: there are no more reasons to maintain it. We've got messages from guys using this script to manage theirs backups: we do not recommend it, and we did not write it for this reason. Anyhow we're happy some of you did find it useful, and we thank you for the feedback. We shared it to the community, trying to give back something: if someone has any interest in maintaining it, please let us know so we can include a link to the project.</p><h2 id="usage"><a class="anchor" href="#usage">#</a> Usage</h2><p>The script <em>assumes</em> that backups are encrypted with a user-provided password. Actually it does not support the HiSuite <em>self</em> generated password, when the user does not provide its own.</p><pre><code>usage: kobackupdec.py [-h] [-v] password backup_path dest_path

Huawei KoBackup decryptor version 20200611

positional arguments:
  password       user password for the backup
  backup_path    backup folder
  dest_path      decrypted backup folder

optional arguments:
  -h, --help       show this help message and exit
  -e, --expandtar  expand tar files
  -w, --writable   do not set RO pemission on decrypted data
  -v, --verbose    verbose level, -v to -vvv
</code></pre><ul><li><code>password</code> , is the user provided password.</li><li><code>backup_path</code> , is the folder containing the Huawei backup, relative or absolute paths can be used.</li><li><code>dest_path</code> , is the folder to be created in the specified path, absolute or relative. It will complain if the provided folder already exists.</li><li><code>[-v]</code> (from <code>-v</code> to <code>-vvv</code> ) verbosity level, written on <em>stderr</em>. It's suggested to use <em>-vvv</em> with a redirect to get a log of the process.</li></ul><h3 id="example"><a class="anchor" href="#example">#</a> Example</h3><pre><code>Z:\&gt; py -3 kobackupdec.py -vvv 123456 &quot;Z:\HUAWEI P30 Pro_2019-06-28 22.56.31&quot; Z:\HiSuiteBackup
INFO:root:getting files and folder from Z:\HUAWEI P30 Pro_2019-06-28 22.56.31
INFO:root:parsing XML files...
INFO:root:parsing xml audio.xml
DEBUG:root:parsing xml file audio.xml
INFO:root:parsing xml document.xml
DEBUG:root:parsing xml file document.xml
INFO:root:parsing xml info.xml
DEBUG:root:ignoring entry HeaderInfo
DEBUG:root:ignoring entry BackupFilePhoneInfo
DEBUG:root:ignoring entry BackupFileVersionInfo
INFO:root:parsing xml picture.xml
DEBUG:root:parsing xml file picture.xml
INFO:root:parsing xml soundrecorder.xml
DEBUG:root:parsing xml file soundrecorder.xml
INFO:root:parsing xml video.xml
DEBUG:root:parsing xml file video.xml
DEBUG:root:crypto_init: using version 3.
DEBUG:root:SHA256(BKEY)[16] = b'8d969eef6ecad3c29a3a629280e686cf'
...
</code></pre><p>The <strong>output</strong> folder structure will be similar to the following one: <em>data/data</em> applications will be exploded in their proper paths, and the APKs will be <em>restored</em> too (not icons, actually). Note that the <strong>db</strong> folder will contain the <em>special</em> databases as created by the Huawei backups.</p><pre><code>HiSuiteBackup
|-- data
|   |-- app
|   |   |-- de.sec.mobile.apk-1
|   |   | [...]
|   |   `-- org.telegram.messenger.apk-1
|   `-- data
|       |-- de.sec.mobile
|       | [...]
|       `-- org.telegram.messenger
|-- db
|   |-- HWlanucher.db
|   |-- Memo.db
|   |-- alarm.db
|   |-- calendar.db
|   |-- calllog.db
|   |-- camera.db
|   |-- clock.db
|   |-- contact.db
|   |-- harassment.db
|   |-- phoneManager.db
|   |-- setting.db
|   |-- sms.db
|   |-- soundrecorder.db
|   |-- systemUI.db
|   |-- weather.db
|   `-- wifiConfig.db
`-- storage
    |-- DCIM
    |-- Download
    |-- Huawei
    |-- MagazineUnlock
    |-- Notifications
    |-- Pictures
    |-- WhatsApp
    |-- mp3
    |-- parallel_intl
    `-- s8-wallpapers-9011.PNG
</code></pre><div class="tags"><a href="/tags/%E6%89%8B%E6%9C%BA/" rel="tag"><i class="ic i-tag"></i> 手机</a> <a href="/tags/hisuite/" rel="tag"><i class="ic i-tag"></i> hisuite</a> <a href="/tags/%E8%A7%A3%E5%AF%86/" rel="tag"><i class="ic i-tag"></i> 解密</a></div></div><footer><div class="meta"><span id="2021/8/华为Hisuite备份解密/" class="item leancloud_visitors" data-flag-title="华为Hisuite备份解密" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>黑麋鹿 <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://sirliu.github.io/2021/8/%E5%8D%8E%E4%B8%BAHisuite%E5%A4%87%E4%BB%BD%E8%A7%A3%E5%AF%86/" title="华为Hisuite备份解密">https://sirliu.github.io/2021/8/华为Hisuite备份解密/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/8/Kali%20Linux%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;api.ixiaowai.cn&#x2F;gqapi&#x2F;gqapi.php?id&#x3D;521224" title="转载-Kali Linux科学上网"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> VPN</span><h3>转载-Kali Linux科学上网</h3></a></div><div class="item right"><a href="/2021/8/EMUI11%E9%99%8D%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%8C%E7%90%86%E8%AE%BA%E9%80%82%E7%94%A8%E4%BA%8E%E5%8D%8E%E4%B8%BA%E5%85%A8%E7%B3%BB%E5%88%97/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;api.ixiaowai.cn&#x2F;gqapi&#x2F;gqapi.php?id&#x3D;896227" title="Emui 11降级教程，理论适用于华为全系列"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 手机</span><h3>Emui 11降级教程，理论适用于华为全系列</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%BA%90%E7%A0%81"><span class="toc-number">1.</span> <span class="toc-text">源码</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">2.</span> <span class="toc-text">使用说明</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#kobackupdec"><span class="toc-number">2.1.</span> <span class="toc-text">kobackupdec</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eol"><span class="toc-number">2.2.</span> <span class="toc-text">EOL</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#usage"><span class="toc-number">2.3.</span> <span class="toc-text">Usage</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#example"><span class="toc-number">2.3.1.</span> <span class="toc-text">Example</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/8/%E5%8D%8E%E4%B8%BA%E6%89%8B%E6%9C%BA%E5%AE%89%E8%A3%85Google%E6%A1%86%E6%9E%B6/" rel="bookmark" title="华为手机安装Google框架">华为手机安装Google框架</a></li><li class="active"><a href="/2021/8/%E5%8D%8E%E4%B8%BAHisuite%E5%A4%87%E4%BB%BD%E8%A7%A3%E5%AF%86/" rel="bookmark" title="华为Hisuite备份解密">华为Hisuite备份解密</a></li><li><a href="/2021/8/EMUI11%E9%99%8D%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%8C%E7%90%86%E8%AE%BA%E9%80%82%E7%94%A8%E4%BA%8E%E5%8D%8E%E4%B8%BA%E5%85%A8%E7%B3%BB%E5%88%97/" rel="bookmark" title="Emui 11降级教程，理论适用于华为全系列">Emui 11降级教程，理论适用于华为全系列</a></li><li><a href="/2021/8/MATE30%20EMUI%2011%E5%88%B7%E8%B0%B7%E6%AD%8C%E6%A1%86%E6%9E%B6(GMS)/" rel="bookmark" title="MATE30 EMUI 11刷谷歌框架(GMS)">MATE30 EMUI 11刷谷歌框架(GMS)</a></li><li><a href="/2021/8/%E5%85%8DROOT%E5%88%A0%E9%99%A4%E5%8D%8E%E4%B8%BA%E6%89%8B%E6%9C%BA%E5%86%85%E7%BD%AE%E5%BA%94%E7%94%A8%E5%B7%A5%E5%85%B7%E5%8F%8A%E6%95%99%E7%A8%8B/" rel="bookmark" title="免ROOT删除华为手机内置应用工具及教程">免ROOT删除华为手机内置应用工具及教程</a></li><li><a href="/2021/9/mate8%E5%86%85%E7%BD%AE%E5%BA%94%E7%94%A8%E5%88%A0%E9%99%A4%E8%AE%B0%E5%BD%95/" rel="bookmark" title="mate8内置应用删除记录">mate8内置应用删除记录</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="黑麋鹿" data-src="/images/avatar.jpg"><p class="name" itemprop="name">黑麋鹿</p><div class="description" itemprop="description">折腾之路</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">178</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">35</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">89</span> <span class="name">标签</span></a></div></nav><div class="social"><a href="https://github.com/sirliu" title="https:&#x2F;&#x2F;github.com&#x2F;sirliu" class="item github" rel="noopener" target="_blank"><i class="ic i-github"></i></a> <a href="https://twitter.com/" title="https:&#x2F;&#x2F;twitter.com&#x2F;" class="item twitter" rel="noopener" target="_blank"><i class="ic i-twitter"></i></a> <a href="https://www.zhihu.com/" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;" class="item zhihu" rel="noopener" target="_blank"><i class="ic i-zhihu"></i></a> <a href="https://music.163.com/" title="https:&#x2F;&#x2F;music.163.com&#x2F;" class="item music" rel="noopener" target="_blank"><i class="ic i-cloud-music"></i></a> <a href="https://weibo.com/" title="https:&#x2F;&#x2F;weibo.com&#x2F;" class="item weibo" rel="noopener" target="_blank"><i class="ic i-weibo"></i></a> <a href="mailto:yourname@mail.com" title="mailto:yourname@mail.com" class="item email" rel="noopener" target="_blank"><i class="ic i-envelope"></i></a> <a href="https://www.facebook.com/" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;" class="item facebook" rel="noopener" target="_blank"><i class="ic i-facebook"></i></a> <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" class="item stackoverflow" rel="noopener" target="_blank"><i class="ic i-stack-overflow"></i></a> <a href="https://www.youtube.com/" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;" class="item youtube" rel="noopener" target="_blank"><i class="ic i-youtube"></i></a> <a href="https://instagram.com/" title="https:&#x2F;&#x2F;instagram.com&#x2F;" class="item instagram" rel="noopener" target="_blank"><i class="ic i-instagram"></i></a> <a href="skype:yourname?call|chat" title="skype:yourname?call|chat" class="item skype" rel="noopener" target="_blank"><i class="ic i-skype"></i></a> <a href="https://www.douban.com/" title="https:&#x2F;&#x2F;www.douban.com&#x2F;" class="item douban" rel="noopener" target="_blank"><i class="ic i-douban"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/8/Kali%20Linux%E7%A7%91%E5%AD%A6%E4%B8%8A%E7%BD%91/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/8/EMUI11%E9%99%8D%E7%BA%A7%E6%95%99%E7%A8%8B%EF%BC%8C%E7%90%86%E8%AE%BA%E9%80%82%E7%94%A8%E4%BA%8E%E5%8D%8E%E4%B8%BA%E5%85%A8%E7%B3%BB%E5%88%97/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">黑麋鹿 @ Black Elk</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">729k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">11:03</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka" rel="noopener" target="_blank">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/8/华为Hisuite备份解密/",favicon:{show:"BlackELK",hide:"看看再走吧"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->