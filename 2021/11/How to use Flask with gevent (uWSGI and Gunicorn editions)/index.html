<!-- build time:Wed Dec 21 2022 16:01:17 GMT+0800 (China Standard Time) --><!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" href="https://sirliu.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" href="https://sirliu.github.io/atom.xml"><link rel="alternate" type="application/json" href="https://sirliu.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CMicrosoft%20YaHei:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="Python,Flask"><link rel="canonical" href="https://sirliu.github.io/2021/11/How%20to%20use%20Flask%20with%20gevent%20(uWSGI%20and%20Gunicorn%20editions)/"><title>How to use Flask with gevent (uWSGI and Gunicorn editions) - Python | Black Elk = = 潛龍勿用</title><meta name="generator" content="Hexo 5.4.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">How to use Flask with gevent (uWSGI and Gunicorn editions)</h1><div class="meta"><span class="item" title="创建时间：2021-11-08 21:50:15"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2021-11-08T21:50:15+08:00">2021-11-08</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>21k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>19 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Black Elk</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=380573"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=478423"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=983896"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=853828"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=238641"></li><li class="item" data-background-image="https://api.ixiaowai.cn/gqapi/gqapi.php?id=641058"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/Python/" itemprop="item" rel="index" title="分类于 Python"><span itemprop="name">Python</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://sirliu.github.io/2021/11/How%20to%20use%20Flask%20with%20gevent%20(uWSGI%20and%20Gunicorn%20editions)/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="黑麋鹿"><meta itemprop="description" content="潛龍勿用, 折腾之路"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content=""></span><div class="body md" itemprop="articleBody"><p>来源：<span class="exturl" data-url="aHR0cHM6Ly9peGltaXV6LmNvbS9lbi9wb3N0cy9mbGFzay1nZXZlbnQtdHV0b3JpYWwv">https://iximiuz.com/en/posts/flask-gevent-tutorial/</span></p><p>Disclaimer: I wrote this tutorial because gevent <span class="exturl" data-url="aHR0cHM6Ly9peGltaXV6LmNvbS9lbi9wb3N0cy9zYXZlLXRoZS1kYXktd2l0aC1nZXZlbnQv">saved our project a few years ago</span> and I still see steady gevent-related search traffic on my blog. So, the way gevent helped us may be useful for somebody else as well. Since I still have some handy knowledge I decided to make this note on how to set up things. However, I'd not advise starting a new project in 2020 using this technology. IMHO, it's aging and losing the traction._</p><p><em><strong>TL;DR: check out code samples <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFs">on GitHub</span>.</strong></em></p><p><span class="exturl" data-url="aHR0cHM6Ly90cmVuZHMuZ29vZ2xlLmNvbS90cmVuZHMvZXhwbG9yZT9kYXRlPWFsbCZhbXA7cT0lMkZtJTJGMDV6MV8=">Python is booming</span> and Flask is a pretty popular web-framework nowadays. Probably, quite some new projects are being started in Flask. But people should be aware, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BhbGxldHMvZmxhc2svaXNzdWVzLzMzMzk=">it's synchronous by design</span> and <span class="exturl" data-url="aHR0cHM6Ly9hc2dpLnJlYWR0aGVkb2NzLmlvL2VuL2xhdGVzdC8=">ASGI</span> is <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BhbGxldHMvd2Vya3pldWcvaXNzdWVzLzEzMjI=">not a thing yet</span>. So, if someday you realize that your project really needs asynchronous I/O but you already have a considerable codebase on top of Flask, this tutorial is for you. The charming <span class="exturl" data-url="aHR0cDovL3d3dy5nZXZlbnQub3JnLw==">gevent</span> library will enable you to keep using Flask while start benefiting from all the I/O being asynchronous. In the tutorial we will see:</p><ul><li>How to monkey patch a Flask app to make it asynchronous w/o changing its code.</li><li>How to run the patched application using <span class="exturl" data-url="aHR0cDovL3d3dy5nZXZlbnQub3JnL2FwaS9nZXZlbnQucHl3c2dpLmh0bWw=">gevent.pywsgi</span> application server.</li><li>How to run the patched application using <span class="exturl" data-url="aHR0cHM6Ly9ndW5pY29ybi5vcmcv">Gunicorn</span> application server.</li><li>How to run the patched application using <span class="exturl" data-url="aHR0cHM6Ly91d3NnaS1kb2NzLnJlYWR0aGVkb2NzLmlvL2VuL2xhdGVzdC9pbmRleC5odG1s">uWSGI</span> application server.</li><li>How to configure <span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcv">Nginx</span> proxy in front of the application server.</li><li>[Bonus] How to use <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3BzeWNvcGcvcHN5Y29wZzI=">psycopg2</span> with <span class="exturl" data-url="aHR0cHM6Ly9iaXRidWNrZXQub3JnL2R2YXJyYXp6by9wc3ljb2dyZWVuLw==">psycogreen</span> to make PostgreSQL access non-blocking.</li></ul><h2 id="when-do-i-need-asynchronous-io"><a class="anchor" href="#when-do-i-need-asynchronous-io">#</a> When do I need asynchronous I/O</h2><p>The answer is somewhat naive - you need it when the application's workload is I/O bound, i.e. it maxes out on <span class="exturl" data-url="aHR0cHM6Ly9sYW5kaW5nLmdvb2dsZS5jb20vc3JlL3NyZS1ib29rL2NoYXB0ZXJzL3NlcnZpY2UtbGV2ZWwtb2JqZWN0aXZlcy8=">latency SLI</span> due to over-communicating to external services. It's a pretty common situation nowadays due to the enormous spread of microservice architectures and various 3rd-party APIs. If an average HTTP handler in your application needs to make 10+ network requests to build a response, it's <em>highly likely</em> that you will benefit from asynchronous I/O. On the other hand, if your application consumes 100% of CPU or RAM handling requests, migrating to asynchronous I/O <em>probably</em> will not help.</p><h2 id="what-is-gevent"><a class="anchor" href="#what-is-gevent">#</a> What is gevent</h2><p>From <span class="exturl" data-url="aHR0cDovL3d3dy5nZXZlbnQub3JnLw==">the official site</span> description:</p><blockquote><p>gevent is a coroutine-based Python networking library that uses greenlet to provide a high-level synchronous API on top of the libev or libuv event loop.</p></blockquote><p>The description is rather obscure for those who are unfamiliar with the mentioned dependencies like <em>greenlet</em>, <em>libev</em>, or <em>libuv</em>. You can check out <span class="exturl" data-url="aHR0cHM6Ly9peGltaXV6LmNvbS9lbi9wb3N0cy9zYXZlLXRoZS1kYXktd2l0aC1nZXZlbnQvI3NvbHZpbmctcHJvYmxlbS13aXRoLXplcm8tbGluZXMtb2YtY29kZQ==">my previous attempt to briefly explain the nature of this library</span>, but among other things it allows you to <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvTW9ua2V5X3BhdGNo">monkey patch</span> normal-looking Python code and make the underlying I/O happening asynchronously. The patching introduces what's called <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQ29vcGVyYXRpdmVfbXVsdGl0YXNraW5n">cooperative multitasking</span> into the Python standard library and some 3rd-party modules but the change stays almost completely hidden from the application and the existing code keeps its synchronous-alike outlook while gains the ability to serve requests asynchronously. There is an obvious downside of this approach - the patching doesn't change the way every single HTTP request is being served, i.e. the I/O within each HTTP handler still happens sequentially, even though it becomes asynchronous. Well, we can start using <span class="exturl" data-url="aHR0cDovL3d3dy5nZXZlbnQub3JnL2FwaS9nZXZlbnQuaHRtbCNnZXZlbnQud2FpdA==">something similar</span> to <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L2FzeW5jaW8tdGFzay5odG1sI2FzeW5jaW8uZ2F0aGVy">asyncio.gather()</span> and parallelize some requests to external resources, but it would require the modification of the existing application code. However, now we can easily scale up the limit of concurrent HTTP requests for our application. After the patching, we don't need a dedicated thread (or process) per request anymore. Instead, each request handling now happens in a lightweight green thread. Thus, the application can serve tens of thousands of concurrent requests, probably increasing this number by 1-2 orders of magnitude from the previous limit.</p><p>However, while the description sounds extremely promising (at least to me), the project and the surrounding eco-system is steadily losing traction (in favor of <em>asyncio</em> and <em>aiohttp</em>?):</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/gevent-vs-asyncio-google-trends-1200-opt.png" alt=""></p><h2 id="create-simple-flask-application"><a class="anchor" href="#create-simple-flask-application">#</a> Create simple Flask application</h2><p>The standard tutorial format always seemed boring to me. Instead, we will try to make a tiny playground here. We will try to create a simple Flask application dependant on a sleepy 3rd party API endpoint. The only route of our application will be responding with some hard-coded string concatenated with the API response text. Having such a workload, we will play with different methods of achieving high concurrency in the Flask's handling of HTTP requests.</p><p>First, we need to emulate <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3Nsb3dfYXBpL2FwaS5weQ==">a slow 3rd party API</span>. We will use <span class="exturl" data-url="aHR0cHM6Ly9haW9odHRwLnJlYWR0aGVkb2NzLmlvL2VuL3N0YWJsZS8=">aiohttp</span> to implement it because it's based on the <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLnB5dGhvbi5vcmcvMy9saWJyYXJ5L2FzeW5jaW8uaHRtbA==">asyncio</span> library and provides high concurrency for I/O-bound HTTP requests handling out of the box:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./slow_api/api.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> asyncio</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> aiohttp <span class="token keyword">import</span> web</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">async</span> <span class="token keyword">def</span> <span class="token function">handle</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    delay <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>query<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'delay'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">await</span> asyncio<span class="token punctuation">.</span>sleep<span class="token punctuation">(</span>delay<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">return</span> web<span class="token punctuation">.</span>Response<span class="token punctuation">(</span>text<span class="token operator">=</span><span class="token string">'slow api response'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre>app <span class="token operator">=</span> web<span class="token punctuation">.</span>Application<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre>app<span class="token punctuation">.</span>add_routes<span class="token punctuation">(</span><span class="token punctuation">[</span>web<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> handle<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    web<span class="token punctuation">.</span>run_app<span class="token punctuation">(</span>app<span class="token punctuation">,</span> port<span class="token operator">=</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PORT'</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>We can launch it in the following <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3Nsb3dfYXBpL0RvY2tlcmZpbGU=">Docker container</span>:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./slow_api/Dockerfile</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install aiohttp</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> api.py /api.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"python"</span>, <span class="token string">"/api.py"</span>]</span></pre></td></tr></table></figure><p>Now, it's time to create <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9hcHAucHk=">the target Flask application</span>:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/app.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request</pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>api_port <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PORT_API'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="7"></td><td><pre>api_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'http://slow_api:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>api_port<span class="token punctuation">&#125;</span></span><span class="token string">/'</span></span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    delay <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'delay'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>api_url<span class="token punctuation">&#125;</span></span><span class="token string">?delay=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>delay<span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Hi there! '</span> <span class="token operator">+</span> resp<span class="token punctuation">.</span>text</pre></td></tr></table></figure><p>As promised, it's fairly simple.</p><h2 id="deploy-flask-application-using-flask-dev-server"><a class="anchor" href="#deploy-flask-application-using-flask-dev-server">#</a> Deploy Flask application using Flask dev server</h2><p>The easiest way to run a Flask application is to use <span class="exturl" data-url="aHR0cHM6Ly9mbGFzay5wYWxsZXRzcHJvamVjdHMuY29tL2VuLzEuMS54L3NlcnZlci8=">a built-in development server</span>. But even this beast supports two modes of request handling.</p><p>In the <em>single-threaded mode</em>, a Flask application can handle no more than one HTTP request at a time. I.e. the request handling becomes sequential.</p><p>Experience 🤦</p><pre><code>This mode can be dangerous. If an application needs to send a request to itself it may get stuck in a deadlock.
</code></pre><p>In the <em>multi-threaded mode</em>, Flask spawns a thread for every incoming HTTP request. The maximal concurrency, i.e. the highest possible number of simultaneous threads doesn't seem configurable though.</p><p>We will use <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLWRldnNlcnZlcg==">the following Dockerfile</span> to run the Flask dev server:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-devserver</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token instruction"><span class="token keyword">ENV</span> FLASK_APP=app</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> flask run --no-reload <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="11"></td><td><pre>  --<span class="token variable">$THREADS</span>-threads <span class="token operator">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  --host 0.0.0.0 --port <span class="token variable">$PORT_APP</span></pre></td></tr></table></figure><p>Let's spin up <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3N5bmMtZGV2c2VydmVyLnltbA==">the first playground</span> using handy <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29tcG9zZS8=">Docker Compose</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./sync-devserver.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>devserver</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> THREADS=without</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">flask_app_threaded</span><span class="token punctuation">:</span> <span class="token comment"># extends: flask_app</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>devserver</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3001</pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">-</span> THREADS=with</pre></td></tr><tr><td data-num="27"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3001:3001"</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="35"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="36"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="37"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="38"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>After running <code>docker-compose build</code> and <code>docker-compose up</code> we will have two instances of our application running. The single-threaded version is bound to the host's <code>127.0.0.1:3000</code> , the multi-threaded - to <code>127.0.0.1:3001</code> .</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by Flask dev server</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f sync-devserver.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f sync-devserver.yml up</pre></td></tr></table></figure><p>It's time to serve the first portion of HTTP requests (using lovely <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvQXBhY2hlQmVuY2g=">ApacheBench</span>). We will start from the single-threaded version and only 10 requests:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Test single-threaded deployment</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ ab -r -n <span class="token number">10</span> -c <span class="token number">5</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">5</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">10.139</span> seconds</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">10</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">0.99</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>As expected, we observed no concurrency. Even though we asked <code>ab</code> to simulate 5 simultaneous clients using <code>-c 5</code> , it took ~10 seconds to finish the scenario with an effective request rate close to 1 per second.</p><p>If you execute <code>top -H</code> in the server container to check the number of running threads, the picture will be similar to this:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H</em></p><p>Let's proceed to the multi-threaded version alongside with increasing the payload up to 2000 requests being produced by 200 simultaneous clients:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Test multi-threaded deployment</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3001/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">200</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">16.040</span> seconds</pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">124.69</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>The effective concurrency grew to the mean of 124 requests per second, but a sample from <code>top -H</code> shows, that at some point of time we had 192 threads and 190 of them were sleeping:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-devserver-threaded-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_threaded_1 top -H</em></p><h2 id="deploy-flask-application-using-geventpywsgi"><a class="anchor" href="#deploy-flask-application-using-geventpywsgi">#</a> Deploy Flask application using gevent.pywsgi</h2><p>The fastest way to unleash the power of gevent is to use its built-in <span class="exturl" data-url="aHR0cHM6Ly9lbi53aWtpcGVkaWEub3JnL3dpa2kvV2ViX1NlcnZlcl9HYXRld2F5X0ludGVyZmFjZQ==">WSGI-server</span> called <span class="exturl" data-url="aHR0cDovL3d3dy5nZXZlbnQub3JnL2FwaS9nZXZlbnQucHl3c2dpLmh0bWw=">gevent.pywsgi</span>.</p><p>We need to create <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9weXdzZ2kucHk=">an entrypoint</span>:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/pywsgi.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey</pre></td></tr><tr><td data-num="3"></td><td><pre>monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">from</span> gevent<span class="token punctuation">.</span>pywsgi <span class="token keyword">import</span> WSGIServer</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token keyword">from</span> app <span class="token keyword">import</span> app</pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre>http_server <span class="token operator">=</span> WSGIServer<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'0.0.0.0'</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PORT_APP'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> app<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="10"></td><td><pre>http_server<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>Notice, how it patches our Flask application. Without <code>monkey.patch_all()</code> there would be no benefit from using gevent here because all the I/O in the application stayed synchronous.</p><p>The following <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLWdldmVudC1weXdzZ2k=">Dockerfile</span> can be used to run the pywsgi server:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-gevent-pywsgi</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests gevent</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> pywsgi.py /pywsgi.py</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> python /pywsgi.py</span></pre></td></tr></table></figure><p>Finally, let's prepare <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2FzeW5jLWdldmVudC1weXdzZ2kueW1s">the following playground</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./async-gevent-pywsgi.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gevent<span class="token punctuation">-</span>pywsgi</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> THREADS=without</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>And launch it using:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by gevent.pywsgi</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f async-gevent-pywsgi.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f async-gevent-pywsgi.yml up</pre></td></tr></table></figure><p>We expect a decent concurrency level with very few threads (if any) in the server container:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">200</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">17.536</span> seconds</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">114.05</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>Executing <code>top -H</code> shows that we DO have some python threads (around 10). Seems like gevent employs a thread pool to implement the asynchronous I/O:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-pywsgi-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H</em></p><h2 id="deploy-flask-application-using-gunicorn"><a class="anchor" href="#deploy-flask-application-using-gunicorn">#</a> Deploy Flask application using Gunicorn</h2><p>Gunicorn is <span class="exturl" data-url="aHR0cHM6Ly9mbGFzay5wYWxsZXRzcHJvamVjdHMuY29tL2VuLzEuMS54L2RlcGxveWluZy93c2dpLXN0YW5kYWxvbmUvI2d1bmljb3Ju">one of the recommended ways</span> to run Flask applications. We will start from Gunicorn because it has slightly fewer parameters to configure before going than uWSGI.</p><p>Gunicorn <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmd1bmljb3JuLm9yZy9lbi9zdGFibGUvZGVzaWduLmh0bWwjc2VydmVyLW1vZGVs">uses the worker process model</span> to serve HTTP requests. But there are multiple types of workers: <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmd1bmljb3JuLm9yZy9lbi9zdGFibGUvZGVzaWduLmh0bWwjc3luYy13b3JrZXJz">synchronous</span>, <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmd1bmljb3JuLm9yZy9lbi9zdGFibGUvZGVzaWduLmh0bWwjYXN5bmMtd29ya2Vycw==">asynchronous</span>, <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmd1bmljb3JuLm9yZy9lbi9zdGFibGUvZGVzaWduLmh0bWwjdG9ybmFkby13b3JrZXJz">tornado workers</span>, and <span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmd1bmljb3JuLm9yZy9lbi9zdGFibGUvZGVzaWduLmh0bWwjYXN5bmNpby13b3JrZXJz">asyncio workers</span>.</p><p>In this tutorial, we will cover only the first two types - synchronous and gevent-based asynchronous workers. Let's start from <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLWd1bmljb3Ju">the synchronous model</span>:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-gunicorn</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests gunicorn</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> gunicorn --workers <span class="token variable">$WORKERS</span> <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  --threads <span class="token variable">$THREADS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --bind 0.0.0.0:<span class="token variable">$PORT_APP</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  app:app</pre></td></tr></table></figure><p>Notice that we reuse the original <code>app.py</code> entrypoint without any changes. The <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3N5bmMtZ3VuaWNvcm4ueW1s">synchronous Gunicorn playground</span> looks as follows:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./sync-gunicorn.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app_gunicorn</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gunicorn</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=4</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> THREADS=50</pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>Let's build and start the server using 4 workers x 50 threads each (i.e. 200 threads in total):</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by Gunicorn</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f sync-gunicorn.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f sync-gunicorn.yml up</pre></td></tr></table></figure><p>Obviously, we expect a high number of requests being served concurrently:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">200</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">13.427</span> seconds</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">148.95</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>But if we compare the samples from <code>top -H</code> before and after the test, we can notice an interesting detail:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-before-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (before test)</em></p><p>Gunicorn starts workers on the startup, but the workers spawn the threads on-demand:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-during-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (during test)</em></p><p>Now, let's switch to gevent workers. For this setup we need to make <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9wYXRjaGVkLnB5">a new entrypoint</span> to apply the monkey patching:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/patched.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey</pre></td></tr><tr><td data-num="3"></td><td><pre>monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># we need to patch very early</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> app <span class="token keyword">import</span> app  <span class="token comment"># re-export</span></pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLWdldmVudC1ndW5pY29ybg==">The Dockerfile</span> to run Gunicorn + gevent:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-gevent-gunicorn</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests gunicorn gevent</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> patched.py /patched.py</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> gunicorn --worker-class gevent <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --workers <span class="token variable">$WORKERS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  --bind 0.0.0.0:<span class="token variable">$PORT_APP</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  patched:app</pre></td></tr></table></figure><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2FzeW5jLWdldmVudC1ndW5pY29ybi55bWw=">The playground</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./async-gevent-gunicorn.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gevent<span class="token punctuation">-</span>gunicorn</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=1</pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="17"></td><td><pre></pre></td></tr><tr><td data-num="18"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>Let's start it:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by Gunicorn + gevent</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f async-gevent-gunicorn.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f async-gevent-gunicorn.yml up</pre></td></tr></table></figure><p>And conduct the test:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">200</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">17.839</span> seconds</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">112.11</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>We observe similar behavior - only worker processes are alive before the test:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-before-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (before test)</em></p><p>But during the test, we see 10 new threads spawned. Notice, how it resembles the number of threads used by pywsgi:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-gunicorn-gevent-during-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_gunicorn_1 top -H (during test)</em></p><h2 id="deploy-flask-application-using-uwsgi"><a class="anchor" href="#deploy-flask-application-using-uwsgi">#</a> Deploy Flask application using uWSGI</h2><p><span class="exturl" data-url="aHR0cHM6Ly9mbGFzay5wYWxsZXRzcHJvamVjdHMuY29tL2VuLzEuMS54L2RlcGxveWluZy93c2dpLXN0YW5kYWxvbmUvI3V3c2dp">uWSGI</span> is a production-grade application server written in C. It's very fast and supports different execution models. Here we will again compare only two modes: synchronous (N worker processes x K threads each) and gevent-based (N worker processes x M async cores each).</p><p>First, <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLXV3c2dp">the synchronous setup</span>:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-uwsgi</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests uwsgi</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> uwsgi --master <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="9"></td><td><pre>  --workers <span class="token variable">$WORKERS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --threads <span class="token variable">$THREADS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  --protocol <span class="token variable">$PROTOCOL</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  --socket 0.0.0.0:<span class="token variable">$PORT_APP</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  --module app:app</pre></td></tr></table></figure><p>We use an extra parameters <code>--protocol</code> and <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3N5bmMtdXdzZ2kueW1s">the playground</span> sets it to <code>http</code> :</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./sync-uwsgi.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app_uwsgi</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>uwsgi</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=4</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> THREADS=50</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> PROTOCOL=http</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>We again limit the concurrency by 200 simultaneous HTTP requests (4 workers x 50 threads each):</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by uWSGI</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f sync-uwsgi.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f sync-uwsgi.yml up</pre></td></tr></table></figure><p>Let's send a bunch of HTTP requests:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">200</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">12.685</span> seconds</pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">157.67</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>uWSGI spaws workers and threads beforehand:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-before-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_uwsgi_1 top -H (before test)</em></p><p>So, only the load changes during the test:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-during-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_uwsgi_1 top -H (during test)</em></p><p>Let's proceed to <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9Eb2NrZXJmaWxlLWdldmVudC11d3NnaQ==">the gevent mode</span>. We can reuse the <a target="_blank" rel="noopener" href="https://github.com/iximiuz/flask-gevent-tutorial/blob/master/flask_app/patched.py"><code>patched.py</code> </a>entrypoint from the Gunicorn+gevent scenario:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/Dockerfile-gevent-uwsgi</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests uwsgi gevent</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> patched.py /patched.py</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> uwsgi --master <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --single-interpreter <span class="token operator">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  --workers <span class="token variable">$WORKERS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  --gevent <span class="token variable">$ASYNC_CORES</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  --protocol <span class="token variable">$PROTOCOL</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  --socket 0.0.0.0:<span class="token variable">$PORT_APP</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  --module patched:app</pre></td></tr></table></figure><p>One extra parameter <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2FzeW5jLWdldmVudC11d3NnaS55bWw=">the playground</span> sets here is <span class="exturl" data-url="aHR0cHM6Ly91d3NnaS1kb2NzLnJlYWR0aGVkb2NzLmlvL2VuL2xhdGVzdC9HZXZlbnQuaHRtbCNydW5uaW5nLXV3c2dpLWluLWdldmVudC1tb2Rl">the number of async cores</span> used by gevent:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./async-gevent-uwsgi.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gevent<span class="token punctuation">-</span>uwsgi</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=2</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> ASYNC_CORES=2000</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> PROTOCOL=http</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="24"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="25"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="26"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>Let's start the uWSGI+gevent server:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># Build and start app served by uWSGI + gevent</span></pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f async-gevent-uwsgi.yml build</pre></td></tr><tr><td data-num="3"></td><td><pre>$ docker-compose -f async-gevent-uwsgi.yml up</pre></td></tr></table></figure><p>And do the test:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">13.164</span> seconds</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">2000</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">151.93</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>However, if we check the number of workers before and during the test we will notice a discrepancy with the previous method:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-before-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H (before test)</em></p><p>Before the test, uWSGI had the master and worker processes only, but during the test, threads were started, somewhat around 10 threads per worker process. This number resembles the numbers from gevent.pywsgi and Gunicorn+gevent cases:</p><p><img data-src="https://iximiuz.com/flask-gevent-tutorial/deploy-uwsgi-gevent-during-1200-opt.png" alt=""></p><p><em>docker exec -it flask-gevent-tutorial_flask_app_1 top -H (during test)</em></p><h2 id="use-nginx-reverse-proxy-in-front-of-application-server"><a class="anchor" href="#use-nginx-reverse-proxy-in-front-of-application-server">#</a> Use Nginx reverse proxy in front of application server</h2><p>Usually, uWSGI and Gunicorn servers reside behind a load balancer and one of the most popular choices is Nginx.</p><h3 id="nginx-gunicorn-gevent"><a class="anchor" href="#nginx-gunicorn-gevent">#</a> Nginx + Gunicorn + gevent</h3><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9uZ2lueC1ndW5pY29ybi5jb25m">Nginx configuration</span> for Gunicorn upstream is just a standard proxy setup:</p><figure class="highlight nginx"><figcaption data-lang="nginx"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/nginx-gunicorn.conf</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token directive"><span class="token keyword">proxy_set_header</span> Host <span class="token variable">$http_host</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Real-IP <span class="token variable">$remote_addr</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-For <span class="token variable">$proxy_add_x_forwarded_for</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>        <span class="token directive"><span class="token keyword">proxy_set_header</span> X-Forwarded-Proto <span class="token variable">$scheme</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>        <span class="token directive"><span class="token keyword">proxy_pass</span> http://flask_app:3000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>We can try it out using <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL25naW54LWd1bmljb3JuLnltbA==">the following playground</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./nginx-gunicorn.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">ingress</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.6</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:8080:80"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> ./flask_app/nginx<span class="token punctuation">-</span>gunicorn.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> flask_app</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gevent<span class="token punctuation">-</span>gunicorn</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=1</pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"3000"</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="26"></td><td><pre></pre></td></tr><tr><td data-num="27"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="31"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>And then:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ docker-compose -f nginx-gunicorn.yml build</pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f nginx-gunicorn.yml up</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:8080/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> <span class="token punctuation">..</span>.</pre></td></tr></table></figure><h3 id="nginx-uwsgi-gevent"><a class="anchor" href="#nginx-uwsgi-gevent">#</a> Nginx + uWSGI + gevent</h3><p>uWSGI setup is very similar, but there is a subtle improvement. uWSGI provides a special binary protocol (called uWSGI) to communicate with the reverse proxy in front of it. This makes the joint slightly more efficient. And Nginx kindly <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2ZsYXNrX2FwcC9uZ2lueC11d3NnaS5jb25m">supports it</span>:</p><figure class="highlight nginx"><figcaption data-lang="nginx"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./flask_app/nginx-uwsgi.conf</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token directive"><span class="token keyword">server</span></span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token directive"><span class="token keyword">listen</span> <span class="token number">80</span></span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token directive"><span class="token keyword">location</span> /</span> <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>        <span class="token directive"><span class="token keyword">include</span> uwsgi_params</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>        <span class="token directive"><span class="token keyword">uwsgi_pass</span> uwsgi://flask_app:3000</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>Notice the environment variable <code>PROTOCOL=uwsgi</code> in <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL25naW54LXV3c2dpLnltbA==">the following playground</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./nginx-uwsgi.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">ingress</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> nginx<span class="token punctuation">:</span>1.17.6</pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:8080:80"</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">volumes</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token punctuation">-</span> ./flask_app/nginx<span class="token punctuation">-</span>uwsgi.conf<span class="token punctuation">:</span>/etc/nginx/conf.d/default.conf</pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> flask_app</pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./flask_app</pre></td></tr><tr><td data-num="17"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile<span class="token punctuation">-</span>gevent<span class="token punctuation">-</span>uwsgi</pre></td></tr><tr><td data-num="18"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=1</pre></td></tr><tr><td data-num="22"></td><td><pre>      <span class="token punctuation">-</span> ASYNC_CORES=2000</pre></td></tr><tr><td data-num="23"></td><td><pre>      <span class="token punctuation">-</span> PROTOCOL=uwsgi</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"3000"</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr></table></figure><p>We can test the playground using:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ docker-compose -f nginx-uwsgi.yml build</pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f nginx-uwsgi.yml up</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>$ ab -r -n <span class="token number">2000</span> -c <span class="token number">200</span> http://127.0.0.1:8080/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> <span class="token punctuation">..</span>.</pre></td></tr></table></figure><h2 id="bonus-make-psycopg2-gevent-friendly-with-psycogreen"><a class="anchor" href="#bonus-make-psycopg2-gevent-friendly-with-psycogreen">#</a> Bonus: make psycopg2 gevent-friendly with psycogreen</h2><p>When asked, gevent patches only modules from the Python standard library. If we use 3rd party modules, like psycopg2, corresponding IO will remain blocking. Let's consider the following application:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./psycopg2/app.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">from</span> gevent <span class="token keyword">import</span> monkey</pre></td></tr><tr><td data-num="4"></td><td><pre>monkey<span class="token punctuation">.</span>patch_all<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token keyword">import</span> os</pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">import</span> psycopg2</pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token keyword">import</span> requests</pre></td></tr><tr><td data-num="10"></td><td><pre><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request</pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>api_port <span class="token operator">=</span> os<span class="token punctuation">.</span>environ<span class="token punctuation">[</span><span class="token string">'PORT_API'</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="13"></td><td><pre>api_url <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'http://slow_api:</span><span class="token interpolation"><span class="token punctuation">&#123;</span>api_port<span class="token punctuation">&#125;</span></span><span class="token string">/'</span></span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    conn <span class="token operator">=</span> psycopg2<span class="token punctuation">.</span>connect<span class="token punctuation">(</span>user<span class="token operator">=</span><span class="token string">"example"</span><span class="token punctuation">,</span> password<span class="token operator">=</span><span class="token string">"example"</span><span class="token punctuation">,</span> host<span class="token operator">=</span><span class="token string">"postgres"</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    delay <span class="token operator">=</span> <span class="token builtin">float</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span>args<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'delay'</span><span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    resp <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'</span><span class="token interpolation"><span class="token punctuation">&#123;</span>api_url<span class="token punctuation">&#125;</span></span><span class="token string">?delay=</span><span class="token interpolation"><span class="token punctuation">&#123;</span>delay<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">&#125;</span></span><span class="token string">'</span></span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre></pre></td></tr><tr><td data-num="23"></td><td><pre>    cur <span class="token operator">=</span> conn<span class="token punctuation">.</span>cursor<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    cur<span class="token punctuation">.</span>execute<span class="token punctuation">(</span><span class="token string">"SELECT NOW(), pg_sleep(%s)"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>delay<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="25"></td><td><pre></pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token string">'Hi there! &#123;&#125; &#123;&#125;'</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span>resp<span class="token punctuation">.</span>text<span class="token punctuation">,</span> cur<span class="token punctuation">.</span>fetchall<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr></table></figure><p>We extended the workload by adding intentionally slow database access. Let's prepare <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3BzeWNvcGcyL0RvY2tlcmZpbGU=">the Dockerfile</span>:</p><figure class="highlight dockerfile"><figcaption data-lang="Docker"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./psycopg2/Dockerfile</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token instruction"><span class="token keyword">FROM</span> python:3.8</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token instruction"><span class="token keyword">RUN</span> pip install Flask requests psycopg2 psycogreen uwsgi gevent</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> app.py /app.py</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token instruction"><span class="token keyword">COPY</span> patched.py /patched.py</span></pre></td></tr><tr><td data-num="8"></td><td><pre></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token instruction"><span class="token keyword">CMD</span> uwsgi --master <span class="token operator">\</span></span></pre></td></tr><tr><td data-num="10"></td><td><pre>  --single-interpreter <span class="token operator">\</span></pre></td></tr><tr><td data-num="11"></td><td><pre>  --workers <span class="token variable">$WORKERS</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="12"></td><td><pre>  --gevent <span class="token variable">$ASYNC_CORES</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="13"></td><td><pre>  --protocol http <span class="token operator">\</span></pre></td></tr><tr><td data-num="14"></td><td><pre>  --socket 0.0.0.0:<span class="token variable">$PORT_APP</span> <span class="token operator">\</span></pre></td></tr><tr><td data-num="15"></td><td><pre>  --module <span class="token variable">$MODULE</span>:app</pre></td></tr></table></figure><p>And <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL2JvbnVzLXBzeWNvcGcyLWdldmVudC55bWw=">the playground</span>:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./bonus-psycopg2-gevent.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">"3.7"</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token key atrule">flask_app</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./psycopg2</pre></td></tr><tr><td data-num="8"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile</pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3000</pre></td></tr><tr><td data-num="11"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=1</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> ASYNC_CORES=2000</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> MODULE=app</pre></td></tr><tr><td data-num="15"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3000:3000"</span></pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="19"></td><td><pre>      <span class="token punctuation">-</span> postgres</pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>  <span class="token key atrule">slow_api</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span> ./slow_api</pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="25"></td><td><pre>      <span class="token punctuation">-</span> PORT=4000</pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="27"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"4000"</span></pre></td></tr><tr><td data-num="28"></td><td><pre></pre></td></tr><tr><td data-num="29"></td><td><pre>  <span class="token key atrule">postgres</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres</pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="32"></td><td><pre>      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> example</pre></td></tr><tr><td data-num="33"></td><td><pre>      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> example</pre></td></tr><tr><td data-num="34"></td><td><pre>    <span class="token key atrule">expose</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="35"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"5432"</span></pre></td></tr></table></figure><p>Ideally, we expect ~2 seconds to perform 10 one-second-long HTTP requests with concurrency 5. But the test shows more than 6 seconds due to the blocking behavior of psycopg2 calls:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ docker-compose -f bonus-psycopg2-gevent.yml build</pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f bonus-psycopg2-gevent.yml up</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>$ ab -r -n <span class="token number">10</span> -c <span class="token number">5</span> http://127.0.0.1:3000/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">5</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">6.670</span> seconds</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">10</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">1.50</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><p>To bypass this limitation, we need to use <span class="exturl" data-url="aHR0cHM6Ly9iaXRidWNrZXQub3JnL2R2YXJyYXp6by9wc3ljb2dyZWVuLw==">psycogreen</span> module to patch psycopg2:</p><blockquote><p>The psycogreen package enables psycopg2 to work with coroutine libraries, using asynchronous calls internally but offering a blocking interface so that regular code can run unmodified. Psycopg offers coroutines support since release 2.2. Because the main module is a C extension it cannot be monkey-patched to become coroutine-friendly. Instead it exposes a hook that coroutine libraries can use to install a function integrating with their event scheduler. Psycopg will call the function whenever it executes a libpq call that may block. psycogreen is a collection of &quot;wait callbacks&quot; useful to integrate Psycopg with different coroutine libraries.</p></blockquote><p>Let's create <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2l4aW1pdXovZmxhc2stZ2V2ZW50LXR1dG9yaWFsL2Jsb2IvbWFzdGVyL3BzeWNvcGcyL3BhdGNoZWQucHk=">an entrypoint</span>:</p><figure class="highlight python"><figcaption data-lang="python"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./psycopg2/patched.py</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token keyword">from</span> psycogreen<span class="token punctuation">.</span>gevent <span class="token keyword">import</span> patch_psycopg</pre></td></tr><tr><td data-num="3"></td><td><pre>patch_psycopg<span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="4"></td><td><pre></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token keyword">from</span> app <span class="token keyword">import</span> app  <span class="token comment"># re-export</span></pre></td></tr></table></figure><p>And extend the playground:</p><figure class="highlight yaml"><figcaption data-lang="YAML"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment"># ./bonus-psycopg2-gevent.yml</span></pre></td></tr><tr><td data-num="2"></td><td><pre></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token key atrule">services</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="4"></td><td><pre>  <span class="token comment"># ...</span></pre></td></tr><tr><td data-num="5"></td><td><pre></pre></td></tr><tr><td data-num="6"></td><td><pre>  <span class="token key atrule">flask_app_2</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    <span class="token key atrule">init</span><span class="token punctuation">:</span> <span class="token boolean important">true</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token key atrule">build</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="9"></td><td><pre>      <span class="token key atrule">context</span><span class="token punctuation">:</span> ./psycopg2</pre></td></tr><tr><td data-num="10"></td><td><pre>      <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> Dockerfile</pre></td></tr><tr><td data-num="11"></td><td><pre>    <span class="token key atrule">environment</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="12"></td><td><pre>      <span class="token punctuation">-</span> PORT_APP=3001</pre></td></tr><tr><td data-num="13"></td><td><pre>      <span class="token punctuation">-</span> PORT_API=4000</pre></td></tr><tr><td data-num="14"></td><td><pre>      <span class="token punctuation">-</span> WORKERS=1</pre></td></tr><tr><td data-num="15"></td><td><pre>      <span class="token punctuation">-</span> ASYNC_CORES=2000</pre></td></tr><tr><td data-num="16"></td><td><pre>      <span class="token punctuation">-</span> MODULE=patched</pre></td></tr><tr><td data-num="17"></td><td><pre>    <span class="token key atrule">ports</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="18"></td><td><pre>      <span class="token punctuation">-</span> <span class="token string">"127.0.0.1:3001:3001"</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span></pre></td></tr><tr><td data-num="20"></td><td><pre>      <span class="token punctuation">-</span> slow_api</pre></td></tr><tr><td data-num="21"></td><td><pre>      <span class="token punctuation">-</span> postgres</pre></td></tr></table></figure><p>If we test the new instance of the application with <code>ab -n 10 -c 5</code> , the observed performance will be much close to the theoretical one:</p><figure class="highlight bash"><figcaption data-lang="bash"></figcaption><table><tr><td data-num="1"></td><td><pre>$ docker-compose -f bonus-psycopg2-gevent.yml build</pre></td></tr><tr><td data-num="2"></td><td><pre>$ docker-compose -f bonus-psycopg2-gevent.yml up</pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>$ ab -r -n <span class="token number">10</span> -c <span class="token number">5</span> http://127.0.0.1:3001/?delay<span class="token operator">=</span><span class="token number">1</span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token operator">></span> Concurrency Level:      <span class="token number">5</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token operator">></span> Time taken <span class="token keyword">for</span> tests:   <span class="token number">3.148</span> seconds</pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token operator">></span> Complete requests:      <span class="token number">10</span></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token operator">></span> Failed requests:        <span class="token number">0</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token operator">></span> Requests per second:    <span class="token number">3.18</span> <span class="token punctuation">[</span><span class="token comment">#/sec] (mean)</span></pre></td></tr></table></figure><h2 id="instead-of-conclusion"><a class="anchor" href="#instead-of-conclusion">#</a> Instead of conclusion</h2><p>Make code, not war!</p><h2 id="related-articles"><a class="anchor" href="#related-articles">#</a> Related articles</h2><div class="tags"><a href="/tags/Python/" rel="tag"><i class="ic i-tag"></i> Python</a> <a href="/tags/Flask/" rel="tag"><i class="ic i-tag"></i> Flask</a></div></div><footer><div class="meta"><span id="2021/11/How to use Flask with gevent (uWSGI and Gunicorn editions)/" class="item leancloud_visitors" data-flag-title="How to use Flask with gevent (uWSGI and Gunicorn editions)" title="阅读次数"><span class="icon"><i class="ic i-eye"></i> </span><span class="text">阅读次数</span> <span class="leancloud-visitors-count"></span> <span class="text">次</span></span></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>黑麋鹿 <i class="ic i-at"><em>@</em></i></li><li class="link"><strong>本文链接：</strong> <a href="https://sirliu.github.io/2021/11/How%20to%20use%20Flask%20with%20gevent%20(uWSGI%20and%20Gunicorn%20editions)/" title="How to use Flask with gevent (uWSGI and Gunicorn editions)">https://sirliu.github.io/2021/11/How to use Flask with gevent (uWSGI and Gunicorn editions)/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" rel="noopener" target="_blank"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</a> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2021/11/WEB%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%5BLeanCloud%5D/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;api.ixiaowai.cn&#x2F;gqapi&#x2F;gqapi.php?id&#x3D;245808" title="利用LeanCloud搭建WEB服务"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> LeanCloud</span><h3>利用LeanCloud搭建WEB服务</h3></a></div><div class="item right"><a href="/2021/11/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0Python%E4%BE%9D%E8%B5%96%E5%8C%85%E5%AE%89%E8%A3%85%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;api.ixiaowai.cn&#x2F;gqapi&#x2F;gqapi.php?id&#x3D;258572" title="腾讯云函数Python依赖包安装打包过程"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> Python</span><h3>腾讯云函数Python依赖包安装打包过程</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#when-do-i-need-asynchronous-io"><span class="toc-number">1.</span> <span class="toc-text">When do I need asynchronous I&#x2F;O</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#what-is-gevent"><span class="toc-number">2.</span> <span class="toc-text">What is gevent</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#create-simple-flask-application"><span class="toc-number">3.</span> <span class="toc-text">Create simple Flask application</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-flask-application-using-flask-dev-server"><span class="toc-number">4.</span> <span class="toc-text">Deploy Flask application using Flask dev server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-flask-application-using-geventpywsgi"><span class="toc-number">5.</span> <span class="toc-text">Deploy Flask application using gevent.pywsgi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-flask-application-using-gunicorn"><span class="toc-number">6.</span> <span class="toc-text">Deploy Flask application using Gunicorn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#deploy-flask-application-using-uwsgi"><span class="toc-number">7.</span> <span class="toc-text">Deploy Flask application using uWSGI</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#use-nginx-reverse-proxy-in-front-of-application-server"><span class="toc-number">8.</span> <span class="toc-text">Use Nginx reverse proxy in front of application server</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-gunicorn-gevent"><span class="toc-number">8.1.</span> <span class="toc-text">Nginx + Gunicorn + gevent</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx-uwsgi-gevent"><span class="toc-number">8.2.</span> <span class="toc-text">Nginx + uWSGI + gevent</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bonus-make-psycopg2-gevent-friendly-with-psycogreen"><span class="toc-number">9.</span> <span class="toc-text">Bonus: make psycopg2 gevent-friendly with psycogreen</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#instead-of-conclusion"><span class="toc-number">10.</span> <span class="toc-text">Instead of conclusion</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#related-articles"><span class="toc-number">11.</span> <span class="toc-text">Related articles</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/8/requests%E3%80%81aiohttp%E3%80%81httpx%E5%AF%B9%E6%AF%94/" rel="bookmark" title="requests、aiohttp、httpx对比">requests、aiohttp、httpx对比</a></li><li><a href="/2021/8/%E5%BC%82%E6%AD%A5%E5%B9%B6%E5%8F%91aiohttp/" rel="bookmark" title="异步并发aiohttp">异步并发aiohttp</a></li><li><a href="/2021/9/pipreqs%E4%BD%BF%E7%94%A8%E8%B8%A9%E5%9D%91/" rel="bookmark" title="pipreqs使用踩坑">pipreqs使用踩坑</a></li><li><a href="/2021/9/Python%E4%B8%ADAES%E5%8A%A0%E8%A7%A3%E5%AF%86/" rel="bookmark" title="Python中AES加解密">Python中AES加解密</a></li><li><a href="/2021/9/Python%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87/" rel="bookmark" title="Python上传图片">Python上传图片</a></li><li><a href="/2021/10/%E4%BD%BF%E7%94%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0%E6%90%AD%E5%BB%BA%E7%AE%80%E5%8D%95API%E5%90%8E%E7%AB%AF/" rel="bookmark" title="使用腾讯云函数搭建简单API后端">使用腾讯云函数搭建简单API后端</a></li><li><a href="/2021/10/pymongo%E6%93%8D%E4%BD%9C/" rel="bookmark" title="pymongo操作">pymongo操作</a></li><li><a href="/2021/11/Python%E7%88%AC%E5%8F%96TG%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" rel="bookmark" title="Python爬取TG频道图片">Python爬取TG频道图片</a></li><li class="active"><a href="/2021/11/How%20to%20use%20Flask%20with%20gevent%20(uWSGI%20and%20Gunicorn%20editions)/" rel="bookmark" title="How to use Flask with gevent (uWSGI and Gunicorn editions)">How to use Flask with gevent (uWSGI and Gunicorn editions)</a></li><li><a href="/2021/11/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0Python%E4%BE%9D%E8%B5%96%E5%8C%85%E5%AE%89%E8%A3%85%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" rel="bookmark" title="腾讯云函数Python依赖包安装打包过程">腾讯云函数Python依赖包安装打包过程</a></li><li><a href="/2021/11/python3%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8Basync/await%E5%8E%9F%E7%90%86%E8%A7%A3%E9%87%8A%E7%9A%84%E6%AF%94%E8%BE%83%E8%AF%A6%E7%BB%86%E7%9A%84%E6%96%87%E7%AB%A0/" rel="bookmark" title="python3异步编程async/await原理解释的比较详细的文章">python3异步编程async/await原理解释的比较详细的文章</a></li><li><a href="/2021/11/%E8%BD%BB%E6%9D%BE%E7%90%86%E8%A7%A3%20Python%E4%B8%AD%20%E7%9A%84%20async-await%20%E6%A6%82%E5%BF%B5/" rel="bookmark" title="轻松理解 Python中 的 async-await 概念">轻松理解 Python中 的 async-await 概念</a></li><li><a href="/2021/11/aiohttp%E4%BD%BF%E7%94%A8%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E8%BE%B9%E8%AF%B7%E6%B1%82%E8%BE%B9%E5%A4%84%E7%90%86/" rel="bookmark" title="aiohttp使用回调函数边请求边处理">aiohttp使用回调函数边请求边处理</a></li><li><a href="/2021/12/pip%E7%A6%BB%E7%BA%BF%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96%E5%BA%93/" rel="bookmark" title="pip离线安装依赖库">pip离线安装依赖库</a></li><li><a href="/2021/12/Python%E8%AE%A1%E7%AE%97%E5%A4%A7%E6%96%87%E4%BB%B6%E8%A1%8C%E6%95%B0%E6%96%B9%E6%B3%95%E5%8F%8A%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83/" rel="bookmark" title="Python计算大文件行数方法及性能比较">Python计算大文件行数方法及性能比较</a></li><li><a href="/2021/12/Python%E5%AE%9E%E7%8E%B0%E5%AF%B9%E5%A4%A7%E6%96%87%E4%BB%B6%E7%9A%84%E5%A2%9E%E9%87%8F%E8%AF%BB%E5%8F%96/" rel="bookmark" title="Python实现对大文件的增量读取">Python实现对大文件的增量读取</a></li><li><a href="/2022/5/Pandas%E6%9D%A1%E4%BB%B6%E5%AE%9A%E4%BD%8D%E5%8D%95%E5%85%83%E6%A0%BC%E3%80%90%E7%B1%BB%E4%BC%BCSQL%E6%9F%A5%E8%AF%A2%E3%80%91/" rel="bookmark" title="Pandas条件定位单元格【类似select 字段 from 表 where 其他字段=某值】">Pandas条件定位单元格【类似select 字段 from 表 where 其他字段=某值】</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="黑麋鹿" data-src="/images/avatar.jpg"><p class="name" itemprop="name">黑麋鹿</p><div class="description" itemprop="description">折腾之路</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">180</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">42</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">92</span> <span class="name">标签</span></a></div></nav><div class="social"><a href="https://github.com/sirliu" title="https:&#x2F;&#x2F;github.com&#x2F;sirliu" class="item github" rel="noopener" target="_blank"><i class="ic i-github"></i></a> <a href="https://twitter.com/" title="https:&#x2F;&#x2F;twitter.com&#x2F;" class="item twitter" rel="noopener" target="_blank"><i class="ic i-twitter"></i></a> <a href="https://www.zhihu.com/" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;" class="item zhihu" rel="noopener" target="_blank"><i class="ic i-zhihu"></i></a> <a href="https://music.163.com/" title="https:&#x2F;&#x2F;music.163.com&#x2F;" class="item music" rel="noopener" target="_blank"><i class="ic i-cloud-music"></i></a> <a href="https://weibo.com/" title="https:&#x2F;&#x2F;weibo.com&#x2F;" class="item weibo" rel="noopener" target="_blank"><i class="ic i-weibo"></i></a> <a href="mailto:yourname@mail.com" title="mailto:yourname@mail.com" class="item email" rel="noopener" target="_blank"><i class="ic i-envelope"></i></a> <a href="https://www.facebook.com/" title="https:&#x2F;&#x2F;www.facebook.com&#x2F;" class="item facebook" rel="noopener" target="_blank"><i class="ic i-facebook"></i></a> <a href="https://stackoverflow.com/" title="https:&#x2F;&#x2F;stackoverflow.com&#x2F;" class="item stackoverflow" rel="noopener" target="_blank"><i class="ic i-stack-overflow"></i></a> <a href="https://www.youtube.com/" title="https:&#x2F;&#x2F;www.youtube.com&#x2F;" class="item youtube" rel="noopener" target="_blank"><i class="ic i-youtube"></i></a> <a href="https://instagram.com/" title="https:&#x2F;&#x2F;instagram.com&#x2F;" class="item instagram" rel="noopener" target="_blank"><i class="ic i-instagram"></i></a> <a href="skype:yourname?call|chat" title="skype:yourname?call|chat" class="item skype" rel="noopener" target="_blank"><i class="ic i-skype"></i></a> <a href="https://www.douban.com/" title="https:&#x2F;&#x2F;www.douban.com&#x2F;" class="item douban" rel="noopener" target="_blank"><i class="ic i-douban"></i></a></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2021/11/WEB%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA%5BLeanCloud%5D/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2021/11/%E8%85%BE%E8%AE%AF%E4%BA%91%E5%87%BD%E6%95%B0Python%E4%BE%9D%E8%B5%96%E5%8C%85%E5%AE%89%E8%A3%85%E6%89%93%E5%8C%85%E8%BF%87%E7%A8%8B/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2022</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">黑麋鹿 @ Black Elk</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">734k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">11:08</span></div><div class="powered-by">基于 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & Theme.<a href="https://github.com/amehime/hexo-theme-shoka" rel="noopener" target="_blank">Shoka</a></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2021/11/How to use Flask with gevent (uWSGI and Gunicorn editions)/",favicon:{show:"BlackELK",hide:"看看再走吧"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html><!-- rebuild by hrmmi -->