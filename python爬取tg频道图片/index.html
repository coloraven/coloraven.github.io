<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Python爬取TG频道图片 - 我的全新 Hugo 网站</title><meta name="Description" content="这是我的全新 Hugo 网站"><meta property="og:title" content="Python爬取TG频道图片" />
<meta property="og:description" content="转载自：https://binbla.com/?p=339
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 import asyncio import logging import socks import telethon." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-05T22:20:35+00:00" />
<meta property="article:modified_time" content="2021-11-05T22:20:35+00:00" /><meta property="og:site_name" content="我的网站" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Python爬取TG频道图片"/>
<meta name="twitter:description" content="转载自：https://binbla.com/?p=339
1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 import asyncio import logging import socks import telethon."/>
<meta name="application-name" content="我的网站">
<meta name="apple-mobile-web-app-title" content="我的网站"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" /><link rel="prev" href="http://example.org/python%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/" /><link rel="next" href="http://example.org/jd%E7%AD%BE%E5%88%B0%E9%83%A8%E7%BD%B2%E8%87%AA%E5%8A%A8ck%E6%9C%8D%E5%8A%A1/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Python爬取TG频道图片",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/example.org\/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87\/"
        },"genre": "posts","keywords": "Python, Telegram","wordcount":  552 ,
        "url": "http:\/\/example.org\/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87\/","datePublished": "2021-11-05T22:20:35+00:00","dateModified": "2021-11-05T22:20:35+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "五彩斑斓的黑"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="我的全新 Hugo 网站"></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="我的全新 Hugo 网站"></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Python爬取TG频道图片</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel="author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>五彩斑斓的黑</a></span>&nbsp;<span class="post-category">included in <a href="/categories/python/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Python</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2021-11-05">2021-11-05</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;552 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents"></nav></div>
            </div><div class="content" id="content"><p>转载自：https://binbla.com/?p=339</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">asyncio</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">logging</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">socks</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">telethon.tl.types</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">aiofile</span> <span class="kn">import</span> <span class="n">AIOFile</span><span class="p">,</span> <span class="n">Writer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">telethon</span> <span class="kn">import</span> <span class="n">TelegramClient</span><span class="p">,</span> <span class="n">events</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">telethon.tl.types</span> <span class="kn">import</span> <span class="n">PeerChannel</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">-&gt; 这是一个Telegram机器人项目
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">-&gt; 实现的功能：爬取Telegram中频道的图片
</span></span></span><span class="line"><span class="cl"><span class="s2">-&gt; 注意：由于机器人无法加入其他人的频道，所以扒频道的图只能交给主体账户来进行（不会影响主账户的登录）
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 网友反馈：申请需要填个人网站，应该是随便填一个能正常访问的网址就行</span>
</span></span><span class="line"><span class="cl"><span class="c1"># your telegram api id</span>
</span></span><span class="line"><span class="cl"><span class="n">api_id</span> <span class="o">=</span> <span class="n">xxxxxxx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># your telegram api hash</span>
</span></span><span class="line"><span class="cl"><span class="n">api_hash</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># get form https://my.telegram.org/apps</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># your chat id</span>
</span></span><span class="line"><span class="cl"><span class="n">admin_id</span> <span class="o">=</span> <span class="n">xxxxxxxx</span>
</span></span><span class="line"><span class="cl"><span class="c1"># get from https://telegram.me/getidsbot</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 暂时不用填</span>
</span></span><span class="line"><span class="cl"><span class="c1"># your bot_token</span>
</span></span><span class="line"><span class="cl"><span class="n">bot_token</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxxxxxxxxxxxxxxxxx&#39;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># get from https://telegram.me/botfather</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># file save path</span>
</span></span><span class="line"><span class="cl"><span class="n">save_path</span> <span class="o">=</span> <span class="s1">&#39;/home/admin/Telegram/&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># proxy</span>
</span></span><span class="line"><span class="cl"><span class="n">proxy_type</span> <span class="o">=</span> <span class="n">socks</span><span class="o">.</span><span class="n">SOCKS5</span>
</span></span><span class="line"><span class="cl"><span class="n">proxy_addr</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
</span></span><span class="line"><span class="cl"><span class="n">proxy_port</span> <span class="o">=</span> <span class="mi">20170</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 要监视下载的频道,名字（键名）无实际代码作用，不要重复就行</span>
</span></span><span class="line"><span class="cl"><span class="n">channel</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;少女情怀总是诗&#34;</span><span class="p">:</span> <span class="mi">1336617732</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;咸鱼的杂货铺 ASWL&#34;</span><span class="p">:</span> <span class="mi">1445018107</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;白丝即正义&#34;</span><span class="p">:</span> <span class="mi">1088679595</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;For world|精选|收集器&#34;</span><span class="p">:</span> <span class="mi">1109579085</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;奇闻异录 与 沙雕时刻&#34;</span><span class="p">:</span> <span class="mi">1214996122</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 接受监视的媒体格式(tg里面直接发送gif最后是mp4格式！)</span>
</span></span><span class="line"><span class="cl"><span class="n">accept_file_format</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;image/jpeg&#34;</span><span class="p">,</span> <span class="s2">&#34;image/gif&#34;</span><span class="p">,</span> <span class="s2">&#34;image/png&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Mirai机器人插件的地址和端口</span>
</span></span><span class="line"><span class="cl"><span class="n">target_addr</span> <span class="o">=</span> <span class="s2">&#34;localhost&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">target_port</span> <span class="o">=</span> <span class="mi">13131</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># bot登陆：留作将来开发控制程序</span>
</span></span><span class="line"><span class="cl"><span class="c1"># bot = TelegramClient(&#39;transferBot&#39;, api_id, api_hash, proxy=(proxy_type, proxy_addr, proxy_port)).start(</span>
</span></span><span class="line"><span class="cl"><span class="c1">#     bot_token=bot_token).start()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 用户登陆</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">TelegramClient</span><span class="p">(</span><span class="s1">&#39;transfer&#39;</span><span class="p">,</span> <span class="n">api_id</span><span class="p">,</span> <span class="n">api_hash</span><span class="p">,</span> <span class="n">proxy</span><span class="o">=</span><span class="p">(</span><span class="n">proxy_type</span><span class="p">,</span> <span class="n">proxy_addr</span><span class="p">,</span> <span class="n">proxy_port</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># client = TelegramClient(&#39;transfer&#39;, api_id, api_hash).start()</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 列表推导式 获取频道对象列表</span>
</span></span><span class="line"><span class="cl"><span class="n">channel_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">PeerChannel</span><span class="p">(</span><span class="n">channel</span><span class="p">[</span><span class="n">channel_name</span><span class="p">])</span> <span class="k">for</span> <span class="n">channel_name</span> <span class="ow">in</span> <span class="n">channel</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 过滤出监视下载的频道，如果有媒体消息就下载</span>
</span></span><span class="line"><span class="cl"><span class="nd">@client.on</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">NewMessage</span><span class="p">(</span><span class="n">from_users</span><span class="o">=</span><span class="n">channel_list</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取对话</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># chat = await event.get_chat()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 获取message内容</span>
</span></span><span class="line"><span class="cl">    <span class="n">message</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 判断是否有媒体</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;发现媒体&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">download_image</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 下载媒体的具体方法</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">download_image</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果是网页</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_webpage</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span><span class="n">telethon</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">MessageMediaWebPage</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果媒体是照片则直接下载</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_photo</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="n">telethon</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">MessageMediaPhoto</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 如果媒体是文件则检查是否是可接受的文件格式，这里用的否定表达，不好读！建议跳过或者自己写一个</span>
</span></span><span class="line"><span class="cl">    <span class="n">is_doc</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="p">,</span> <span class="n">telethon</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">MessageMediaDocument</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">is_photo</span> <span class="ow">or</span> <span class="n">is_webpage</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">is_doc</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">is_accept_media</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">media</span><span class="o">.</span><span class="n">document</span><span class="o">.</span><span class="n">mime_type</span> <span class="ow">in</span> <span class="n">accept_file_format</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_accept_media</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;不可接受&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 这里由于download_media()可以自动命名</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 所以，判断重复有点难搞，不过频道应该不怎么发重复内容</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 那就这样吧!不写了</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># if os.path.exists(filename):</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     print(&#34;文件已存在&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     return</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 这个方法下载成功后会返回文件的保存名</span>
</span></span><span class="line"><span class="cl">    <span class="n">filename</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">download_media</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">save_path</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;下载失败&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;下载完成&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 下面注释的代码不知道什么原因无法在文件不存在的情况下新建文件</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># async with async_open(save_path + &#34;1.txt&#34;, &#34;a&#34;) as f:</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#     await f.write(filename + &#34;\n&#34;)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">message</span><span class="o">.</span><span class="n">raw_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># 通知mirai机器人干活，没有mirai机器人就注释下下面一行代码</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">send_to_mirai</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">id</span><span class="p">,</span><span class="n">message</span><span class="o">.</span><span class="n">sender</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> <span class="n">message</span><span class="o">.</span><span class="n">raw_text</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">#socket通信通知QQ机器人（机器人插件见另一篇）</span>
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">send_to_mirai</span><span class="p">(</span><span class="n">from_id</span><span class="p">,</span> <span class="n">from_title</span><span class="p">,</span> <span class="n">raw_text</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_id</span><span class="p">)</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="o">+</span><span class="n">from_title</span><span class="o">+</span><span class="s2">&#34;</span><span class="se">\t</span><span class="s2">&#34;</span><span class="o">+</span><span class="n">raw_text</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">reader</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">open_connection</span><span class="p">(</span><span class="n">target_addr</span><span class="p">,</span> <span class="n">target_port</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&#34;utf-8&#34;</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="n">writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;已通知mirai干活&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----*****-----&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;socket通信失败！&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">write_to_list</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">write_to_list</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">async</span> <span class="k">with</span> <span class="n">AIOFile</span><span class="p">(</span><span class="n">save_path</span> <span class="o">+</span> <span class="s2">&#34;unprocessed_list.txt&#34;</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">list_file</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">write</span> <span class="o">=</span> <span class="n">Writer</span><span class="p">(</span><span class="n">list_file</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">await</span> <span class="n">write</span><span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;写入列表&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----*****-----&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">bot_main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="k">pass</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 展示登陆的信息</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">show_my_inf</span><span class="p">(</span><span class="n">me</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----****************-----&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Name:&#34;</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;ID:&#34;</span><span class="p">,</span> <span class="n">me</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-----login successful-----&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">async</span> <span class="k">def</span> <span class="nf">client_main</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;-client-main-&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">me</span> <span class="o">=</span> <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">get_me</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">show_my_inf</span><span class="p">(</span><span class="n">me</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># 这个方法是一直连着直到断开，我没有写断开的代码，所以程序应该会一直运行</span>
</span></span><span class="line"><span class="cl">    <span class="k">await</span> <span class="n">client</span><span class="o">.</span><span class="n">run_until_disconnected</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 日志，这个是文档里建议使用的，但是我没有实际使用上</span>
</span></span><span class="line"><span class="cl"><span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;[</span><span class="si">%(debug) 5s</span><span class="s1">/</span><span class="si">%(asctime)s</span><span class="s1">] </span><span class="si">%(name)s</span><span class="s1">: </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 主函数入口</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">client</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 开启异步任务</span>
</span></span><span class="line"><span class="cl">        <span class="n">client</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">client_main</span><span class="p">())</span>
</span></span></code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-11-05</span>
            </div><div class="post-info-license">
                <span>false</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/index.md" target="_blank">Read Markdown</a>
                        </span></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" data-title="Python爬取TG频道图片" data-hashtags="Python,Telegram"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" data-hashtag="Python"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" data-title="Python爬取TG频道图片"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" data-title="Python爬取TG频道图片"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://example.org/python%E7%88%AC%E5%8F%96tg%E9%A2%91%E9%81%93%E5%9B%BE%E7%89%87/" data-title="Python爬取TG频道图片"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;<a href="/tags/python/">Python</a>,&nbsp;<a href="/tags/telegram/">Telegram</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/python%E4%B8%8A%E4%BC%A0%E6%96%87%E4%BB%B6/" class="prev" rel="prev" title="Python上传文件"><i class="fas fa-angle-left fa-fw" aria-hidden="true"></i>Python上传文件</a>
            <a href="/jd%E7%AD%BE%E5%88%B0%E9%83%A8%E7%BD%B2%E8%87%AA%E5%8A%A8ck%E6%9C%8D%E5%8A%A1/" class="next" rel="next" title="JD签到部署自动CK服务">JD签到部署自动CK服务<i class="fas fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.116.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2019 - 2023</span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":30},"comment":{},"cookieconsent":{"content":{"dismiss":"Got it!","link":"Learn more","message":"This website uses Cookies to improve your experience."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","maxResultLength":10,"noResultsFound":"No results found","snippetLength":50,"type":"lunr"}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
